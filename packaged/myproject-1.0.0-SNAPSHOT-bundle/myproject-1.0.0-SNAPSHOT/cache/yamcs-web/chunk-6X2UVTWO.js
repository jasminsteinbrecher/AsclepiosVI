import{a as C,b as _}from"./chunk-OXOWQRWE.js";function gm(t){let e=document.createElement("canvas").getContext("2d");e.fillStyle=t;let i=String(e.fillStyle),s=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(i);return s?new f(parseInt(s[1],16),parseInt(s[2],16),parseInt(s[3],16)):f.BLACK}var f=class X{constructor(e,i,s,r=255){this.red=e,this.green=i,this.blue=s,this.alpha=r}static TRANSPARENT=new X(0,0,0,0);static BLACK=new X(0,0,0);static BLUE=new X(0,0,255);static CYAN=new X(0,255,255);static DARK_GRAY=new X(150,150,150);static GRAY=new X(200,200,200);static GREEN=new X(0,255,0);static LIGHT_BLUE=new X(153,186,243);static ORANGE=new X(255,128,0);static PINK=new X(255,0,255);static PURPLE=new X(128,0,255);static RED=new X(255,0,0);static WHITE=new X(255,255,255);static YELLOW=new X(255,255,0);static BUTTON=new X(239,240,241);static BUTTON_DARKER=new X(164,168,172);static BUTTON_DARKEST=X.BLACK;static BUTTON_LIGHTEST=X.WHITE;withAlpha(e){return new X(this.red,this.green,this.blue,e)}mixWith(e,i){let s=Math.floor(this.red*i+e.red*(1-i)),r=Math.floor(this.green*i+e.green*(1-i)),o=Math.floor(this.blue*i+e.blue*(1-i));return new X(s,r,o)}brighter(){let{red:e,green:i,blue:s}=this,r=Math.floor(1/(1-.7));return e===0&&i===0&&s===0?new X(r,r,r):(e>0&&e<r&&(e=r),i>0&&i<r&&(i=r),s>0&&s<r&&(s=r),new X(Math.min(Math.floor(this.red/.7),255),Math.min(Math.floor(this.green/.7),255),Math.min(Math.floor(this.blue/.7),255)))}darker(){return new X(Math.max(Math.floor(this.red*.7),0),Math.max(Math.floor(this.green*.7),0),Math.max(Math.floor(this.blue*.7),0))}contrast(){return new X(this.red,255-this.green,255-this.blue)}hex(){let e=this.red.toString(16);e=e.length==1?"0"+e:e;let i=this.green.toString(16);i=i.length==1?"0"+i:i;let s=this.blue.toString(16);s=s.length==1?"0"+s:s;let r=this.alpha.toString(16);return r=r.length==1?"0"+r:r,`#${e}${i}${s}${r}`}getRGBValue(){return this}equals(e){return e&&this.toString()===e.toString()}toString(){return`rgba(${this.red},${this.green},${this.blue},${this.alpha})`}},Ku=class{writeInfo(t){console.log(t)}writeError(t){console.error(t)}writeWarning(t){console.warn(t)}},Zu=class{openConfirmDialog(t,e){return confirm(e)}openInformationDialog(t,e){alert(e)}openWarningDialog(t,e){alert(e)}openErrorDialog(t,e){alert(e)}openPasswordDialog(t,e,i){let s=prompt(e);return s?s===i:!1}},We=t=>(document.removeEventListener("click",We,!0),t.preventDefault(),t.stopPropagation(),!1);function ye(t){return(t.buttons&1)===1||t.buttons===void 0&&t.which==1}var gi=5;function Ju(t,e,i,s){return Math.sqrt((i-t)*(i-t)+(s-e)*(s-e))}function mi(t,e){return t&&e&&t.id===e.id}var Qu=class{constructor(t,e,i){this.display=t,this.canvas=e,this.hitCanvas=i,e.addEventListener("click",s=>this.onCanvasClick(s),!1),e.addEventListener("mousedown",s=>this.onCanvasMouseDown(s),!1),e.addEventListener("mouseup",s=>this.onCanvasMouseUp(s),!1),e.addEventListener("mouseout",s=>this.onCanvasMouseOut(s),!1),e.addEventListener("mousemove",s=>this.onCanvasMouseMove(s),!1)}grabbing=!1;grabTarget;grabPoint;documentMouseMoveListener=t=>this.onDocumentMouseMove(t);documentMouseUpListener=t=>this.onDocumentMouseUp(t);prevEnteredRegion;toPoint(t){let e=this.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}onCanvasClick(t){this.display.clearSelection();let e=this.toPoint(t);if(this.display.editMode)this.selectSingleWidget(e.x,e.y);else{let i=this.hitCanvas.getActiveRegion(e.x,e.y);i&&i.click&&i.click({clientX:t.clientX,clientY:t.clientY,point:e})}}onCanvasMouseDown(t){if(!this.display.editMode&&(document.removeEventListener("click",We,!0),ye(t))){let e=this.toPoint(t),i=this.hitCanvas.getActiveRegion(e.x,e.y);return i&&i.mouseDown&&i.mouseDown({clientX:t.clientX,clientY:t.clientY,point:e}),i&&i.grab&&(this.grabPoint=C({},e),this.grabTarget=i),t.preventDefault(),t.stopPropagation(),!1}}onCanvasMouseUp(t){if(this.display.editMode)return;let e=this.toPoint(t),i=this.hitCanvas.getActiveRegion(e.x,e.y);i&&i.mouseUp&&i.mouseUp()}onCanvasMouseOut(t){this.prevEnteredRegion&&this.prevEnteredRegion.mouseOut&&this.prevEnteredRegion.mouseOut(),this.prevEnteredRegion=void 0,t.preventDefault(),t.stopPropagation()}onCanvasMouseMove(t){let e=this.toPoint(t),i=this.hitCanvas.getActiveRegion(e.x,e.y);this.prevEnteredRegion&&this.prevEnteredRegion.mouseOut&&(mi(this.prevEnteredRegion,i)||this.prevEnteredRegion.mouseOut()),i&&i.mouseEnter&&(mi(this.prevEnteredRegion,i)||i.mouseEnter()),this.prevEnteredRegion=i;let s=i&&i.cursor?i.cursor:"auto";if(s!=this.canvas.style.cursor&&(this.canvas.style.cursor=s),!this.grabbing&&i&&i.tooltip?this.display.setTooltip(i.tooltip()):this.display.setTooltip(void 0),this.grabPoint&&!this.grabbing&&ye(t)){let r=Ju(this.grabPoint.x,this.grabPoint.y,e.x,e.y);Math.abs(r)>gi&&(this.initiateGrab(),gi>0&&this.grabPoint&&(this.grabPoint=e))}this.grabbing&&this.grabTarget&&ye(t)&&this.grabTarget.grab({clientX:t.clientX,clientY:t.clientY,point:e,dx:e.x-this.grabPoint.x,dy:e.y-this.grabPoint.y})}initiateGrab(){document.addEventListener("click",We,!0),document.addEventListener("mouseup",this.documentMouseUpListener),document.addEventListener("mousemove",this.documentMouseMoveListener),this.grabbing=!0}onDocumentMouseUp(t){if(this.grabbing){document.removeEventListener("mouseup",this.documentMouseUpListener),document.removeEventListener("mousemove",this.documentMouseMoveListener);let e=this.grabTarget;this.grabbing=!1,this.grabPoint=void 0,this.grabTarget=void 0,e?.grabEnd&&e.grabEnd()}}onDocumentMouseMove(t){this.onCanvasMouseMove(t)}selectSingleWidget(t,e){let i=this.display.instance;if(i)for(let s of i.widgets.slice().reverse()){let r=s.holderX,o=s.holderY,a=s.holderX+s.holderWidth,h=s.holderY+s.holderHeight;if(r<t&&t<a&&o<e&&e<h)return this.display.selection=[s.wuid],!1}}},tp=class{constructor(t){this.utc=t}formatDate(t,e){let i=this.utc,s="";if(e.year&&(s+=i?t.getUTCFullYear():t.getFullYear()),e.month){e.year&&(s+="-");let r=(i?t.getUTCMonth():t.getMonth())+1;s+=(r<10?"0":"")+r}if(e.day){e.month&&(s+="-");let r=i?t.getUTCDate():t.getDate();s+=(r<10?"0":"")+r}return s}formatTime(t,e){let i=this.utc,s="";if(e.hours){let r=i?t.getUTCHours():t.getHours();s+=(r<10?"0":"")+r}if(e.minutes){e.hours&&(s+=":");let r=i?t.getUTCMinutes():t.getMinutes();s+=(r<10?"0":"")+r}if(e.seconds){e.minutes&&(s+=":");let r=i?t.getUTCSeconds():t.getSeconds();s+=(r<10?"0":"")+r}if(e.milliseconds){e.seconds&&(s+=".");let r=i?t.getUTCMilliseconds():t.getMilliseconds();s+=(r<10?"00":r<100?"0":"")+r}return s}},fi="rgb(255,255,255)",ep=!!navigator.brave,ip=class Pd{constructor(e,i,s){this.parent=e;let r=document.createElement("canvas");r.width=i??r.width,r.height=s??r.height,this.ctx=r.getContext("2d",{willReadFrequently:!0}),this.root=e?.root||e}ctx;regionsByColor=new Map;root;clear(){this.regionsByColor.clear(),this.ctx.fillStyle=fi,this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}beginHitRegion(e){let i=(this.root||this).generateUniqueColor(e);return this.ctx.beginPath(),this.ctx.fillStyle=i,i}getActiveRegion(e,i){let s=this.ctx.getImageData(e,i,1,1).data,r=`rgb(${s[0]},${s[1]},${s[2]})`;return this.regionsByColor.get(r)||void 0}createChild(e,i){return new Pd(this,e,i)}transferToParent(e,i,s,r){if(!this.parent)throw new Error("No parent to transfer to");this.parent.ctx.drawImage(this.ctx.canvas,e,i,s,r)}generateUniqueColor(e){for(;;){let i=Math.round(Math.random()*255),s=Math.round(Math.random()*255),r=Math.round(Math.random()*255),o=`rgb(${i},${s},${r})`;if(!this.regionsByColor.has(o)&&o!==fi)return ep?(this.regionsByColor.set(`rgb(${i-1},${s-1},${r-1})`,e),this.regionsByColor.set(`rgb(${i-1},${s-1},${r})`,e),this.regionsByColor.set(`rgb(${i-1},${s-1},${r+1})`,e),this.regionsByColor.set(`rgb(${i-1},${s},${r-1})`,e),this.regionsByColor.set(`rgb(${i-1},${s},${r})`,e),this.regionsByColor.set(`rgb(${i-1},${s},${r+1})`,e),this.regionsByColor.set(`rgb(${i-1},${s+1},${r-1})`,e),this.regionsByColor.set(`rgb(${i-1},${s+1},${r})`,e),this.regionsByColor.set(`rgb(${i-1},${s+1},${r+1})`,e),this.regionsByColor.set(`rgb(${i},${s-1},${r-1})`,e),this.regionsByColor.set(`rgb(${i},${s-1},${r})`,e),this.regionsByColor.set(`rgb(${i},${s-1},${r+1})`,e),this.regionsByColor.set(`rgb(${i},${s},${r-1})`,e),this.regionsByColor.set(`rgb(${i},${s},${r})`,e),this.regionsByColor.set(`rgb(${i},${s},${r+1})`,e),this.regionsByColor.set(`rgb(${i},${s+1},${r-1})`,e),this.regionsByColor.set(`rgb(${i},${s+1},${r})`,e),this.regionsByColor.set(`rgb(${i},${s+1},${r+1})`,e),this.regionsByColor.set(`rgb(${i+1},${s-1},${r-1})`,e),this.regionsByColor.set(`rgb(${i+1},${s-1},${r})`,e),this.regionsByColor.set(`rgb(${i+1},${s-1},${r+1})`,e),this.regionsByColor.set(`rgb(${i+1},${s},${r-1})`,e),this.regionsByColor.set(`rgb(${i+1},${s},${r})`,e),this.regionsByColor.set(`rgb(${i+1},${s},${r+1})`,e),this.regionsByColor.set(`rgb(${i+1},${s+1},${r-1})`,e),this.regionsByColor.set(`rgb(${i+1},${s+1},${r})`,e),this.regionsByColor.set(`rgb(${i+1},${s+1},${r+1})`,e)):this.regionsByColor.set(o,e),o}}};function Ft(t,e,i,s,r){return U({x:t,y:e,width:i,height:s},r/2)}function $t(t,e,i,s,r){let o=Math.sin(r),a=Math.cos(r),h=t-i,l=e-s;return{x:h*a-l*o+i,y:h*o+l*a+s}}function U(t,e,i){return i===void 0&&(i=e),{x:t.x+i,y:t.y+e,width:t.width-(i+i),height:t.height-(e+e)}}function xi(t){return{x:Math.round(t.x)+.5,y:Math.round(t.y)+.5,width:Math.round(t.width),height:Math.round(t.height)}}function sp(t,e){let i=t.x,s=t.y,r=i+t.width,o=s+t.height;if(r<i){let g=i;i=r,r=g}if(o<s){let g=s;s=o,o=g}let a=e.x,h=e.y,l=a+e.width,d=h+e.height;if(l<a){let g=a;a=l,l=g}if(d<h){let g=h;h=d,d=g}let n=Math.max(i,a),p=Math.max(s,h);return{x:n,y:p,width:Math.min(r,l)-n,height:Math.min(o,d)-p}}function Pt(t,e,i){return{x:t.x+e,y:t.y+i}}function re(t,e,i){return t.map(s=>Pt(s,e,i))}function $(t){return t*Math.PI/180}function xt(t,e,i){let s=Math.floor(t*Math.cos(e)),r=Math.floor(-t*Math.sin(e));return{x:i.x+i.width/2+s,y:i.y+i.height/2+r}}function kd(t,e){let i=e.x-t.x,s=e.y-t.y,r=Math.sqrt(Math.pow(i,2)+Math.pow(s,2)),o=Math.acos(i/r);return s>0&&(o=2*Math.PI-o),new kt(Math.floor(r),o)}var kt=class{constructor(t,e){this.r=t,this.theta=e}toPoint(){let t=Math.floor(this.r*Math.cos(this.theta)),e=Math.floor(-this.r*Math.sin(this.theta));return{x:t,y:e}}};function oe(t,e){return t.map(i=>({x:i.x*e,y:i.y*e}))}function rp(t){return t.map(e=>({x:e.x+.5,y:e.y+.5}))}function ve(t,e,i,s,r,o,a){t.beginPath(),!o&&!a?t.rect(e,i,s,r):(s<2*o&&(o=s/2),r<2*a&&(a=r/2),t.moveTo(e+o,i),t.lineTo(e+s-o,i),t.quadraticCurveTo(e+s,i,e+s,i+a),t.lineTo(e+s,i+r-a),t.quadraticCurveTo(e+s,i+r,e+s-o,i+r),t.lineTo(e+o,i+r),t.quadraticCurveTo(e,i+r,e,i+r-a),t.lineTo(e,i+a),t.quadraticCurveTo(e,i,e+o,i))}function ae(t,e,i,s){return t===null?"":typeof t=="string"?s==="BINARY_STRING"?op(t):t:typeof t=="number"?i===-1?wi(e,t,void 0,3):wi(e,t,i,i):t instanceof Date?t.toISOString().replace("T"," ").replace("Z",""):String(t)}function op(t){let e="";for(let i=0;i<t.length;i++){let s=t.charCodeAt(i).toString(16);e+=s.length===2?s:"0"+s}return e&&`0x${e.toUpperCase()}`}function wi(t,e,i,s){if(e==null||e==null)return"";switch(t){case 0:case 1:let r={minimumFractionDigits:i,maximumFractionDigits:s,useGrouping:!1,roundingMode:"halfEven"};return Intl.NumberFormat("en-US",r).format(e);case 2:return e.toExponential(s).replace("e+","E").toUpperCase();case 3:return"0x"+e.toString(16).toUpperCase();default:return console.warn(`Unexpected format type ${t}`),String(e)}}var ap=class Md{constructor(e,i){this.canvas=e,this.ctx=e.getContext("2d"),this.hitCanvas=i||new ip,this.hitCtx=this.hitCanvas.ctx}ctx;hitCanvas;hitCtx;createChild(e,i){let s=this.hitCanvas.createChild(e,i),r=document.createElement("canvas");return r.width=e,r.height=i,new Md(r,s)}translate(e,i){this.ctx.translate(e,i),this.hitCtx.translate(e,i)}copy(e,i,s){this.ctx.drawImage(e.canvas,i,s),e.hitCanvas.transferToParent(i,s,e.canvas.width,e.canvas.height)}copyFitted(e,i,s,r,o){let{width:a,height:h}=e.canvas,l=a/h,d=r,n=d/l;n>o&&(n=o,d=n*l),this.copyScaled(e,i,s,d,n)}copyScaled(e,i,s,r,o){this.ctx.drawImage(e.canvas,i,s,r,o),e.hitCanvas.transferToParent(i,s,r,o)}clearHitCanvas(){this.hitCanvas.clear()}fillCanvas(e){this.ctx.fillStyle=e.toString(),this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}clearCanvas(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}scaleCanvas(e,i){this.ctx.canvas.style.width=e+"px",this.ctx.canvas.style.height=i+"px"}resize(e,i){(this.ctx.canvas.width!=e||this.ctx.canvas.height!=i)&&(this.ctx.canvas.width=e,this.ctx.canvas.height=i,this.hitCanvas.ctx.canvas.width=e,this.hitCanvas.ctx.canvas.height=i)}fillRect(e){"color"in e?this.ctx.fillStyle=e.color.toString():this.ctx.fillStyle=e.gradient,e.opacity!==void 0&&(this.ctx.globalAlpha=e.opacity),e.rx||e.ry?(ve(this.ctx,e.x,e.y,e.width,e.height,e.rx||0,e.ry||0),this.ctx.fill()):this.ctx.fillRect(e.x,e.y,e.width,e.height),e.opacity!==void 0&&(this.ctx.globalAlpha=1)}fillText(e){this.ctx.textBaseline=e.baseline,this.ctx.textAlign=e.align,this.ctx.font=e.font.getFontString(),this.ctx.fillStyle=e.color.toString(),this.ctx.fillText(e.text,e.x,e.y)}fillEllipse(e){this.ctx.beginPath();let i=e.startAngle||0,s=e.endAngle===void 0?2*Math.PI:e.endAngle;this.ctx.ellipse(e.cx,e.cy,e.rx,e.ry,0,i,s,e.anticlockwise),"color"in e?this.ctx.fillStyle=e.color.toString():this.ctx.fillStyle=e.gradient,e.opacity!==void 0&&(this.ctx.globalAlpha=e.opacity),this.ctx.fill(),e.opacity!==void 0&&(this.ctx.globalAlpha=1)}strokeEllipse(e){e.dash&&this.ctx.setLineDash(e.dash),this.ctx.lineWidth=e.lineWidth||1,this.ctx.beginPath();let i=e.startAngle||0,s=e.endAngle===void 0?2*Math.PI:e.endAngle;this.ctx.ellipse(e.cx,e.cy,e.rx,e.ry,0,i,s,e.anticlockwise),"color"in e?this.ctx.strokeStyle=e.color.toString():this.ctx.strokeStyle=e.gradient,this.ctx.stroke(),e.dash&&this.ctx.setLineDash([])}measureText(e,i,s=!1){this.ctx.font=i.getFontString();let r=this.ctx.measureText(e),o;return r.fontBoundingBoxAscent!==void 0&&r.fontBoundingBoxDescent!==void 0?o={width:r.width,height:r.fontBoundingBoxAscent+r.fontBoundingBoxDescent}:o={width:r.width,height:i.height},s&&(o.width=Math.ceil(o.width),o.height=Math.ceil(o.height)),o}createLinearGradient(e,i,s,r){return this.ctx.createLinearGradient(e,i,s,r)}strokeRect(e){e.dash&&this.ctx.setLineDash(e.dash);let i=e.lineWidth||1;if(this.ctx.lineWidth=i,this.ctx.strokeStyle=e.color.toString(),e.crispen&&i){let s=U(e,i/2,i/2);e.rx||e.ry?(ve(this.ctx,s.x,s.y,s.width,s.height,e.rx||0,e.ry||0),this.ctx.stroke()):this.ctx.strokeRect(s.x,s.y,s.width,s.height)}else e.rx||e.ry?(ve(this.ctx,e.x,e.y,e.width,e.height,e.rx||0,e.ry||0),this.ctx.stroke()):this.ctx.strokeRect(e.x,e.y,e.width,e.height);e.dash&&this.ctx.setLineDash([])}strokePath(e){e.dash&&this.ctx.setLineDash(e.dash),this.ctx.beginPath();for(let i of e.path.segments)i.line?this.ctx.lineTo(i.x,i.y):this.ctx.moveTo(i.x,i.y);this.ctx.lineWidth=e.lineWidth||1,this.ctx.strokeStyle=e.color.toString(),e.opacity!==void 0&&(this.ctx.globalAlpha=e.opacity),this.ctx.stroke(),e.opacity!==void 0&&(this.ctx.globalAlpha=1),e.dash&&this.ctx.setLineDash([])}fillPath(e){this.ctx.beginPath();for(let i of e.path.segments)i.line?this.ctx.lineTo(i.x,i.y):this.ctx.moveTo(i.x,i.y);"color"in e?this.ctx.fillStyle=e.color.toString():this.ctx.fillStyle=e.gradient,e.opacity!==void 0&&(this.ctx.globalAlpha=e.opacity),this.ctx.fill("evenodd"),e.opacity!==void 0&&(this.ctx.globalAlpha=1)}addHitRegion(e){return this.hitCanvas.beginHitRegion(e),new hp(this.hitCanvas.ctx)}},S=class Be{segments=[];constructor(e,i){this.segments.push({x:e,y:i,line:!1})}static fromPoints(e){let i=e.findIndex(r=>r.y!==null);if(i===-1){let r=new Be(0,0);return r.segments.length=0,r}let s=new Be(e[i].x,e[i].y);for(let r=i+1;r<e.length;r++){let{x:o,y:a}=e[r];a!==null&&(r>0&&e[r-1].y===null?s.moveTo(o,a):s.lineTo(o,a))}return s}getBoundingBox(){let e={x:this.segments[0].x,y:this.segments[0].y},i={x:this.segments[0].x,y:this.segments[0].y};for(let s=0;s<this.segments.length;s++){let r=this.segments[s];r.x<e.x&&(e.x=r.x),r.x>i.x&&(i.x=r.x),r.y<e.y&&(e.y=r.y),r.y>i.y&&(i.y=r.y)}return{x:e.x,y:e.y,width:i.x-e.x,height:i.y-e.y}}lineTo(e,i){return this.segments.push({x:e,y:i,line:!0}),this}moveTo(e,i){return this.segments.push({x:e,y:i,line:!1}),this}closePath(){let e=this.segments[0];return this.segments.push({x:e.x,y:e.y,line:!0}),this}translate(e,i){for(let s of this.segments)s.x+=e,s.y+=i;return this}},hp=class{constructor(t){this.ctx=t}addRect(t,e,i,s){return this.ctx.fillRect(t,e,i,s),this}addEllipse(t,e,i,s,r,o,a,h){this.ctx.beginPath(),this.ctx.ellipse(t,e,i,s,r,o,a,h),this.ctx.fill()}addPath(t){this.ctx.beginPath();for(let e of t.segments)e.line?this.ctx.lineTo(e.x,e.y):this.ctx.moveTo(e.x,e.y);this.ctx.fill()}},Rd=class{constructor(t,e=[]){this.widget=t;for(let i of e)this.properties.set(i.name,i)}properties=new Map;generators=[];clear(){this.properties.clear()}add(t){this.properties.set(t.name,t)}addGenerator(t){this.generators.push(t)}all(){return[...this.properties.values()]}loadProperty(t,e){if(t.hasNode(e.name)){if(e instanceof Ed)e.value=t.getActions(e.name);else if(e instanceof Hd)e.value=t.getAutoScaleWidgets(e.name);else if(e instanceof y)e.value=t.getBoolean(e.name);else if(e instanceof Fe)e.value=t.getColorMap(e.name);else if(e instanceof R)e.value=t.getColor(e.name);else if(e instanceof H)e.value=t.getFloat(e.name);else if(e instanceof O)e.value=t.getFont(e.name);else if(e instanceof b)e.value=t.getInt(e.name);else if(e instanceof $e)e.value=t.getMacros(e.name);else if(e instanceof ne)e.value=t.getPoints(e.name);else if(!(e instanceof Jt))if(e instanceof Bd)e.value=t.getRules(e.name);else if(e instanceof Id)e.value=t.getScaleOptions(e.name);else if(e instanceof Wd)e.value=t.getScripts(e.name);else if(e instanceof A)e.rawValue=t.getString(e.name);else if(e instanceof de)e.value=t.getStringList(e.name);else if(e instanceof Oe)e.value=t.getStringMap(e.name);else if(e instanceof Ie)e.value=t.getStringTable(e.name);else throw new Error(`Property ${e.name} has an unexpected type`)}}loadXMLValues(t){this.properties.forEach(e=>{this.loadProperty(t,e)}),this.resolveStringProperties();for(let e of this.generators)for(let i of e())this.properties.set(i.name,i),this.loadProperty(t,i);this.resolveStringProperties()}resolveStringProperties(){for(let t=0;t<2;t++)this.properties.forEach(e=>{if(e instanceof A){let i=e;i.rawValue!==void 0&&this.widget?e.value=this.widget.expandMacro(i.rawValue):e.value=i.rawValue}})}getProperty(t){return this.properties.get(t)}getValue(t,e=!1){let i=this.properties.get(t);if(i&&i.value!==void 0)return i.value;if(!e)throw new Error(`Missing property ${t}`)}setValue(t,e){let i=this.properties.get(t);if(!i)throw new Error(`Cannot set value of unknown property ${t}`);i.value=e}},Z=class{constructor(t,e){this.name=t,this.defaultValue=e,this.value=e}_value;listeners;get value(){return this._value}set value(t){if(this.value!==t){let e=this._value;if(this._value=t,this.listeners)for(let i of this.listeners)i(t,e)}}addListener(t){this.listeners=this.listeners||[],this.listeners.push(t)}removeListener(t){let e=this.listeners||[],i=e.indexOf(t);i!==-1&&e.splice(i,1)}printScriptValue(t){return String(t)}},A=class extends Z{rawValue;printScriptValue(t){return`"${t.replace('"','\\"')}"`}},Jt=class extends Z{constructor(t,e){super(t),this.pvPropertyName=e}},b=class extends Z{},H=class extends Z{},y=class extends Z{},R=class extends Z{printScriptValue(t){let{red:e,green:i,blue:s}=C({},t);return`ColorFontUtil.getColorFromRGB(${e}, ${i}, ${s})`}},O=class extends Z{printScriptValue(t){let{name:e,height:i,style:s}=C({},t);return`ColorFontUtil.getFont("${e}", ${i}, ${s})`}},Fe=class extends Z{printScriptValue(t){return`${t.code}`}},ne=class extends Z{},Ed=class extends Z{},$e=class extends Z{},Wd=class extends Z{},de=class extends Z{},Oe=class extends Z{},Ie=class extends Z{},Bd=class extends Z{},Id=class extends Z{},Hd=class extends Z{},Dd=class{actions=[];hookFirstActionToClick=!1;hookAllActionsToClick=!1;add(t){this.actions.push(t)}isClickable(){return this.actions.length&&(this.hookFirstActionToClick||this.hookAllActionsToClick)}getAction(t){if(!(t>=this.actions.length))return this.actions[t]}toString(){return this.actions.length===1?String(this.actions[0]):`${this.actions.length} actions`}},yi="description",ut=class{properties;constructor(){this.properties=new Rd(null,[new A(yi,"")])}parseNode(t){this.properties.loadXMLValues(t)}get description(){return this.properties.getValue(yi)}},vi="command",bi="command_directory",Ti="wait_time",lp=class extends ut{constructor(){super(),this.properties.add(new A(vi,"")),this.properties.add(new A(bi,"$(user.home)")),this.properties.add(new b(Ti,10))}execute(t){throw new Error("Unsupported action EXECUTE_CMD")}get command(){return this.properties.getValue(vi)}get commandDirectory(){return this.properties.getValue(bi)}get waitTime(){return this.properties.getValue(Ti)}toString(){return`Execute Command ${this.command}`}},np=["Arial","Arial Black","Courier New","Helvetica","Tahoma","Verdana"],it=class Nt{constructor(e,i,s,r){this.name=e,this.style=s,r?this.height=i:this.height=Math.ceil(i*4/3)}static ARIAL_9=new Nt("Arial",9,0,!1);static ARIAL_10=new Nt("Arial",10,0,!1);static ARIAL_11=new Nt("Arial",11,0,!1);static ARIAL_12_BOLD=new Nt("Arial",12,1,!1);height;scale(e){return new Nt(this.name,e*this.height,this.style,!0)}getFontString(){let e=this.name;return e.indexOf(" ")!==-1&&(e=`"${e}"`),this.style===1?`bold ${this.height}px ${e}`:this.style===2?`italic ${this.height}px ${e}`:this.style===3?`italic bold ${this.height}px ${e}`:(this.style!==0&&console.warn(`Unsupported font style ${this.style}`),`normal ${this.height}px ${e}`)}get bold(){return this.style===1||this.style===3}get italic(){return this.style===2||this.style===3}isWebSafe(){return np.indexOf(this.name)!==-1}},dp=class{BLACK=f.BLACK;BLUE=f.BLUE;CYAN=f.CYAN;DARK_GRAY=f.DARK_GRAY;GRAY=f.GRAY;GREEN=f.GREEN;LIGHT_BLUE=f.LIGHT_BLUE;ORANGE=f.ORANGE;PINK=f.PINK;PURPLE=f.PURPLE;RED=f.RED;WHITE=f.WHITE;YELLOW=f.YELLOW;getColorFromRGB(t,e,i){return new f(t,e,i)}getFont(t,e,i){return new it(t,e,i,!1)}},up=class{constructor(t){this.display=t}writeInfo(t){this.display.getConsoleHandler().writeInfo(t)}writeError(t){this.display.getConsoleHandler().writeError(t)}writeWarning(t){this.display.getConsoleHandler().writeWarning(t)}},pp=class{createDoubleArray(t){return Array(t).fill(0)}createIntArray(t){return Array(t).fill(0)}toJavaDoubleArray(t){return[...t]}toJavaIntArray(t){return[...t]}},cp=class{constructor(t,e){this.spreadsheet=t,this.scriptEngine=e}addModifiedListener(t){}addSelectionChangedListener(t){this.spreadsheet.addSelectionChangedListener(()=>{this.scriptEngine.schedule(()=>{let e=t.selectionChanged;e(this.spreadsheet.getSelection())})})}appendRow(){return this.spreadsheet.appendRow()}deleteColumn(t){this.spreadsheet.deleteColumn(t)}deleteRow(t){this.spreadsheet.deleteRow(t)}getCellText(t,e){return this.spreadsheet.getCellText(t,e)}getColumnCount(){return this.spreadsheet.getColumnCount()}getContent(){return this.spreadsheet.getContent()}getRowCount(){return this.spreadsheet.getRowCount()}getSelection(){return this.spreadsheet.getSelection()}insertColumn(t){this.spreadsheet.insertColumn(t)}insertRow(t){this.spreadsheet.insertRow(t)}isEmpty(){return this.spreadsheet.isEmpty()}refresh(){this.spreadsheet.refresh()}setCellBackground(t,e,i){this.spreadsheet.setCellBackground(t,e,i)}setCellForeground(t,e,i){this.spreadsheet.setCellForeground(t,e,i)}setCellText(t,e,i){this.spreadsheet.setCellText(t,e,i)}setColumnCellEditorData(t,e){this.spreadsheet.setColumnCellEditorData(t,e)}setColumnsCount(t){this.spreadsheet.setColumnsCount(t)}setContent(t){this.spreadsheet.setContent(t)}setRowBackground(t,e){this.spreadsheet.setRowBackground(t,e)}setRowForeground(t,e){this.spreadsheet.setRowForeground(t,e)}revealRow(t){}},He=class{constructor(t,e,i){this.code=t,this.interpolate=e,this.autoscale=i,t===0||(t===1?(this.values=[0,1],this.colors=[[0,0,0],[255,255,255]]):t===2?(this.values=[0,.111,.365,.619,.873,1],this.colors=[[0,0,143],[0,0,255],[0,255,255],[255,255,0],[255,0,0],[128,0,0]]):t===3?(this.values=[0,.126,.251,.375,.5,.625,.749,.874,1],this.colors=[[0,0,0],[255,0,255],[0,0,255],[0,255,255],[0,255,0],[255,255,0],[255,128,0],[255,0,0],[255,255,255]]):t===4?(this.values=[0,.365,.746,1],this.colors=[[11,0,0],[255,0,0],[255,255,0],[255,255,255]]):t===5?(this.values=[0,1],this.colors=[[0,255,255],[255,0,255]]):t===6&&(this.values=[0,.5,1],this.colors=[[0,0,0],[255,0,0],[255,255,255]]))}values=[];colors=[];entries=[];dirty=!0;addMapping(t,e,i,s){this.values.push(t),this.colors.push([e,i,s]),this.dirty=!0}compile(){this.entries.length=0;for(let t=0;t<this.values.length;t++)this.entries.push([this.values[t],this.colors[t]]);this.entries.sort((t,e)=>t[0]<e[0]?-1:t[0]>e[0]?1:0)}lookup(t){this.dirty&&(this.compile(),this.dirty=!1);let e=this.binarySearch(t);if(e>=0)return this.entries[e][1];if(e=-e-1,e===0)return this.entries[e][1];if(e===this.entries.length)return this.entries[e-1][1];if(this.interpolate){let[i,s]=this.entries[e-1],[r,o]=this.entries[e],a=(t-i)/(r-i),h=Math.floor((o[0]-s[0])*a+s[0]),l=Math.floor((o[1]-s[1])*a+s[1]),d=Math.floor((o[2]-s[2])*a+s[2]);return[h,l,d]}else return this.entries[e-1][1]}getMinMax(){let t=Math.min.apply(Math,this.values),e=Math.max.apply(Math,this.values);return[t,e]}binarySearch(t){let e=0,i=this.entries.length-1;for(;e<=i;){let s=i+e>>1;if(t>this.entries[s][0])e=s+1;else if(t<this.entries[s][0])i=s-1;else return s}return-e-1}},gp=class{constructor(t,e){this.action=t,this.widget=e}getPropertyValue(t){let e=this.action.properties.getProperty(t);return e?e.value:null}setPropertyValue(t,e){let i=this.action.properties.getProperty(t);if(!i)throw new Error(`Cannot set value of unknown property ${t}`);i instanceof A?(e=e!==void 0?String(e):e,this.action.properties.setValue(t,e)):this.action.properties.setValue(t,e),this.widget.requestRepaint()}},mp=class{constructor(t){this.array=t}get(t){return this.array[t]}},Ge=class{constructor(t){this._pv=t}getName(){return this._pv.name}getValue(){return this._pv.value??null}setValue(t,e){this._pv.pvEngine.setValue(new Date,this._pv.name,t)}isConnected(){return!this._pv.disconnected}isWriteAllowed(){return this._pv.writable}addListener(t){this._pv.addListener(()=>{t.valueChanged(this)})}removeListener(t){this._pv.removeListener(t)}},ze=class{constructor(t){this.widget=t}executeAction(t){this.widget.executeActionByIndex(t)}getPVByName(t){let e=this.widget.display.getPV(t);return e?new Ge(e):null}getPV(t="pv_name"){let e=this.getPropertyValue(t);return e?this.getPVByName(e):null}getHookedActions(){let t=this.widget.getHookedActions().map(e=>new gp(e,this.widget));return new mp(t)}getVar(t){return this.widget.vars.get(t)??null}setVar(t,e){this.widget.vars.set(t,e)}getPropertyValue(t){let e=this.widget.properties.getProperty(t);return e?e.value:null}setPropertyValue(t,e){let i=this.widget.properties.getProperty(t);if(!i)throw new Error(`Cannot set value of unknown property ${t}`);if(i instanceof A)e=e!==void 0?String(e):e,this.widget.properties.setValue(t,e);else if(i instanceof Fe){let s=0;switch(e){case"GrayScale":s=1;break;case"JET":s=2;break;case"ColorSpectrum":s=3;break;case"Hot":s=4;break;case"Cool":s=5;break;case"Shaded":s=6;break}let r=new He(s,!0,!0);this.widget.properties.setValue(t,r)}else this.widget.properties.setValue(t,e);this.widget.requestRepaint()}getName(){return this.getPropertyValue("name")}setX(t){this.setPropertyValue("x",t)}setY(t){this.setPropertyValue("y",t)}setWidth(t){this.setPropertyValue("width",t)}setHeight(t){this.setPropertyValue("height",t)}setEnabled(t){this.setPropertyValue("enabled",t)}setVisible(t){this.setPropertyValue("visible",t)}getValue(){return this.widget.value??null}setValue(t){this.widget.value=t}setValueInUIThread(t){this.setValue(t)}},fp=class extends ze{table;spreadSheetTable;constructor(t,e){super(t),this.table=t,this.spreadSheetTable=new cp(this.table.spreadsheet,e)}getTable(){return this.spreadSheetTable}},xp=class extends ze{xyGraph;constructor(t){super(t),this.xyGraph=t}clearGraph(){this.xyGraph.clearGraph()}getXBuffer(t){return this.xyGraph.getTrace(t).snapshot().map(e=>e.x)}getYBuffer(t){return this.xyGraph.getTrace(t).snapshot().map(e=>e.y)}};function Nd(t,e){switch(t.widgetType){case"Table":return new fp(t,e);case"XY Graph":return new xp(t);default:return new ze(t)}}var wp=class{constructor(t,e){this.display=t,this.scriptEngine=e}isActive(){return!0}getWidget(t){let e=this.display.findWidgetByName(t);if(e)return Nd(e,this.scriptEngine)}},yp=class{constructor(t){this.display=t}readTextFile(t){let e=this.display.resolvePath(t);var i=new XMLHttpRequest;if(i.open("GET",e,!1),i.send(null),i.status===200)return i.responseText;throw Error(`Cannot open ${e}`)}},vp=class{constructor(t){this.display=t}fullScreen(){document.documentElement.requestFullscreen()}openConfirmDialog(t){return this.display.getDialogHandler().openConfirmDialog("Confirm Dialog",t)}openInformationDialog(t){this.display.getDialogHandler().openInformationDialog("Information",t)}openWarningDialog(t){this.display.getDialogHandler().openWarningDialog("Warning",t)}openErrorDialog(t){this.display.getDialogHandler().openErrorDialog("Error",t)}openPasswordDialog(t,e){return this.display.getDialogHandler().openPasswordDialog("Password Input Dialog",t,e)}},bp=class{constructor(t){this.display=t}openInformation(t,e,i){this.display.getDialogHandler().openInformationDialog(e,i)}openConfirm(t,e,i){return this.display.getDialogHandler().openConfirmDialog(e,i)}openError(t,e,i){this.display.getDialogHandler().openErrorDialog(e,i)}},Fd=class{constructor(t,e){this.name=t,this.pvEngine=e}_writable=!1;_units;_labels;_typeHint;_lowerDisplayLimit;_lowerAlarmLimit;_lowerWarningLimit;_upperWarningLimit;_upperAlarmLimit;_upperDisplayLimit;_time;_value;_severity="NONE";_indexValue;_precision=-1;_disconnected=!1;provider;get navigable(){return this.provider?.isNavigable()||!1}get units(){return this._units}set units(t){this._units=t,this.pvEngine.requestRepaint()}get labels(){return this._labels}set labels(t){this._labels=t,this.pvEngine.requestRepaint()}get lowerDisplayLimit(){return this._lowerDisplayLimit}set lowerDisplayLimit(t){this._lowerDisplayLimit=t,this.pvEngine.requestRepaint()}get lowerAlarmLimit(){return this._lowerAlarmLimit}set lowerAlarmLimit(t){this._lowerAlarmLimit=t,this.pvEngine.requestRepaint()}get lowerWarningLimit(){return this._lowerWarningLimit}set lowerWarningLimit(t){this._lowerWarningLimit=t,this.pvEngine.requestRepaint()}get upperWarningLimit(){return this._upperWarningLimit}set upperWarningLimit(t){this._upperWarningLimit=t,this.pvEngine.requestRepaint()}get upperAlarmLimit(){return this._upperAlarmLimit}set upperAlarmLimit(t){this._upperAlarmLimit=t,this.pvEngine.requestRepaint()}get upperDisplayLimit(){return this._upperDisplayLimit}set upperDisplayLimit(t){this._upperDisplayLimit=t,this.pvEngine.requestRepaint()}get precision(){return this._precision}set precision(t){this._precision=t,this.pvEngine.requestRepaint()}get writable(){return this._writable}set writable(t){this._writable=t,this.pvEngine.requestRepaint()}get disconnected(){return this._disconnected}set disconnected(t){this._disconnected=t,this.pvEngine.requestRepaint()}get time(){return this._time}get value(){return this._value}get indexValue(){return this._indexValue}get severity(){return this._severity}get typeHint(){return this._typeHint}get alarmName(){let t=this.toNumber();return t==null?"NONE":t<=(this.lowerAlarmLimit??NaN)?"LOLO":t>=(this.upperAlarmLimit??NaN)?"HIHI":t<=(this.lowerWarningLimit??NaN)?"LOW":t>=(this.upperWarningLimit??NaN)?"HIGH":"NONE"}toNumber(){if(this.value===null)return null;if(typeof this.value=="number")return this.value;if(typeof this.value=="boolean")return this.value?1:0;if(typeof this.indexValue!==void 0)return this.indexValue}setSample(t){this._time=t.time,this._value=t.value,this._indexValue=t.valueIndex,this._severity=t.severity,this._units=t.units,this._typeHint=t.typeHint,this.pvEngine.requestRepaint()}addListener(t){this.pvEngine.addListener(this.name,t)}removeListener(t){this.pvEngine.addListener(this.name,t)}toString(){if(this.value!==void 0)return String(this.value)}},Tp=(t=>(t.NONE="NONE",t.MINOR="MINOR",t.MAJOR="MAJOR",t.INVALID="INVALID",t.UNDEFINED="UNDEFINED",t))(Tp||{}),Sp=["yyyy","MM","dd","HH","mm","ss","nnnnnnnnn"],Vp=class{constructor(t){this.display=t,this.pvEngine=t.pvEngine}pvEngine;checkPVValue(t){if(t.getValue()===null)throw new Error(`PV ${t.getName()} has no value.`)}createPV(t,e){let i=this.pvEngine.createPV(t);return new Ge(i)}writePV(t,e,i){this.pvEngine.createPV(t),this.pvEngine.setValue(new Date,t,e)}getDouble(t){this.checkPVValue(t);let e=t._pv.toNumber();return parseFloat(e??t.getValue())}getLong(t){this.checkPVValue(t);let e=t._pv.toNumber();return typeof e=="number"&&(e=Math.floor(e)),parseInt(e??t.getValue(),10)}getString(t){return this.checkPVValue(t),ae(t._pv.value,0,-1,t._pv.typeHint)}getStringArray(t){this.checkPVValue(t);let e=t.getValue();return Array.isArray(e)?e.map(i=>String(i)):[String(e)]}getTimeInMilliseconds(t){return this.checkPVValue(t),t._pv.time?.getTime()??0}getTimeString(t,e="yyyy-MM-dd HH:mm:ss.nnnnnnnnn"){this.checkPVValue(t);let i=t._pv.time;if(i){let s=e;for(let r of Sp)s=s.replace(r,this.formatDate(i,r));return s}return null}getSeverity(t){switch(this.checkPVValue(t),t._pv.severity){case"NONE":return 0;case"MAJOR":return 1;case"MINOR":return 2;default:return-1}}getSeverityString(t){return this.checkPVValue(t),String(t._pv.severity)}getStatus(t){return this.checkPVValue(t),t._pv.alarmName}getUnits(t){return this.checkPVValue(t),t._pv.units||null}formatDate(t,e){let{utc:i}=this.display;if(e==="yyyy")return String(i?t.getUTCFullYear():t.getFullYear());if(e==="MM"){let s=(i?t.getUTCMonth():t.getMonth())+1;return s<10?"0"+s:""+s}else if(e==="dd"){let s=i?t.getUTCDate():t.getDate();return s<10?"0"+s:""+s}else if(e==="HH"){let s=i?t.getUTCHours():t.getHours();return s<10?"0"+s:""+s}else if(e==="mm"){let s=i?t.getUTCMinutes():t.getMinutes();return s<10?"0"+s:""+s}else if(e==="ss"){let s=i?t.getUTCSeconds():t.getSeconds();return s<10?"0"+s:""+s}else if(e==="nnnnnnnnn"){let s=i?t.getUTCMilliseconds():t.getMilliseconds();return s<10?"00"+s:s<100?"0"+s:""+s}else throw new Error(`Unexpected format '${e}'`)}},Cp=class{constructor(t){this.display=t}openOPI(t,e,i,s){if(i===0){let r={path:e,replace:i===0};this.display.fireEvent("opendisplay",r)}else throw new Error(`Unsupported target ${i}`)}closeCurrentOPI(){this.display.fireEvent("closedisplay",{})}};function _p(t){let e=t.widget,i=t.widget.display,s=function(l){this.run=l.run},r=function(l){this.runnable=l};r.prototype.start=function(){t.schedule(()=>this.runnable.run())},r.sleep=function(l){let d=Date.now(),n=0;for(;Date.now()<d+l;)n++;n||console.trace("Should not happen")};let o=function(){};o.prototype.schedule=function(l,d){t.schedule(l,d)};let a=function(l){this.valueChanged=d=>{t.schedule(()=>{let n=l.valueChanged;n(d)})}},h={ITableModifiedListener:function(l){this.modified=d=>{let n=l.modified;n(d)}},ITableSelectionChangedListener:function(l){this.selectionChanged=d=>{let n=l.selectionChanged;n(d)}}};return{display:new wp(e.display,t),widget:Nd(e,t),java:{lang:{Runnable:s,Thread:r},util:{Timer:o}},org:{csstudio:{swt:{widgets:{natives:{SpreadSheetTable:h}}}},yamcs:{studio:{data:{IPVListener:a}}}},ColorFontUtil:new dp,ConsoleUtil:new up(i),DataUtil:new pp,FileUtil:new yp(i),GUIUtil:new vp(i),MessageDialog:new bp(i),PVUtil:new Vp(i),ScriptUtil:new Cp(i),SpreadSheetTable:h,Java:{type:function(l){switch(l){case"java.lang.Runnable":return s;case"java.lang.Thread":return r;case"java.util.Timer":return o;case"org.csstudio.swt.widgets.natives.SpreadSheetTable":return h;case"org.yamcs.studio.data.IPVListener":return a;default:throw new Error("Unexpected class name: "+l)}},to:function(l,d){return l}}}}var At,st,se;function Ap(){At=document.createElement("iframe"),At.id="script-e",At.style.display="none",document.body.appendChild(At),st=At.contentWindow,se=st.eval,!se&&st.execScript&&(st.execScript.call(st,"null"),se=st.eval)}var he=class{constructor(t,e,i=[]){this.widget=t,this.scriptText=e,At||Ap(),this.scriptText=e.replace(/importClass\([^\)]*\)\s*\;?/gi,"").replace(/importPackage\([^\)]*\)\s*\;?/gi,"").trim(),this.context=C(C({pvs:i.map(s=>new Ge(s)),triggerPV:null},t.display.pvEngine.scriptLibraries),_p(this))}context;run(t){window.setTimeout(()=>{if(this.context.triggerPV=null,t)for(let e of this.context.pvs)e._pv===t&&(this.context.triggerPV=e);this.runWithContext(()=>{se.call(st,this.scriptText)})})}schedule(t,e){window.setTimeout(()=>this.runWithContext(t),e)}runWithContext(t){let e=[];for(let i in At.contentWindow)e.push(i);try{for(let s in this.context)this.context.hasOwnProperty(s)&&(st[s]=this.context[s]);t();let i={};for(let s in st)e.indexOf(s)===-1&&(i[s]=st[s]);this.context=i}finally{for(let i in st)e.indexOf(i)===-1&&delete st[i]}}},Si="path",Vi="embedded",Ci="scriptText",Lp=class extends ut{constructor(){super(),this.properties.add(new A(Si,"")),this.properties.add(new y(Vi,!1)),this.properties.add(new A(Ci,""))}execute(t){this.embedded?new he(t,this.scriptText).run():fetch(t.display.resolvePath(this.path),{credentials:"same-origin"}).then(e=>{e.ok&&e.text().then(i=>{new he(t.display.instance,i).run()})})}get path(){return this.properties.getValue(Si)}get embedded(){return this.properties.getValue(Vi)}get scriptText(){return this.properties.getValue(Ci)}toString(){return"Execute JavaScript"}},_i="macros",Ai="mode",Li="path",Pp=class extends ut{constructor(){super(),this.properties.add(new A(Li,"")),this.properties.add(new $e(_i)),this.properties.add(new b(Ai,0))}execute(t){let e=C({},this.macros.macros),i={path:this.path,replace:this.mode===0,args:e};t.display.fireEvent("opendisplay",i)}get macros(){return this.properties.getValue(_i)}get path(){return this.properties.getValue(Li)}get mode(){return this.properties.getValue(Ai)}toString(){return`Open ${this.path}`}},Pi="path",kp=class extends ut{constructor(){super(),this.properties.add(new A(Pi,""))}execute(t){throw new Error("Unsupported action OPEN_FILE")}get path(){return this.properties.getValue(Pi)}toString(){return`Open ${this.path}`}},ki="hyperlink",Mp=class extends ut{constructor(){super(),this.properties.add(new A(ki,"http://"))}execute(t){this.hyperlink&&(window.location.href=this.hyperlink)}get hyperlink(){return this.properties.getValue(ki)}toString(){return`Open Webpage ${this.hyperlink}`}},Mi="path",Rp=class extends ut{constructor(){super(),this.properties.add(new A(Mi,""))}execute(t){this.path&&new Audio(t.display.resolvePath(this.path)).play()}get path(){return this.properties.getValue(Mi)}toString(){return`Play WAV File ${this.path}`}},Ri="command",Ei="args",Wi="confirm_message",Ep=class extends ut{constructor(){super(),this.properties.add(new A(Ri,"")),this.properties.add(new Oe(Ei,{})),this.properties.add(new A(Wi,""))}execute(t){if(this.confirmMessage&&!t.display.getDialogHandler().openConfirmDialog("Confirm Dialog",this.confirmMessage))return;let e=t.expandMacro(this.command),i={};for(let r in this.args)i[r]=t.expandMacro(this.args[r]);let s={command:e,args:i};t.display.fireEvent("runcommand",s)}get command(){return this.properties.getValue(Ri)}get args(){return this.properties.getValue(Ei)}get confirmMessage(){return this.properties.getValue(Wi)}toString(){return`Run ${this.command}`}},Bi="procedure",Ii="args",Hi="confirm_message",Wp=class extends ut{constructor(){super(),this.properties.add(new A(Bi,"")),this.properties.add(new Oe(Ii,{})),this.properties.add(new A(Hi,""))}execute(t){if(this.confirmMessage&&!t.display.getDialogHandler().openConfirmDialog("Confirm Dialog",this.confirmMessage))return;let e={procedure:this.procedure,args:this.args};t.display.fireEvent("runprocedure",e)}get procedure(){return this.properties.getValue(Bi)}get args(){return this.properties.getValue(Ii)}get confirmMessage(){return this.properties.getValue(Hi)}toString(){return`Run ${this.procedure}`}},Di="path",Ni="confirm_message",Bp=class extends ut{constructor(){super(),this.properties.add(new A(Di,"")),this.properties.add(new A(Ni,""))}execute(t){if(this.confirmMessage&&!t.display.getDialogHandler().openConfirmDialog("Confirm Dialog",this.confirmMessage))return;let e={path:t.display.resolvePath(this.path)};t.display.fireEvent("runstack",e)}get path(){return this.properties.getValue(Di)}get confirmMessage(){return this.properties.getValue(Ni)}toString(){return`Run ${this.path}`}},Fi="pv_name",$i="value",Oi="timeout",Gi="confirm_message",Ip=class extends ut{constructor(){super(),this.properties.add(new A(Fi,"$(pv_name)")),this.properties.add(new A($i,"")),this.properties.add(new b(Oi,10)),this.properties.add(new A(Gi,""))}execute(t){if(!(this.confirmMessage&&!t.display.getDialogHandler().openConfirmDialog("Confirm Dialog",this.confirmMessage))&&this.pvName){let e=t.expandMacro(this.pvName);t.display.pvEngine.createPV(e),t.display.pvEngine.setValue(new Date,e,this.value)}}get pvName(){return this.properties.getValue(Fi)}get value(){return this.properties.getValue($i)}get timeout(){return this.properties.getValue(Oi)}get confirmMessage(){return this.properties.getValue(Gi)}toString(){return`Write ${this.value} to ${this.pvName}`}},Hp=class{includeParentMacros=!0;macros={};clear(){this.macros={}}set(t,e){this.macros[t]=e}get(t){if(t in this.macros)return this.macros[t]}},$d=class{rules=[]},Dp=class{constructor(t,e,i){this.autoScaleWidgets=t,this.minWidth=e,this.minHeight=i}},Np=class{constructor(t,e,i){this.widthScalable=t,this.heightScalable=e,this.keepWidthHeightRatio=i}},Fp=class{scripts=[]},Od=class Zt{constructor(e){this.node=e}get name(){return this.node.nodeName}static parseFromXML(e){let i=new DOMParser().parseFromString(e,"text/xml");return new Zt(i.documentElement)}getNode(e){let i=this.findChild(e);return new Zt(i)}getNodes(e){let i=[];for(let s=0;s<this.node.childNodes.length;s++){let r=this.node.childNodes[s];r.nodeType!==3&&(!e||r.nodeName===e)&&i.push(new Zt(r))}return i}hasNode(e){for(let i=0;i<this.node.childNodes.length;i++)if(this.node.childNodes[i].nodeName===e)return!0;return!1}hasAttribute(e){return this.node.hasAttribute(e)}getTextContent(e){return this.node.textContent||e||""}getString(e,i){for(let s=0;s<this.node.childNodes.length;s++){let r=this.node.childNodes[s];if(r.nodeName===e&&r.textContent!==null)return r.textContent}if(i!==void 0)return i;throw new Error(`No child node named ${e} could be found`)}getStringAttribute(e){let i=this.node.attributes.getNamedItem(e);if(i===null)throw new Error(`No attribute named ${e}`);return i.textContent||""}getFloat(e,i){for(let s=0;s<this.node.childNodes.length;s++){let r=this.node.childNodes[s];if(r.nodeName===e&&r.textContent!==null)return parseFloat(r.textContent)}if(i!==void 0)return i;throw new Error(`No child node named ${e} could be found`)}getInt(e,i){for(let s=0;s<this.node.childNodes.length;s++){let r=this.node.childNodes[s];if(r.nodeName===e&&r.textContent!==null)return parseInt(r.textContent,10)}if(i!==void 0)return i;throw new Error(`No child node named ${e} could be found`)}getIntAttribute(e){let i=this.node.attributes.getNamedItem(e);if(i===null)throw new Error(`No attribute named ${e}`);return parseInt(i.textContent||"",10)}getBoolean(e,i){for(let s=0;s<this.node.childNodes.length;s++){let r=this.node.childNodes[s];if(r.nodeName===e)return r.textContent==="true"}if(i!==void 0)return i;throw new Error(`No child node named ${e} could be found`)}getBooleanAttribute(e,i){let s=this.node.attributes.getNamedItem(e);if(s===null){if(i!==void 0)return i;throw new Error(`No attribute named ${e}`)}else return s.textContent==="true"}getColor(e,i){let s=this.findChild(e);for(let r=0;r<s.childNodes.length;r++){let o=s.childNodes[r];if(o.nodeName==="color")return this.parseColorNode(new Zt(o))}if(i!==void 0)return i;throw new Error("No child node named 'color' could be found")}getFont(e){let i=this.getNode(e);if(i.hasNode("opifont.name")){let s=i.getNode("opifont.name"),r=s.getStringAttribute("fontName"),o=s.getIntAttribute("height"),a=s.getIntAttribute("style"),h=!1;return s.hasAttribute("pixels")&&(h=s.getBooleanAttribute("pixels")),new it(r,o,a,h)}else{let s=i.getNode("fontdata"),r=s.getStringAttribute("fontName"),o=s.getIntAttribute("height"),a=s.getIntAttribute("style"),h=!1;return s.hasAttribute("pixels")&&(h=s.getBooleanAttribute("pixels")),new it(r,o,a,h)}}getPoints(e){let i=this.getNode(e),s=[];for(let r of i.getNodes("point"))s.push({x:r.getIntAttribute("x"),y:r.getIntAttribute("y")});return s}getStringList(e){let i=this.getNode(e),s=[];for(let r of i.getNodes("s"))s.push(r.getTextContent());return s}getStringMap(e){let i=this.getNode(e),s={};for(let r of i.getNodes())s[r.name]=i.getString(r.name);return s}getStringTable(e){let i=this.getNode(e),s=[];for(let r of i.getNodes("row")){let o=[];for(let a of r.getNodes("col"))o.push(a.getTextContent());s.push(o)}return s}getScripts(e){let i=this.getNode(e),s=new Fp;for(let r of i.getNodes("path")){let o=[];for(let h of r.getNodes("pv"))o.push({pvName:h.getTextContent(),trigger:h.getBooleanAttribute("trig")});let a=r.getStringAttribute("pathString");a==="EmbeddedJs"?s.scripts.push({embedded:!0,text:r.getString("scriptText"),checkConnect:r.getBooleanAttribute("checkConnect"),skipFirstExecution:r.getBooleanAttribute("sfe",!1),inputs:o}):a==="EmbeddedPy"?console.warn("Unsupported EmbeddedPy script"):s.scripts.push({embedded:!1,path:a,checkConnect:r.getBooleanAttribute("checkConnect"),skipFirstExecution:r.getBooleanAttribute("sfe",!1),inputs:o})}return s}getScaleOptions(e){let i=this.getNode(e);return new Np(i.getBoolean("width_scalable"),i.getBoolean("height_scalable"),i.getBoolean("keep_wh_ratio"))}getAutoScaleWidgets(e){let i=this.getNode(e);return new Dp(i.getBoolean("auto_scale_widgets"),i.getInt("min_width"),i.getInt("min_height"))}getColorMap(e){let i=this.getNode(e);if(i.hasNode("e")){let s=new He(0,i.getBoolean("interpolate"),i.getBoolean("autoscale"));for(let r of i.getNodes("e")){let o=Number(r.getTextContent()),a=r.getIntAttribute("red"),h=r.getIntAttribute("green"),l=r.getIntAttribute("blue");s.addMapping(o,a,h,l)}}else return new He(i.getInt("map"),i.getBoolean("interpolate"),i.getBoolean("autoscale"))}getRules(e){let i=this.getNode(e),s=new $d;for(let r of i.getNodes("rule")){let o=[];for(let h of r.getNodes("pv"))o.push({pvName:h.getTextContent(),trigger:h.getBooleanAttribute("trig")});let a=[];for(let h of r.getNodes("exp"))h.getNode("value").hasNode("color")?a.push({type:"color",expression:h.getStringAttribute("bool_exp"),outputValue:h.getColor("value")}):a.push({type:"string",expression:h.getStringAttribute("bool_exp"),outputValue:h.getString("value")});s.rules.push({name:r.getStringAttribute("name"),propertyName:r.getStringAttribute("prop_id"),outputExpression:r.getBooleanAttribute("out_exp"),inputs:o,expressions:a})}return s}getMacros(e){let i=this.getNode(e),s=new Hp;s.includeParentMacros=i.getBoolean("include_parent_macros");for(let r of i.getNodes())r.name!=="include_parent_macros"&&s.set(r.name,i.getString(r.name));return s}getActions(e){let i=this.getNode(e),s=new Dd;s.hookFirstActionToClick=i.getBooleanAttribute("hook"),s.hookAllActionsToClick=i.getBooleanAttribute("hook_all",!1);for(let r of i.getNodes("action")){let o=r.getStringAttribute("type");if(o==="OPEN_DISPLAY"){let a=new Pp;a.parseNode(r),s.add(a)}else if(o==="OPEN_FILE"){let a=new kp;a.parseNode(r),s.add(a)}else if(o==="EXECUTE_CMD"){let a=new lp;a.parseNode(r),s.add(a)}else if(o==="EXECUTE_JAVASCRIPT"){let a=new Lp;a.parseNode(r),s.add(a)}else if(o==="WRITE_PV"){let a=new Ip;a.parseNode(r),s.add(a)}else if(o==="PLAY_SOUND"){let a=new Rp;a.parseNode(r),s.add(a)}else if(o==="OPEN_WEBPAGE"){let a=new Mp;a.parseNode(r),s.add(a)}else if(o==="RUN_COMMAND"){let a=new Ep;a.parseNode(r),s.add(a)}else if(o==="RUN_COMMAND_STACK"){let a=new Bp;a.parseNode(r),s.add(a)}else if(o==="RUN_PROCEDURE"){let a=new Wp;a.parseNode(r),s.add(a)}else console.warn(`Unsupported action type ${o}`),s.add(null)}return s}parseColorNode(e){let i=e.getIntAttribute("red"),s=e.getIntAttribute("green"),r=e.getIntAttribute("blue");return new f(i,s,r)}findChild(e){for(let i=0;i<this.node.childNodes.length;i++){let s=this.node.childNodes[i];if(s.nodeName===e)return s}throw new Error(`No child node named ${e} could be found`)}},zi="actions",Ui="background_color",qi="backcolor_alarm_sensitive",Yi="border_alarm_sensitive",Xi="border_color",ji="border_width",Ki="border_style",Zi="enabled",Ji="foreground_color",Qi="forecolor_alarm_sensitive",be="height",ts="name",Te="pv_name",es="pv_value",is="rules",ss="scale_options",rs="scripts",Se="text",os="tooltip",as="transparent",hs="visible",ls="widget_type",Ve="width",ns="wuid",Ce="x",_e="y",G=class{constructor(t,e){this.display=t,this.parent=e,this.properties=new Rd(this,[new Ed(zi,new Dd),new y(qi,!1),new R(Ui,f.TRANSPARENT),new y(Yi,!1),new R(Xi),new b(Ki),new b(ji),new y(Zi,!0),new y(Qi,!1),new R(Ji),new b(be),new A(ts),new A(Te),new Jt(es,Te),new Bd(is,new $d),new Wd(rs),new A(Se,""),new A(os,""),new y(as,!1),new y(hs),new A(ls),new b(Ve),new A(ns),new b(Ce),new b(_e),new Id(ss)])}x=0;y=0;width=0;height=0;_value;fillRoundRectangleBackgroundBorder=!0;holderRegion;properties;vars=new Map;pvs=[];async parseNode(t){this.properties.loadXMLValues(t);for(let e of this.properties.all())if(e instanceof O){let i=e.value;this.loadFont(i)}if(this.pvName){let e=this.display.pvEngine.createPV(this.pvName);this.pvs.push(e)}for(let e of this.scripts.scripts){let i=[];for(let s of e.inputs){let r=this.expandMacro(s.pvName);i.push(this.display.pvEngine.createPV(r))}this.pvs.push(...i),e.embedded?this.display.pvEngine.createScript(this,e,e.text,i):fetch(this.display.resolvePath(e.path),{credentials:"same-origin"}).then(s=>{s.ok&&s.text().then(r=>{this.display.pvEngine.createScript(this,e,r,i)})})}for(let e of this.rules.rules)this.properties.getProperty(e.propertyName)?this.display.pvEngine.createRule(this,e):console.warn(`Cannot create rule for unsupported property ${e.propertyName}`);this.actions.isClickable()&&(this.holderRegion={id:`${this.wuid}-holder`},this.tooltip&&(this.holderRegion.tooltip=()=>this.tooltip),this.actions.isClickable()&&(this.holderRegion.click=()=>{for(let e of this.getHookedActions())this.executeAction(e)},this.holderRegion.cursor="pointer")),await this.init()}getHookedActions(){let{actions:t}=this,e=[];for(let i=0;i<t.actions.length;i++)i===0?(t.hookFirstActionToClick||t.hookAllActionsToClick)&&e.push(t.actions[i]):t.hookAllActionsToClick&&e.push(t.actions[i]);return e}drawHolder(t){let{scale:e}=this,i=[0,0,0,0],s=this.borderAlarmSensitive&&(this.pv?.severity==="MINOR"||this.pv?.severity==="MAJOR");if(!s)switch(this.borderStyle){case 0:break;case 1:i=[this.borderWidth,this.borderWidth,this.borderWidth,this.borderWidth];break;case 2:case 3:i=[1*e,1*e,1*e,1*e];break;case 4:case 5:case 6:i=[2*e,2*e,2*e,2*e];break;case 7:i=[2*e,2*e,1*e,1*e];break;case 8:case 9:case 10:case 11:i=[this.borderWidth,this.borderWidth,this.borderWidth,this.borderWidth];break;case 12:i=[17*e,1*e,1*e,1*e];break;case 13:i=[16*e,16*e,16*e,16*e];break;case 14:let r=this.borderWidth*2;i=[r,r,r,r];break}this.x=this.holderX+i[1],this.y=this.holderY+i[0],this.width=this.holderWidth-i[1]-i[3],this.height=this.holderHeight-i[0]-i[2],s||(this.beforeDrawBorder(t),this.drawBorderStyle(t)),this.holderRegion&&t.addHitRegion(this.holderRegion).addRect(this.holderX,this.holderY,this.holderWidth,this.holderHeight)}beforeDrawBorder(t){}drawBorderStyle(t){let{scale:e}=this;if(this.borderStyle!==0)if(this.borderStyle===1)t.strokeRect({x:this.holderX,y:this.holderY,width:this.holderWidth,height:this.holderHeight,color:this.borderColor,lineWidth:this.borderWidth,crispen:!0});else if(this.borderStyle===2){let i=1*e,s=this.holderY+i/2,r=this.holderX+i/2,o=this.holderY+this.holderHeight-i+i/2,a=this.holderX+this.holderWidth-i+i/2;t.strokePath({color:f.BLACK,path:new S(a,o).lineTo(a,s).moveTo(a,o).lineTo(r,o)}),t.strokePath({color:f.WHITE,path:new S(r,s).lineTo(a-i,s).moveTo(r,s).lineTo(r,o-i)})}else if(this.borderStyle===3){if(this.isAnyPvInvalid())return;let i=1*e,s=this.holderY+i/2,r=this.holderX+i/2,o=this.holderY+this.holderHeight-i+i/2,a=this.holderX+this.holderWidth-i+i/2;t.strokePath({color:f.WHITE,path:new S(a,o).lineTo(a,s).moveTo(a,o).lineTo(r,o)}),t.strokePath({color:f.BLACK,path:new S(r,s).lineTo(a-i,s).moveTo(r,s).lineTo(r,o-i)})}else if(this.borderStyle===4)this.drawShadowBorder(t,f.BUTTON_LIGHTEST,f.BUTTON_DARKER,f.BUTTON_DARKER,f.BUTTON_LIGHTEST);else if(this.borderStyle===5)this.drawShadowBorder(t,f.BUTTON_DARKER,f.BUTTON_LIGHTEST,f.BUTTON_LIGHTEST,f.BUTTON_DARKER);else if(this.borderStyle===6)this.drawShadowBorder(t,f.BUTTON_DARKEST,f.BUTTON_DARKER,f.BUTTON,f.BUTTON_LIGHTEST);else if(this.borderStyle===7)this.drawShadowBorder(t,f.BUTTON_LIGHTEST,f.BUTTON_LIGHTEST,f.BUTTON_DARKEST,f.BUTTON_DARKER);else if(this.borderStyle===8)this.drawDashedBorder(t,[2*e,2*e]);else if(this.borderStyle===9)this.drawDashedBorder(t,[6*e,2*e]);else if(this.borderStyle===10)this.drawDashedBorder(t,[6*e,2*e,2*e,2*e]);else if(this.borderStyle===11)this.drawDashedBorder(t,[6*e,2*e,2*e,2*e,2*e,2*e]);else if(this.borderStyle===12)t.fillRect({x:this.holderX,y:this.holderY+1*e,width:this.holderWidth,height:16*e,color:this.borderColor}),t.fillText({x:this.holderX+1*e+3*e,y:this.holderY+1*e+16/2*e,baseline:"middle",align:"left",font:it.ARIAL_11.scale(e),color:f.BLACK,text:this.name}),t.strokeRect({x:this.holderX,y:this.holderY,width:this.holderWidth,height:this.holderHeight,color:f.BLACK,crispen:!0});else if(this.borderStyle===13){let i=t.measureText(this.name,it.ARIAL_11.scale(e)),s=1,r=Ft(this.holderX+8*e,this.holderY+8*e,this.holderWidth-16*e-s,this.holderHeight-16*e-s,s);this.transparent||(t.fillRect(_(C({},U(r,8*e)),{color:this.backgroundColor})),t.fillRect({x:this.holderX+16*e,y:this.holderY,width:i.width,height:16*e,color:this.backgroundColor})),t.fillText({x:this.holderX+16*e,y:this.holderY+8*e,baseline:"middle",align:"left",font:it.ARIAL_11.scale(e),color:this.borderColor,text:this.name}),t.strokePath({color:this.backgroundColor.darker(),path:new S(r.x,r.y).lineTo(r.x+8*e,r.y).moveTo(r.x+8*e+i.width,r.y).lineTo(r.x+r.width,r.y).lineTo(r.x+r.width,r.y+r.height).lineTo(r.x,r.y+r.height).lineTo(r.x,r.y)}),r=Ft(this.holderX+8*e+s,this.holderY+8*e+s,this.holderWidth-16*e-s,this.holderHeight-16*e-s,s),t.strokePath({color:this.backgroundColor.brighter(),path:new S(r.x,r.y).lineTo(r.x+8*e-s,r.y).moveTo(r.x+8*e-s+i.width,r.y).lineTo(r.x+r.width,r.y).lineTo(r.x+r.width,r.y+r.height).lineTo(r.x,r.y+r.height).lineTo(r.x,r.y)})}else if(this.borderStyle===14){let i=Ft(this.holderX,this.holderY,this.holderWidth,this.holderHeight,this.borderWidth);this.fillRoundRectangleBackgroundBorder&&t.fillRect(_(C({},i),{rx:4*e,ry:4*e,color:this.backgroundColor})),this.borderWidth&&t.strokeRect(_(C({},i),{rx:4*e,ry:4*e,color:this.borderColor,lineWidth:this.borderWidth}))}else this.borderStyle===15||console.warn(`Unsupported border style: ${this.borderStyle}`)}isAnyPvDisconnected(){let t=this.pvName&&(!this.pv||this.pv.disconnected),e=this.pvs.find(i=>i.disconnected)!==void 0;return t||e}isAnyPvInvalid(){let t=!1;for(let e of this.pvs)if(e.value===void 0){t=!0;break}return this.pvs.length&&t}drawDecoration(t){if(this.display.editMode)return;let{scale:e}=this;if(this.isAnyPvDisconnected()){let i=1*e;t.fillRect({x:this.holderX-i/2,y:this.holderY-i/2,width:this.holderWidth+i,height:this.holderHeight+i,color:this.display.disconnectedColor,opacity:.4}),t.strokeRect({x:this.holderX-i/2,y:this.holderY-i/2,width:this.holderWidth+i,height:this.holderHeight+i,color:this.display.disconnectedColor})}else this.isAnyPvInvalid()&&t.strokeRect(_(C({},this.bounds),{dash:[2*e,2*e],lineWidth:2*e,color:this.display.invalidColor,crispen:!0}));if(this.borderAlarmSensitive){let i;this.borderStyle===8?i=[2*e,2*e]:this.borderStyle===9?i=[6*e,2*e]:this.borderStyle===10?i=[6*e,2*e,2*e,2*e]:this.borderStyle===11&&(i=[6*e,2*e,2*e,2*e,2*e,2*e]),this.pv?.severity==="MAJOR"?t.strokeRect(_(C({},this.bounds),{lineWidth:2*e,color:this.display.majorColor,crispen:!0,dash:i})):this.pv?.severity==="MINOR"?t.strokeRect(_(C({},this.bounds),{lineWidth:2*e,color:this.display.minorColor,crispen:!0,dash:i})):this.pv?.severity==="INVALID"&&t.strokeRect(_(C({},this.bounds),{lineWidth:2*e,color:this.display.invalidColor,crispen:!0}))}}drawOverlay(t){}drawSelection(t){t.lineWidth=1,t.strokeStyle="black",t.strokeRect(this.holderX-.5,this.holderY-.5,this.holderWidth+1,this.holderHeight+1),t.fillStyle="black";let e=2;t.fillRect(this.holderX-e,this.holderY-e,e+e,e+e),t.fillRect(this.holderX+this.holderWidth/2-e,this.holderY-e,e+e,e+e),t.fillRect(this.holderX+this.holderWidth-e,this.holderY-e,e+e,e+e),t.fillRect(this.holderX-e,this.holderY+this.holderHeight/2-e,e+e,e+e),t.fillRect(this.holderX+this.holderWidth-e,this.holderY+this.holderHeight/2-e,e+e,e+e),t.fillRect(this.holderX-e,this.holderY+this.holderHeight-e,e+e,e+e),t.fillRect(this.holderX+this.holderWidth/2-e,this.holderY+this.holderHeight-e,e+e,e+e),t.fillRect(this.holderX+this.holderWidth-e,this.holderY+this.holderHeight-e,e+e,e+e),t.strokeStyle="white",e=3,t.strokeRect(this.holderX-e+.5,this.holderY-e+.5,e+e-1,e+e-1),t.strokeRect(this.holderX+this.holderWidth/2-e+.5,this.holderY-e+.5,e+e-1,e+e-1),t.strokeRect(this.holderX+this.holderWidth-e+.5,this.holderY-e+.5,e+e-1,e+e-1),t.strokeRect(this.holderX-e+.5,this.holderY+this.holderHeight/2-e+.5,e+e-1,e+e-1),t.strokeRect(this.holderX+this.holderWidth-e+.5,this.holderY+this.holderHeight/2-e+.5,e+e-1,e+e-1),t.strokeRect(this.holderX-e+.5,this.holderY+this.holderHeight-e+.5,e+e-1,e+e-1),t.strokeRect(this.holderX+this.holderWidth/2-e+.5,this.holderY+this.holderHeight-e+.5,e+e-1,e+e-1),t.strokeRect(this.holderX+this.holderWidth-e+.5,this.holderY+this.holderHeight-e+.5,e+e-1,e+e-1)}requestRepaint(){this.display.requestRepaint()}resolvePath(t){return this.display.resolvePath(t,this)}get bounds(){return{x:this.holderX,y:this.holderY,width:this.holderWidth,height:this.holderHeight}}get unscaledBounds(){return{x:this.properties.getValue(Ce),y:this.properties.getValue(_e),width:this.properties.getValue(Ve),height:this.properties.getValue(be)}}get area(){return{x:this.x,y:this.y,width:this.width,height:this.height}}drawShadowBorder(t,e,i,s,r){let o=1*this.scale,a=this.holderY+o/2,h=this.holderX+o/2,l=this.holderY+this.holderHeight-o+o/2,d=this.holderX+this.holderWidth-o+o/2;t.strokePath({color:e,path:new S(d,l).lineTo(d,a).moveTo(d,l).lineTo(h,l)}),t.strokePath({color:i,path:new S(d-o,l-o).lineTo(d-o,a+o).moveTo(d-o,l-o).lineTo(h+o,l-o)}),t.strokePath({color:s,path:new S(h,a).lineTo(d-o,a).moveTo(h,a).lineTo(h,l-o)}),t.strokePath({color:r,path:new S(h+o,a+o).lineTo(d-o-o,a+o).moveTo(h+o,a+o).lineTo(h+o,l-o-o)})}drawDashedBorder(t,e){let i=Ft(this.holderX,this.holderY,this.holderWidth,this.holderHeight,this.borderWidth);t.strokePath({color:this.borderColor,lineWidth:this.borderWidth,dash:e,path:new S(i.x,i.y).lineTo(i.x+i.width,i.y).lineTo(i.x+i.width,i.y+i.height).lineTo(i.x,i.y+i.height).closePath()})}executeActionByIndex(t){let e=this.actions.getAction(t);e&&this.executeAction(e)}executeAction(t){t.execute(this)}expandMacro(t){if(t.indexOf("$")===-1)return t;for(let e of this.properties.all())if(e instanceof Jt){let i=this.properties.getProperty(e.pvPropertyName),s="",r=i?.value;r&&(s=this.display.getPV(r)?.value??""),t=t.replace(`$(${e.name})`,s),t=t.replace(`\${${e.name}}`,s)}else t=t.replace(`$(${e.name})`,e.value||""),t=t.replace(`\${${e.name}}`,e.value||"");return this.parent?this.parent.expandContainerMacros(t):t}loadFont(t){if(t.isWebSafe())return;let e=this.display.getFontResolver();if(!e){console.warn(`Failed to load font '${t.getFontString()}'.`);return}let i=e.resolve(t);if(!i){console.warn(`Failed to load font '${t.getFontString()}'.`);return}i.load().then(s=>{document.fonts.add(s),this.requestRepaint()}).catch(s=>{console.warn(`Failed to load font '${t.getFontString()}'.`,s)})}get pv(){if(this.pvName)return this.display.getPV(this.pvName)}isMinorSeverity(){return this.pv?.severity==="MINOR"}isMajorSeverity(){return this.pv?.severity==="MAJOR"}get alarm(){return this.pv?.severity==="MINOR"||this.pv?.severity==="MAJOR"||this.pv?.severity==="INVALID"}get alarmSensitiveBackgroundColor(){if(this.backgroundAlarmSensitive){if(this.isMajorSeverity())return this.display.majorColor;if(this.isMinorSeverity())return this.display.minorColor;if(this.pv?.severity==="INVALID")return this.display.invalidColor}return this.backgroundColor}get alarmSensitiveForegroundColor(){if(this.foregroundAlarmSensitive){if(this.isMajorSeverity())return this.display.majorColor;if(this.isMinorSeverity())return this.display.minorColor}return this.foregroundColor}get scale(){let t=this.display.scale,e=this.parent;for(;e;)t*=e.relativeScale,e=e.parent;return t}get value(){return this._value}set value(t){this._value=t,this.requestRepaint()}addPropertyListener(t,e){this.properties.getProperty(t).addListener(e)}removePropertyListener(t,e){this.properties.getProperty(t).removeListener(e)}toDataURL(t="image/png",e){let i=this.display.measureAbsoluteArea(this);return this.display.copyCanvas(i).toDataURL(t,e)}get wuid(){return this.properties.getValue(ns)}get name(){return this.properties.getValue(ts)}get holderX(){return this.scale*this.properties.getValue(Ce)}get holderY(){return this.scale*this.properties.getValue(_e)}get holderWidth(){return this.scale*this.properties.getValue(Ve)}get holderHeight(){return this.scale*this.properties.getValue(be)}get borderAlarmSensitive(){return this.properties.getValue(Yi)}get backgroundAlarmSensitive(){return this.properties.getValue(qi)}get foregroundAlarmSensitive(){return this.properties.getValue(Qi)}get pvName(){return this.properties.getValue(Te,!0)}get pvValue(){return this.properties.getValue(es,!0)}get borderColor(){return this.properties.getValue(Xi)}get borderStyle(){return this.properties.getValue(Ki)}get borderWidth(){return this.scale*this.properties.getValue(ji)}get backgroundColor(){return this.properties.getValue(Ui)}get enabled(){return this.properties.getValue(Zi)}get foregroundColor(){return this.properties.getValue(Ji)}get tooltip(){let t=this.properties.getProperty(os);if(t.rawValue)return this.expandMacro(t.rawValue)}get transparent(){return this.properties.getValue(as)}get visible(){return this.properties.getValue(hs)}get actions(){return this.properties.getValue(zi)}get scripts(){return this.properties.getValue(rs)}get rules(){return this.properties.getValue(is)}get scaleOptions(){return this.properties.getValue(ss)}get widgetType(){return this.properties.getValue(ls,!0)}get text(){return this.display.editMode?(this.properties.getProperty(Se).rawValue||"").split(" ").join("\xA0"):this.properties.getValue(Se).split(" ").join("\xA0")}init(){}hide(){}destroy(){}},ds="macros",ue=class De extends G{_widgets=[];_connections=[];relativeScale=1;constructor(e,i){super(e,i),this.properties.add(new $e(ds))}expandContainerMacros(e){for(let i in this.macros.macros)e=e.replace(`$(${i})`,this.macros.macros[i]),e=e.replace(`\${${i}}`,this.macros.macros[i]);return this.parent&&this.macros.includeParentMacros&&(e=this.parent.expandContainerMacros(e)),e}findWidget(e){for(let i of this.widgets){if(i.wuid===e)return i;if(i instanceof De){let s=i.findWidget(e);if(s)return s}}}findWidgetByName(e){for(let i of this.widgets){if(i.name===e)return i;if(i instanceof De){let s=i.findWidgetByName(e);if(s)return s}}for(let i of this.connections)if(i.name===e)return i}hide(){for(let e of this.widgets)e.hide()}destroy(){for(let e of this.widgets)e.destroy()}get widgets(){return this._widgets}get connections(){return this._connections}get macros(){return this.properties.getValue(ds)}},us="arrow_length",ps="arrows",cs="fill_arrow",gs="name",ms="line_color",fs="line_style",xs="line_width",ws="src_wuid",ys="src_term",vs="tgt_wuid",bs="tgt_term",Ts="router",Ss="points",$p="wuid",wt="LEFT",yt="UP",vt="DOWN",bt="RIGHT",Op=class extends G{sourceWidget;targetWidget;constructor(t){super(t),this.properties.clear(),this.properties.add(new b(us)),this.properties.add(new b(ps)),this.properties.add(new y(cs)),this.properties.add(new A(gs)),this.properties.add(new R(ms)),this.properties.add(new b(fs)),this.properties.add(new b(xs)),this.properties.add(new A(ws)),this.properties.add(new A(ys)),this.properties.add(new A(vs)),this.properties.add(new A(bs)),this.properties.add(new b(Ts)),this.properties.add(new ne(Ss)),this.properties.add(new A($p))}async parseNode(t){this.properties.loadXMLValues(t),this.sourceWidget=this.display.findWidget(this.sourceWuid),this.sourceWidget||console.warn(`Can't find source widget ${this.sourceWuid}`),this.targetWidget=this.display.findWidget(this.targetWuid),this.targetWidget||console.warn(`Can't find target widget ${this.targetWuid}`)}draw(t){!this.sourceWidget||!this.targetWidget||(this.points.length?this.drawPath(t):this.router===0?this.drawManhattanConnection(t):this.router===1&&this.drawDirectConnection(t))}drawPath(t){let e=this.getPosition(this.sourceWidget,this.sourceTerm),i=this.getPosition(this.targetWidget,this.targetTerm),s=[e,...this.points,i],r=S.fromPoints(s).translate(.5*this.scale,.5*this.scale);t.strokePath({path:r,lineWidth:this.lineWidth,color:this.lineColor,dash:this.getDashArray()}),this.drawStartArrow(t,s[1],s[0]),this.drawStopArrow(t,s[s.length-2],s[s.length-1])}drawManhattanConnection(t){let e=this.getManhattanAnchor(this.sourceWidget,this.sourceTerm),i=this.getManhattanAnchor(this.targetWidget,this.targetTerm),s=this.route(e,i),r=S.fromPoints(s);this.lineWidth&&t.strokePath({lineWidth:this.lineWidth,color:this.lineColor,path:r,dash:this.getDashArray()}),this.drawStartArrow(t,s[s.length-2],s[s.length-1]),this.drawStopArrow(t,s[1],s[0])}getDashArray(){let{scale:t}=this;if(this.lineWidth){if(this.lineStyle===0)return[];if(this.lineStyle===1)return[6*t,2*t];if(this.lineStyle===2)return[2*t,2*t];if(this.lineStyle===3)return[6*t,2*t,2*t,2*t];if(this.lineStyle===4)return[6*t,2*t,2*t,2*t,2*t,2*t];console.warn(`Unsupported connection line style ${this.lineStyle}`)}}drawDirectConnection(t){let e=this.getPosition(this.sourceWidget,this.sourceTerm),i=this.getPosition(this.targetWidget,this.targetTerm);this.lineWidth&&t.strokePath({path:new S(e.x,e.y).lineTo(i.x,i.y),lineWidth:this.lineWidth,color:this.lineColor,dash:this.getDashArray()}),this.drawStartArrow(t,i,e),this.drawStopArrow(t,e,i)}getManhattanAnchor(t,e){let i;switch(e){case"TOP":case"TOP_LEFT":case"TOP_RIGHT":i=yt;break;case"BOTTOM":case"BOTTOM_LEFT":case"BOTTOM_RIGHT":i=vt;break;case"LEFT":i=wt;break;case"RIGHT":i=bt;break;default:}let s=t.bounds,r=this.getPosition(t,e),o=r.x-s.x,a=s.x+s.width-r.x,h=r.y-s.y,l=s.y+s.height-r.y;return Math.min(o,a)<Math.min(h,l)?i=o<a?wt:bt:i=h<l?yt:vt,{x:r.x,y:r.y,direction:i}}getPosition(t,e){switch(e){case"LEFT":return{x:t.holderX,y:t.holderY+t.holderHeight/2};case"TOP":return{x:t.holderX+t.holderWidth/2,y:t.holderY};case"RIGHT":return{x:t.holderX+t.holderWidth,y:t.holderY+t.holderHeight/2};case"BOTTOM":return{x:t.holderX+t.holderWidth/2,y:t.holderY+t.holderHeight};case"TOP_LEFT":return{x:t.holderX,y:t.holderY};case"TOP_RIGHT":return{x:t.holderX+t.holderWidth,y:t.holderY};case"BOTTOM_LEFT":return{x:t.holderX,y:t.holderY+t.holderHeight};case"BOTTOM_RIGHT":return{x:t.holderX+t.holderWidth,y:t.holderY+t.holderHeight};default:let i=parseInt(e,10),s=t.properties.getProperty("points");if(s){let r=s.value;return r=oe(r,this.scale),r[i]}else throw Error(`Unexpected term ${e}`)}}route(t,e){let i=t.x-e.x,s=t.y-e.y,r={x:0,y:0},o,a,h=[],{tolxtol:l,tol:d,minDist:n}=this;if(i*i<l&&s*s<l)return[{x:e.x,y:e.y}];t.direction===wt?i>0&&s*s<d&&e.direction===bt?(r=e,o=e.direction):(i<0?r={x:t.x-n,y:t.y}:s>0&&e.direction===vt||s<0&&e.direction===yt?r={x:e.x,y:t.y}:t.direction===e.direction?(a=Math.min(t.x,e.x)-n,r={x:a,y:t.y}):r={x:t.x-i/2,y:t.y},s>0?o=yt:o=vt):t.direction===bt?i<0&&s*s<d&&e.direction===wt?(r=e,o=e.direction):(i>0?r={x:t.x+n,y:t.y}:s>0&&e.direction===vt||s<0&&e.direction===yt?r={x:e.x,y:t.y}:t.direction===e.direction?(a=Math.max(t.x,e.x)+n,r={x:a,y:t.y}):r={x:t.x-i/2,y:t.y},s>0?o=yt:o=vt):t.direction===vt?i*i<d&&s<0&&e.direction===yt?(r=e,o=e.direction):(s>0?r={x:t.x,y:t.y+n}:i>0&&e.direction===bt||i<0&&e.direction===wt?r={x:t.x,y:e.y}:t.direction===e.direction?(a=Math.max(t.y,e.y)+n,r={x:t.x,y:a}):r={x:t.x,y:t.y-s/2},i>0?o=wt:o=bt):t.direction===yt&&(i*i<d&&s>0&&e.direction===vt?(r=e,o=e.direction):(s<0?r={x:t.x,y:t.y-n}:i>0&&e.direction===bt||i<0&&e.direction===wt?r={x:t.x,y:e.y}:t.direction===e.direction?(a=Math.min(t.y,e.y)-n,r={x:t.x,y:a}):r={x:t.x,y:t.y-s/2},i>0?o=wt:o=bt));let p=_(C({},r),{direction:o});return h=h.concat(this.route(p,e)),h.push(t),h}drawStartArrow(t,e,i){let s=t.ctx;if(this.arrows===1||this.arrows===3){let r=this.calculateArrowPoints(e,i);if(r[2]=i,this.fillArrow){s.fillStyle=this.lineColor.toString(),s.beginPath();for(let o=0;o<r.length;o++)o===0?s.moveTo(r[o].x,r[o].y):s.lineTo(r[o].x,r[o].y);s.fill()}else s.strokeStyle=this.lineColor.toString(),s.lineWidth=this.lineWidth,s.beginPath(),s.moveTo(i.x,i.y),s.lineTo(r[0].x,r[0].y),s.moveTo(i.x,i.y),s.lineTo(r[1].x,r[1].y),s.stroke()}}drawStopArrow(t,e,i){let s=t.ctx;if(this.arrows===2||this.arrows===3){let r=this.calculateArrowPoints(e,i);if(r[2]=i,this.fillArrow){s.fillStyle=this.lineColor.toString(),s.beginPath();for(let o=0;o<r.length;o++)o===0?s.moveTo(r[o].x,r[o].y):s.lineTo(r[o].x,r[o].y);s.fill()}else s.strokeStyle=this.lineColor.toString(),s.lineWidth=this.lineWidth,s.beginPath(),s.moveTo(i.x,i.y),s.lineTo(r[0].x,r[0].y),s.moveTo(i.x,i.y),s.lineTo(r[1].x,r[1].y),s.stroke()}}calculateArrowPoints(t,e){let i=kd(e,t),s=Math.PI/10,r=new kt(this.arrowLength,i.theta-s),o=new kt(this.arrowLength,i.theta+s),a=new kt(Math.floor(this.arrowLength*Math.cos(s)),i.theta),h=Pt(r.toPoint(),e.x,e.y),l=Pt(o.toPoint(),e.x,e.y),d=Pt(a.toPoint(),e.x,e.y);return[h,l,d]}get minDist(){return this.scale*20}get tol(){return this.scale*.1}get tolxtol(){return this.scale*.01}get name(){return this.properties.getValue(gs)}get arrows(){return this.properties.getValue(ps)}get fillArrow(){return this.properties.getValue(cs)}get arrowLength(){return this.scale*this.properties.getValue(us)}get lineColor(){return this.properties.getValue(ms)}get lineStyle(){return this.properties.getValue(fs)}get lineWidth(){return this.scale*this.properties.getValue(xs)}get router(){return this.properties.getValue(Ts)}get sourceTerm(){return this.properties.getValue(ys)}get sourceWuid(){return this.properties.getValue(ws)}get targetTerm(){return this.properties.getValue(bs)}get targetWuid(){return this.properties.getValue(vs)}get points(){return oe(this.properties.getValue(Ss),this.scale)}},Gp=0,Vs="auto_scale_widgets",Gd=class extends ue{displayArgs;constructor(t,e,i){super(t,e),this.displayArgs=i??{},this.properties.add(new Hd(Vs))}async parseNode(t){await super.parseNode(t);let e=Gp++;this.macros.set("DID",`DID_${e}`);let i=this.properties.getValue("name");this.macros.set("DNAME",i);for(let s in this.displayArgs)this.macros.set(s,this.displayArgs[s]);for(let s of t.getNodes("widget")){let r=s.getString("widget_type"),o=this.display.createWidget(r,this);o&&(await o.parseNode(s),this.widgets.push(o))}for(let s of t.getNodes("connection")){let r=new Op(this.display);r.parseNode(s),this.connections.push(r)}}draw(t){for(let e of this.widgets.filter(i=>i.visible))e.drawHolder(t),e.draw(t),e.drawDecoration(t);for(let e of this.connections)e.draw(t);for(let e of this.widgets.filter(i=>i.visible))e.drawOverlay(t)}measureContentBounds(t){let e=0,i=0,s=0,r=0;for(let o of this.widgets.filter(a=>a.visible)){let a=t?o.bounds:o.unscaledBounds;e=Math.min(e,a.x),i=Math.min(i,a.y),s=Math.max(s,a.x+a.width),r=Math.max(r,a.y+a.height)}return{x:e,y:i,width:s-e,height:r-i}}get autoScaleWidgets(){return this.properties.getValue(Vs)}},zp=0,Cs="group_name",_s="opi_file",As="resize_behaviour",zd=class extends ue{linkedDisplay;resolvedOpiFile;constructor(t,e){super(t,e),this.properties.add(new A(Cs)),this.properties.add(new A(_s)),this.properties.add(new b(As,0))}async parseNode(t){await super.parseNode(t);let e=zp++;this.macros.set("LCID",`LCID_${e}`)}async init(){if(this.opiFile){this.resolvedOpiFile=this.display.resolvePath(this.opiFile);let t=await fetch(this.resolvedOpiFile,{credentials:"same-origin"});if(t.ok){let e=await t.text();this.linkedDisplay=new Gd(this.display,this);let i=Od.parseFromXML(e);await this.linkedDisplay.parseNode(i),this.requestRepaint()}}}draw(t){this.transparent||t.fillRect(_(C({},this.area),{color:this.backgroundColor}));let e=this.getLinkedWidget();if(this.linkedDisplay&&e)if(t.fillRect(_(C({},this.area),{color:this.linkedDisplay.backgroundColor})),this.resizeBehavior===0){let i=this.linkedDisplay.measureContentBounds(!1),{width:s,height:r}=i,o=this.display.scale;s*=o,r*=o;let a=s/r,h=this.width,l=h/a,d=h/s;l>this.height&&(l=this.height,h=l*a,d=l/s),this.linkedDisplay.relativeScale=d;let n=t.createChild(Math.ceil(h),Math.ceil(l));n.translate(i.x,i.y),this.linkedDisplay.draw(n),t.copy(n,this.x,this.y)}else if(this.resizeBehavior===1)console.warn("Unsupported resize behavior of LinkingContainer",this.resizeBehavior);else if(this.resizeBehavior===2){let i=this.linkedDisplay.measureContentBounds(!0),s=t.createChild(i.width,i.height);s.translate(i.x,i.y),this.linkedDisplay.draw(s),t.copy(s,this.x,this.y)}else this.resizeBehavior===3&&console.warn("Unsupported resize behavior of LinkingContainer",this.resizeBehavior)}getLinkedWidget(){return this.linkedDisplay&&this.groupName!==""?this.linkedDisplay.findWidgetByName(this.groupName):this.linkedDisplay}get widgets(){return this.linkedDisplay?this.linkedDisplay.widgets:[]}get connections(){return this.linkedDisplay?this.linkedDisplay.connections:[]}findWidget(t){if(this.linkedDisplay)return this.linkedDisplay.findWidget(t)}get opiFile(){return this.properties.getValue(_s)}get groupName(){return this.properties.getValue(Cs)}get resizeBehavior(){return this.properties.getValue(As)}},Up=class{constructor(t){this.display=t}resolve(t,e){if(t.startsWith("/"))return`${this.display.absPrefix}${t.slice(1)}`;if(t.startsWith("http://")||t.startsWith("https://"))return t;if(e){let i=e.parent;for(;i;){if(i instanceof zd){let s=i.resolvedOpiFile,r=s.lastIndexOf("/")+1;return`${s.substring(0,r)}${t}`}i=i.parent}}return`${this.display.relPrefix}${t}`}},qp=class{constructor(t,e){this.pvName=t,this.formula=e}pvValues=new Map;updateDataSource(t,e){this.pvValues.set(t,e)}clearState(){this.pvValues.clear()}getPVNames(){let t=this.formula.expression,e=[];return this.getExpressionParameters(t,e),e}getExpressionParameters(t,e){switch(t.type){case"ParameterLiteral":e.indexOf(t.value)===-1&&e.push(t.value);break;case"ConditionalExpression":this.getExpressionParameters(t.consequent,e),t.alternate&&this.getExpressionParameters(t.alternate,e);break;case"BinaryExpression":this.getExpressionParameters(t.left,e),this.getExpressionParameters(t.right,e);break;case"LogicalExpression":this.getExpressionParameters(t.left,e),this.getExpressionParameters(t.right,e);break;case"UnaryExpression":this.getExpressionParameters(t.argument,e);break;case"CallExpression":for(let i of t.arguments)this.getExpressionParameters(i,e);break}}execute(){let t=this.formula.expression;return this.executeExpression(t)}executeExpression(t){switch(t.type){case"BooleanLiteral":return t.value;case"ParameterLiteral":let e=this.pvValues.get(t.value);return e?e.value:void 0;case"ConstantLiteral":return t.value;case"NumericLiteral":return t.value;case"StringLiteral":return t.value;case"ConditionalExpression":return this.executeConditionalExpression(t);case"BinaryExpression":return this.executeBinaryExpression(t);case"LogicalExpression":return this.executeLogicalExpression(t);case"UnaryExpression":return this.executeUnaryExpression(t);case"CallExpression":return this.executeCallExpression(t);default:throw new Error("Unexpected expression type")}}executeBinaryExpression(t){let e=this.executeExpression(t.left),i=this.executeExpression(t.right);switch(t.operator){case"+":return e+i;case"-":return e-i;case"*":return e*i;case"/":return e/i;case"^":return Math.pow(e,i);case"%":return e%i;case"==":return e===i;case"!=":return e!==i;case"<=":return e<=i;case"<":return e<i;case">=":return e>=i;case">":return e>i;default:throw new Error(`Unexpected binary operator ${t.operator}`)}}executeLogicalExpression(t){let e=this.executeExpression(t.left),i=this.executeExpression(t.right);switch(t.operator){case"&&":return e&&i;case"||":return e||i;default:throw new Error(`Unexpected logical operator ${t.operator}`)}}executeConditionalExpression(t){let e=this.executeExpression(t.test),i=this.executeExpression(t.consequent);if(t.alternate===void 0)return e?i:null;{let s=this.executeExpression(t.alternate);return e?i:s}}executeUnaryExpression(t){let e=this.executeExpression(t.argument);switch(t.operator){case"-":return-e;case"+":return e;default:throw new Error(`Unexpected unary operator ${t.operator}`)}}executeCallExpression(t){let e=t.callee.name,i=[];for(let s of t.arguments)i.push(this.executeExpression(s));switch(e){case"abs":return Math.abs(i[0]);case"acos":return Math.acos(i[0]);case"asin":return Math.asin(i[0]);case"atan":return Math.atan(i[0]);case"cbrt":return Math.cbrt(i[0]);case"ceil":return Math.ceil(i[0]);case"cos":return Math.cos(i[0]);case"cosh":return Math.cosh(i[0]);case"exp":return Math.exp(i[0]);case"floor":return Math.floor(i[0]);case"log":return Math.log(i[0]);case"log10":return Math.log10(i[0]);case"round":return Math.round(i[0]);case"signum":return Math.sign(i[0]);case"sin":return Math.sin(i[0]);case"sinh":return Math.sinh(i[0]);case"sqrt":return Math.sqrt(i[0]);case"tan":return Math.tan(i[0]);case"tanh":return Math.tanh(i[0]);case"toDegrees":return i[0]*180/Math.PI;case"toRadians":return i[0]/180*Math.PI;case"parameterAcquisitionStatus":return this.callParameterAcquisitionStatus(i[0]);default:throw new Error(`Unsupported function '${e}'`)}}callParameterAcquisitionStatus(t){let e=this.pvValues.get(t);if(e)return e.acquisitionStatus}};function Yp(t,e){function i(){this.constructor=t}i.prototype=e.prototype,t.prototype=new i}function Mt(t,e,i,s){var r=Error.call(this,t);return Object.setPrototypeOf&&Object.setPrototypeOf(r,Mt.prototype),r.expected=e,r.found=i,r.location=s,r.name="SyntaxError",r}Yp(Mt,Error);function Ae(t,e,i){return i=i||" ",t.length>e?t:(e-=t.length,i+=i.repeat(e),t+i.slice(0,e))}Mt.prototype.format=function(t){var e="Error: "+this.message;if(this.location){var i=null,s;for(s=0;s<t.length;s++)if(t[s].source===this.location.source){i=t[s].text.split(/\r\n|\n|\r/g);break}var r=this.location.start,o=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(r):r,a=this.location.source+":"+o.line+":"+o.column;if(i){var h=this.location.end,l=Ae("",o.line.toString().length," "),d=i[r.line-1],n=r.line===h.line?h.column:d.length+1,p=n-r.column||1;e+=`
 --> `+a+`
`+l+` |
`+o.line+" | "+d+`
`+l+" | "+Ae("",r.column-1," ")+Ae("",p,"^")}else e+=`
 at `+a}return e};Mt.buildMessage=function(t,e){var i={literal:function(d){return'"'+r(d.text)+'"'},class:function(d){var n=d.parts.map(function(p){return Array.isArray(p)?o(p[0])+"-"+o(p[1]):o(p)});return"["+(d.inverted?"^":"")+n.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(d){return d.description}};function s(d){return d.charCodeAt(0).toString(16).toUpperCase()}function r(d){return d.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(n){return"\\x0"+s(n)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(n){return"\\x"+s(n)})}function o(d){return d.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(n){return"\\x0"+s(n)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(n){return"\\x"+s(n)})}function a(d){return i[d.type](d)}function h(d){var n=d.map(a),p,g;if(n.sort(),n.length>0){for(p=1,g=1;p<n.length;p++)n[p-1]!==n[p]&&(n[g]=n[p],g++);n.length=g}switch(n.length){case 1:return n[0];case 2:return n[0]+" or "+n[1];default:return n.slice(0,-1).join(", ")+", or "+n[n.length-1]}}function l(d){return d?'"'+r(d)+'"':"end of input"}return"Expected "+h(t)+" but "+l(e)+" found."};function Xp(t,e){e=e!==void 0?e:{};var i={},s=e.grammarSource,r={Start:ni},o=ni,a="=",h="false",l="true",d="pi",n="e",p=".",g="0",v='"',w="'",T="(",B=")",M=",",k="<=",W=">=",D="==",N="!=",j="&&",J="||",ht=/^[\t ]/,tt=/^[A-Z_a-z]/,lt=/^[a-zA-Z0-9_]/,rt=/^[0-9]/,Rt=/^[1-9]/,Gt=/^[^\n\r\f"]/,et=/^[^\n\r\f']/,nt=/^[+\-]/,gt=/^[%*\/\^]/,mt=/^[<>]/,Et=K("=",!1),St=dt(["	"," "],!1,!1),Vt=K("false",!0),ft=K("true",!0),pt=K("PI",!0),ot=K("E",!0),ct=Ct("identifier"),zt=dt([["A","Z"],"_",["a","z"]],!1,!1),Ut=dt([["a","z"],["A","Z"],["0","9"],"_"],!1,!1),qt=Ct("boolean"),Yt=Ct("constant"),jd=Ct("number"),Ue=K(".",!1),Kd=K("0",!1),Zd=dt([["0","9"]],!1,!1),Jd=dt([["1","9"]],!1,!1),Qd=Ct("string"),qe=K('"',!1),Ye=dt([`
`,"\r","\f",'"'],!0,!1),tu=Ct("parameter"),Xe=K("'",!1),je=dt([`
`,"\r","\f","'"],!0,!1),Ke=K("(",!1),Ze=K(")",!1),pe=dt(["+","-"],!1,!1),Je=K(",",!1),Qe=dt(["%","*","/","^"],!1,!1),ti=K("<=",!1),ei=K(">=",!1),ii=dt(["<",">"],!1,!1),si=K("==",!1),ri=K("!=",!1),oi=K("&&",!1),ai=K("||",!1),eu=function(u){return u},iu=function(u){return{type:"Formula",expression:u}},su=function(u){return u},ru=function(u,m){return{type:"Symbol",name:u+m.join("")}},ou=function(){return{type:"BooleanLiteral",value:!0}},au=function(){return{type:"BooleanLiteral",value:!1}},hu=function(){return{type:"ConstantLiteral",value:Math.PI}},lu=function(){return{type:"ConstantLiteral",value:Math.E}},nu=function(){return{type:"NumericLiteral",value:parseFloat(ce())}},du=function(){return{type:"NumericLiteral",value:parseFloat(ce())}},uu=function(){return{type:"NumericLiteral",value:parseFloat(ce())}},pu=function(u){return{type:"StringLiteral",value:u.join("")}},cu=function(u){return{type:"ParameterLiteral",value:u.join("")}},gu=function(u){return u},mu=function(u,m){return{type:"UnaryExpression",operator:u,argument:m}},fu=function(u,m){return{type:"CallExpression",callee:u,arguments:m}},xu=function(u){return ju(qu(u,0))},wu=function(u,m){return Yu(u,m,3)},yu=function(u,m){return ee(u,m)},vu=function(u,m){return ee(u,m)},bu=function(u,m){return ee(u,m)},Tu=function(u,m){return ee(u,m)},Su=function(u,m){return Xu(u,m)},c=e.peg$currPos|0,q=c,Wt=[{line:1,column:1}],at=c,te=e.peg$maxFailExpected||[],E=e.peg$silentFails|0,Xt;if(e.startRule){if(!(e.startRule in r))throw new Error(`Can't start parsing from rule "`+e.startRule+'".');o=r[e.startRule]}function ce(){return t.substring(q,c)}function lm(){return q}function nm(){return{source:s,start:q,end:c}}function dm(){return jt(q,c)}function um(u,m){throw m=m!==void 0?m:jt(q,c),li([Ct(u)],t.substring(q,c),m)}function pm(u,m){throw m=m!==void 0?m:jt(q,c),Cu(u,m)}function K(u,m){return{type:"literal",text:u,ignoreCase:m}}function dt(u,m,L){return{type:"class",parts:u,inverted:m,ignoreCase:L}}function cm(){return{type:"any"}}function Vu(){return{type:"end"}}function Ct(u){return{type:"other",description:u}}function hi(u){var m=Wt[u],L;if(m)return m;if(u>=Wt.length)L=Wt.length-1;else for(L=u;!Wt[--L];);for(m=Wt[L],m={line:m.line,column:m.column};L<u;)t.charCodeAt(L)===10?(m.line++,m.column=1):m.column++,L++;return Wt[u]=m,m}function jt(u,m,L){var x=hi(u),P=hi(m),V={source:s,start:{offset:u,line:x.line,column:x.column},end:{offset:m,line:P.line,column:P.column}};return L&&s&&typeof s.offset=="function"&&(V.start=s.offset(V.start),V.end=s.offset(V.end)),V}function I(u){c<at||(c>at&&(at=c,te=[]),te.push(u))}function Cu(u,m){return new Mt(u,null,null,m)}function li(u,m,L){return new Mt(Mt.buildMessage(u,m),u,m,L)}function ni(){var u,m,L,x,P;return u=c,t.charCodeAt(c)===61?(m=a,c++):(m=i,E===0&&I(Et)),m!==i?(L=z(),x=_u(),x!==i?(P=z(),q=u,u=eu(x)):(c=u,u=i)):(c=u,u=i),u}function _u(){var u,m;return u=c,m=Kt(),m!==i&&(q=u,m=iu(m)),u=m,u}function z(){var u,m;for(u=[],m=di();m!==i;)u.push(m),m=di();return u}function di(){var u;return u=t.charAt(c),ht.test(u)?c++:(u=i,E===0&&I(St)),u}function Au(){var u;return u=t.substr(c,5),u.toLowerCase()===h?c+=5:(u=i,E===0&&I(Vt)),u}function Lu(){var u;return u=t.substr(c,4),u.toLowerCase()===l?c+=4:(u=i,E===0&&I(ft)),u}function Pu(){var u;return u=t.substr(c,2),u.toLowerCase()===d?c+=2:(u=i,E===0&&I(pt)),u}function ku(){var u;return u=t.charAt(c),u.toLowerCase()===n?c++:(u=i,E===0&&I(ot)),u}function Mu(){var u,m;return u=c,m=Ru(),m!==i&&(q=u,m=su(m)),u=m,u}function Ru(){var u,m,L,x;if(E++,u=c,m=Eu(),m!==i){for(L=[],x=ui();x!==i;)L.push(x),x=ui();q=u,u=ru(m,L)}else c=u,u=i;return E--,u===i&&(m=i,E===0&&I(ct)),u}function Eu(){var u;return u=t.charAt(c),tt.test(u)?c++:(u=i,E===0&&I(zt)),u}function ui(){var u;return u=t.charAt(c),lt.test(u)?c++:(u=i,E===0&&I(Ut)),u}function Wu(){var u;return u=Bu(),u===i&&(u=Iu(),u===i&&(u=Hu(),u===i&&(u=Nu(),u===i&&(u=Fu())))),u}function Bu(){var u,m;return E++,u=c,m=Lu(),m!==i&&(q=u,m=ou()),u=m,u===i&&(u=c,m=Au(),m!==i&&(q=u,m=au()),u=m),E--,u===i&&(m=i,E===0&&I(qt)),u}function Iu(){var u,m;return E++,u=c,m=Pu(),m!==i&&(q=u,m=hu()),u=m,u===i&&(u=c,m=ku(),m!==i&&(q=u,m=lu()),u=m),E--,u===i&&(m=i,E===0&&I(Yt)),u}function Hu(){var u,m,L,x,P;if(E++,u=c,m=pi(),m!==i)if(t.charCodeAt(c)===46?(L=p,c++):(L=i,E===0&&I(Ue)),L!==i){for(x=[],P=Bt();P!==i;)x.push(P),P=Bt();q=u,u=nu()}else c=u,u=i;else c=u,u=i;if(u===i){if(u=c,t.charCodeAt(c)===46?(m=p,c++):(m=i,E===0&&I(Ue)),m!==i){if(L=[],x=Bt(),x!==i)for(;x!==i;)L.push(x),x=Bt();else L=i;L!==i?(q=u,u=du()):(c=u,u=i)}else c=u,u=i;u===i&&(u=c,m=pi(),m!==i&&(q=u,m=uu()),u=m)}return E--,u===i&&(m=i,E===0&&I(jd)),u}function pi(){var u,m,L,x;if(t.charCodeAt(c)===48?(u=g,c++):(u=i,E===0&&I(Kd)),u===i)if(u=c,m=Du(),m!==i){for(L=[],x=Bt();x!==i;)L.push(x),x=Bt();m=[m,L],u=m}else c=u,u=i;return u}function Bt(){var u;return u=t.charAt(c),rt.test(u)?c++:(u=i,E===0&&I(Zd)),u}function Du(){var u;return u=t.charAt(c),Rt.test(u)?c++:(u=i,E===0&&I(Jd)),u}function Nu(){var u,m,L,x;if(E++,u=c,t.charCodeAt(c)===34?(m=v,c++):(m=i,E===0&&I(qe)),m!==i){for(L=[],x=t.charAt(c),Gt.test(x)?c++:(x=i,E===0&&I(Ye));x!==i;)L.push(x),x=t.charAt(c),Gt.test(x)?c++:(x=i,E===0&&I(Ye));t.charCodeAt(c)===34?(x=v,c++):(x=i,E===0&&I(qe)),x!==i?(q=u,u=pu(L)):(c=u,u=i)}else c=u,u=i;return E--,u===i&&(m=i,E===0&&I(Qd)),u}function Fu(){var u,m,L,x;if(E++,u=c,t.charCodeAt(c)===39?(m=w,c++):(m=i,E===0&&I(Xe)),m!==i){for(L=[],x=t.charAt(c),et.test(x)?c++:(x=i,E===0&&I(je));x!==i;)L.push(x),x=t.charAt(c),et.test(x)?c++:(x=i,E===0&&I(je));t.charCodeAt(c)===39?(x=w,c++):(x=i,E===0&&I(Xe)),x!==i?(q=u,u=cu(L)):(c=u,u=i)}else c=u,u=i;return E--,u===i&&(m=i,E===0&&I(tu)),u}function $u(){var u,m,L,x,P,V;return u=Wu(),u===i&&(u=c,t.charCodeAt(c)===40?(m=T,c++):(m=i,E===0&&I(Ke)),m!==i?(L=z(),x=Kt(),x!==i?(P=z(),t.charCodeAt(c)===41?(V=B,c++):(V=i,E===0&&I(Ze)),V!==i?(q=u,u=gu(x)):(c=u,u=i)):(c=u,u=i)):(c=u,u=i)),u}function ci(){var u,m,L,x,P;return u=$u(),u===i&&(u=c,m=Ou(),m!==i?(L=z(),x=ci(),x!==i?(P=z(),q=u,u=mu(m,x)):(c=u,u=i)):(c=u,u=i)),u}function Ou(){var u;return u=t.charAt(c),nt.test(u)?c++:(u=i,E===0&&I(pe)),u}function ge(){var u,m,L,x;return u=c,m=Mu(),m!==i?(L=z(),x=Gu(),x!==i?(q=u,u=fu(m,x)):(c=u,u=i)):(c=u,u=i),u===i&&(u=ci()),u}function Gu(){var u,m,L,x,P,V;return u=c,t.charCodeAt(c)===40?(m=T,c++):(m=i,E===0&&I(Ke)),m!==i?(L=z(),x=c,P=zu(),P!==i?(V=z(),P=[P,V],x=P):(c=x,x=i),x===i&&(x=null),t.charCodeAt(c)===41?(P=B,c++):(P=i,E===0&&I(Ze)),P!==i?(q=u,u=xu(x)):(c=u,u=i)):(c=u,u=i),u}function zu(){var u,m,L,x,P,V,Y,F;if(u=c,m=Kt(),m!==i){for(L=[],x=c,P=z(),t.charCodeAt(c)===44?(V=M,c++):(V=i,E===0&&I(Je)),V!==i?(Y=z(),F=Kt(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);x!==i;)L.push(x),x=c,P=z(),t.charCodeAt(c)===44?(V=M,c++):(V=i,E===0&&I(Je)),V!==i?(Y=z(),F=Kt(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);q=u,u=wu(m,L)}else c=u,u=i;return u}function me(){var u,m,L,x,P,V,Y,F;if(u=c,m=ge(),m!==i){for(L=[],x=c,P=z(),V=t.charAt(c),gt.test(V)?c++:(V=i,E===0&&I(Qe)),V!==i?(Y=z(),F=ge(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);x!==i;)L.push(x),x=c,P=z(),V=t.charAt(c),gt.test(V)?c++:(V=i,E===0&&I(Qe)),V!==i?(Y=z(),F=ge(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);q=u,u=yu(m,L)}else c=u,u=i;return u}function fe(){var u,m,L,x,P,V,Y,F;if(u=c,m=me(),m!==i){for(L=[],x=c,P=z(),V=t.charAt(c),nt.test(V)?c++:(V=i,E===0&&I(pe)),V!==i?(Y=z(),F=me(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);x!==i;)L.push(x),x=c,P=z(),V=t.charAt(c),nt.test(V)?c++:(V=i,E===0&&I(pe)),V!==i?(Y=z(),F=me(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);q=u,u=vu(m,L)}else c=u,u=i;return u}function xe(){var u,m,L,x,P,V,Y,F;if(u=c,m=fe(),m!==i){for(L=[],x=c,P=z(),t.substr(c,2)===k?(V=k,c+=2):(V=i,E===0&&I(ti)),V===i&&(t.substr(c,2)===W?(V=W,c+=2):(V=i,E===0&&I(ei)),V===i&&(V=t.charAt(c),mt.test(V)?c++:(V=i,E===0&&I(ii)))),V!==i?(Y=z(),F=fe(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);x!==i;)L.push(x),x=c,P=z(),t.substr(c,2)===k?(V=k,c+=2):(V=i,E===0&&I(ti)),V===i&&(t.substr(c,2)===W?(V=W,c+=2):(V=i,E===0&&I(ei)),V===i&&(V=t.charAt(c),mt.test(V)?c++:(V=i,E===0&&I(ii)))),V!==i?(Y=z(),F=fe(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);q=u,u=bu(m,L)}else c=u,u=i;return u}function we(){var u,m,L,x,P,V,Y,F;if(u=c,m=xe(),m!==i){for(L=[],x=c,P=z(),t.substr(c,2)===D?(V=D,c+=2):(V=i,E===0&&I(si)),V===i&&(t.substr(c,2)===N?(V=N,c+=2):(V=i,E===0&&I(ri))),V!==i?(Y=z(),F=xe(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);x!==i;)L.push(x),x=c,P=z(),t.substr(c,2)===D?(V=D,c+=2):(V=i,E===0&&I(si)),V===i&&(t.substr(c,2)===N?(V=N,c+=2):(V=i,E===0&&I(ri))),V!==i?(Y=z(),F=xe(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);q=u,u=Tu(m,L)}else c=u,u=i;return u}function Kt(){var u,m,L,x,P,V,Y,F;if(u=c,m=we(),m!==i){for(L=[],x=c,P=z(),t.substr(c,2)===j?(V=j,c+=2):(V=i,E===0&&I(oi)),V===i&&(t.substr(c,2)===J?(V=J,c+=2):(V=i,E===0&&I(ai))),V!==i?(Y=z(),F=we(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);x!==i;)L.push(x),x=c,P=z(),t.substr(c,2)===j?(V=j,c+=2):(V=i,E===0&&I(oi)),V===i&&(t.substr(c,2)===J?(V=J,c+=2):(V=i,E===0&&I(ai))),V!==i?(Y=z(),F=we(),F!==i?(P=[P,V,Y,F],x=P):(c=x,x=i)):(c=x,x=i);q=u,u=Su(m,L)}else c=u,u=i;return u}function Uu(u,m){return u.map(function(L){return L[m]})}function qu(u,m){return u?u[m]:null}function Yu(u,m,L){return[u].concat(Uu(m,L))}function ee(u,m){return m.reduce(function(L,x){return{type:"BinaryExpression",operator:x[1],left:L,right:x[3]}},u)}function Xu(u,m){return m.reduce(function(L,x){return{type:"LogicalExpression",operator:x[1],left:L,right:x[3]}},u)}function ju(u){return u!==null?u:[]}if(Xt=o(),e.peg$library)return{peg$result:Xt,peg$currPos:c,peg$FAILED:i,peg$maxFailExpected:te,peg$maxFailPos:at};if(Xt!==i&&c===t.length)return Xt;throw Xt!==i&&c<t.length&&I(Vu()),li(te,at<t.length?t.charAt(at):null,at<t.length?jt(at,at+1):jt(at,at))}var jp=class{compile(t){let e=Xp(t,{});return new qp(t,e)}execute(t){return this.compile(t).execute()}},Kp=class{pvs=new Map;canProvide(t){return t.startsWith("=")}startProviding(t){for(let e of t)this.pvs.set(e.name,new Zp(e))}stopProviding(t){for(let e of t)this.pvs.delete(e.name)}isNavigable(){return!1}shutdown(){}},Zp=class{constructor(t){this.pv=t;let e=new jp;this.compiledFormula=e.compile(t.name);for(let i of this.compiledFormula.getPVNames()){let s=t.pvEngine.createPV(i);this.compiledFormula.updateDataSource(s.name,{value:s.value,acquisitionStatus:"good"}),t.pvEngine.addListener(i,()=>{this.compiledFormula.updateDataSource(i,{value:t.pvEngine.getValue(i),acquisitionStatus:"good"}),this.trigger()})}this.trigger()}compiledFormula;trigger(){let t=this.compiledFormula.execute();this.pv.pvEngine.setValue(new Date,this.pv.name,t)}};function Ud(t){return!isNaN(t)&&(Number.isInteger(parseFloat(t))||t%1!==0)}function Ls(t){return Ud(t)?parseFloat(t):(console.warn(`Not a valid float: ${t}`),t)}function Ps(t){return t!=null?String(t):t}var Jp=class extends Fd{constructor(t,e,i,s){super(t,e),this.type=i,this.initializer=s,this.writable=!0}setSample(t){if(this.type==="VDouble")t.value=Ls(t.value);else if(this.type==="VDoubleArray")for(let e=0;e<t.value.length;e++)t.value[e]=Ls(t.value);else if(this.type==="VString")t.value=Ps(t.value);else if(this.type==="VStringArray")for(let e=0;e<t.value.length;e++)t.value[e]=Ps(t.value);else typeof t.value=="string"&&Ud(t.value)&&(t.value=parseFloat(t.value));super.setSample(t)}},qd=/(loc\:\/\/[^\(<]+)(<(.*)>)?(\((.*)\))?/;function It(t){if(!t.startsWith("loc://"))return t;let e=t.match(qd);return e?e[1]:t}var Qp=class{constructor(t){this.display=t}rules=[];scripts=[];pvs=new Map;providers=[];scriptLibraries={};listeners=new Map;init(){for(let t of this.listeners.entries()){let e=this.pvs.get(t[0]);if(e&&e.value!==null&&e.value!==void 0)for(let i of t[1])i()}}clearState(){this.disconnectAll(),this.rules=[],this.scripts=[],this.listeners.clear()}getPVNames(){return[...this.pvs.keys()]}hasPV(t){let e=It(t);return this.pvs.has(e)}getPV(t){let e=It(t);return this.pvs.get(e)}disconnectAll(){for(let t of this.providers){let e=[];for(let i of this.pvs.values())t.canProvide(i.name)&&e.push(i);e.length&&t.stopProviding(e)}this.pvs.clear()}createPV(t){if(t.startsWith("loc://"))return this.createLocalPV(t);let e=this.pvs.get(t);if(e)return e;e=new Fd(t,this),this.pvs.set(t,e);let i=this.findProvider(t);return i?(e.provider=i,i.startProviding([e]),e):(console.warn(`No provider for PV ${t}`),e.disconnected=!0,e)}createHistoricalDataProvider(t,e){let i=this.findProvider(t);if(i?.createHistoricalDataProvider)return i.createHistoricalDataProvider(t,e)}findProvider(t){for(let e of this.providers)if(e.canProvide(t))return e;return null}requestRepaint(){this.display.requestRepaint()}createLocalPV(t){let e=t.match(qd),i,s;if(e){if(t=e[1],e[3])switch(e[3]){case"VDouble":case"VDoubleArray":case"VString":case"VStringArray":i=e[3];break;default:console.warn(`Unknown local PV type information: ${e[3]}`)}if(e[5]!==void 0){let a=e[5];a.startsWith('"')&&a.endsWith('"')?s=a.substring(1,a.length-1):a.indexOf(",")!==-1?s=a.split(",").map(h=>{let l=h.trim();return l.startsWith('"')&&l.endsWith('"')?l.substring(1,l.length-1):Number(l)}):s=Number(a)}}let r=this.pvs.get(t),o=!1;if(r){let a=r;a.type&&i&&a.type!==i&&console.warn(`PV ${t} is defined with different types: ${a.type} !== ${i}`),a.initializer!==void 0&&s!==void 0&&!this.initializerEquals(a.initializer,s)?console.warn(`PV ${t} is defined with different initializers: ${a.initializer} !== ${s}`):a.initializer===void 0&&s!==void 0&&(o=!0)}return r?i&&!r.type&&(r.type=i):(r=new Jp(t,this,i,s),this.pvs.set(t,r),o=!0),o&&s!==void 0&&this.setValue(new Date,t,s),r}initializerEquals(t,e){if(Array.isArray(t)&&Array.isArray(e)){if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}else return t===e}getValue(t){let e=It(t),i=this.pvs.get(e);if(i)return i.value}setValue(t,e,i,s="NONE",r=void 0){let o=e.startsWith("loc://"),a=this.findProvider(e);if(!o&&a?.writeValue)a.writeValue(e,i);else{let h=It(e),l=this.pvs.get(h);if(l){l.setSample({time:t,value:i,severity:s,units:r});for(let d of this.listeners.get(h)||[])d()}else throw new Error(`Cannot set value of unknown PV ${e}`)}}setExternalValues(t){let e=[];for(let i of t.keys()){let s=this.pvs.get(i);if(s){s.setSample(t.get(i));for(let r of this.listeners.get(i)||[])e.push(r)}else console.warn(`Received an update for unknown pv ${i}`)}for(let i of e)i()}createScript(t,e,i,s){let r=new tc(t,e,i,s);this.scripts.push(r);for(let o=0;o<e.inputs.length;o++){let a=e.inputs[o],h=s[o];if(a.trigger){let l=t.expandMacro(a.pvName);this.addListener(l,()=>{if(e.checkConnect)for(let d=0;d<e.inputs.length;d++){let n=s[d],p=e.inputs[d].trigger,g=n.value!==null&&n.value!==void 0;if(n.disconnected||p&&!g)return}r.scriptEngine.run(h)},!1)}}return r}createRule(t,e){let i=[];for(let o of e.inputs){let a=t.expandMacro(o.pvName);i.push(this.createPV(a))}let s=new ec(t,e,i);this.rules.push(s);let r=()=>s.scriptEngine.run();for(let o of e.inputs)if(o.trigger){let a=t.expandMacro(o.pvName);this.addListener(a,r,!1)}}addProvider(t){this.providers.push(t)}addScriptLibrary(t,e){this.scriptLibraries[t]=e}addListener(t,e,i=!0){let s=It(t),r=this.listeners.get(s);if(r?r.push(e):this.listeners.set(s,[e]),i){let o=this.pvs.get(s);o&&o.value!==null&&o.value!==void 0&&e()}}removeListener(t,e){let i=It(t),s=this.listeners.get(i);if(s){let r=s.indexOf(e);r!==-1&&s.splice(r,1)}}},tc=class{constructor(t,e,i,s){this.widget=t,this.script=e,this.text=i,this.pvs=s,this.scriptEngine=new he(t,i,s)}scriptEngine},ec=class{constructor(t,e,i){this.widget=t,this.rule=e;let s="",r=t.properties.getProperty(e.propertyName);if(!r)throw new Error(`Cannot create rule for unsupported property ${e.propertyName}`);if(e.expressions.length){let o=!1,a=!1,h=!1,l=!1;for(let p of e.expressions)p.expression.match(/pv[0-9]+/)&&(o=!0),e.outputExpression&&p.outputValue.toString().match(/pv[0-9]+/)&&(o=!0),p.expression.indexOf("pvInt")!==-1&&(a=!0),e.outputExpression&&p.outputValue.toString().indexOf("pvInt")!==-1&&(a=!0),p.expression.indexOf("pvStr")!==-1&&(h=!0),e.outputExpression&&p.outputValue.toString().indexOf("pvStr")!==-1&&(h=!0),p.expression.indexOf("pvSev")!==-1&&(l=!0),e.outputExpression&&p.outputValue.toString().indexOf("pvSev")!==-1&&(l=!0);for(let p=0;p<i.length;p++)o&&(s+=`var pv${p} = PVUtil.getDouble(pvs[${p}]);
`),a&&(s+=`var pvInt${p} = PVUtil.getLong(pvs[${p}]);
`),h&&(s+=`var pvStr${p} = PVUtil.getString(pvs[${p}]);
`),l&&(s+=`var pvSev${p} = PVUtil.getSeverity(pvs[${p}]);
`);for(let p=0;p<e.expressions.length;p++){let g=e.expressions[p].expression,v=e.expressions[p].outputValue;if(p>0&&(s+="else "),s+=`if (${g}) widget.setPropertyValue("${e.propertyName}", `,e.outputExpression)s+=`${v});
`;else{let w=this.printScriptValue(r,v);s+=`${w});
`}}let d=r.value,n=this.printScriptValue(r,d);s+=`else widget.setPropertyValue("${e.propertyName}", `,s+=`${n});
`}this.scriptEngine=new he(t,s,i)}scriptEngine;printScriptValue(t,e){return e==null?"null":t.printScriptValue(e)}},Ot=class{constructor(t,e,i){this.pv=t,this.interval=e,i!==void 0&&t.pvEngine.setValue(new Date,t.name,i,"NONE",t.units),this.interval>0&&(this.timer=window.setInterval(()=>{this.generateSample(new Date)},e))}timer;emit(t,e){let i="NONE";this.pv.lowerAlarmLimit!==void 0&&e<this.pv.lowerAlarmLimit||this.pv.upperAlarmLimit!==void 0&&e>this.pv.upperAlarmLimit?i="MAJOR":(this.pv.lowerWarningLimit!==void 0&&e<this.pv.lowerWarningLimit||this.pv.upperWarningLimit!==void 0&&e>this.pv.upperWarningLimit)&&(i="MINOR"),this.pv.pvEngine.setValue(t,this.pv.name,e,i,this.pv.units)}stop(){window.clearInterval(this.timer)}},Lt=class extends Ot{constructor(t,e){super(t,-1,e)}generateSample(){}},ic=class extends Ot{constructor(t,e){super(t,1e3),this.formatter=e}generateSample(t){let e=this.formatter.formatDate(t,{year:!0,month:!0,day:!0})+" "+this.formatter.formatTime(t,{hours:!0,minutes:!0,seconds:!0,milliseconds:!0});this.emit(t,e)}},ks=class extends Ot{constructor(t,e,i,s){super(t,s),this.min=e,this.max=i;let r=this.max-this.min;t.units="x",t.lowerDisplayLimit=e,t.lowerAlarmLimit=e+r*.1,t.lowerWarningLimit=e+r*.2,t.upperWarningLimit=e+r*.8,t.upperAlarmLimit=e+r*.9,t.upperDisplayLimit=i}generateSample(t){let e=Math.random()*(this.max-this.min)+this.min;this.emit(t,e)}},Ms=class extends Ot{constructor(t,e,i,s){super(t,s),this.avg=e,this.stddev=i,t.units="x",t.lowerDisplayLimit=e-4*i,t.lowerAlarmLimit=e-2*i,t.lowerWarningLimit=e-i,t.upperWarningLimit=e+i,t.upperAlarmLimit=e+2*i,t.upperDisplayLimit=e+4*i}generateSample(t){let e,i,s;do e=2*Math.random()-1,i=2*Math.random()-1,s=e*e+i*i;while(s>=1||s===0);let r=Math.sqrt(-2*Math.log(s)/s),o=e*r;this.emit(t,this.avg+o*this.stddev)}},Le=class extends Ot{constructor(t,e,i,s,r){super(t,r),this.min=e,this.max=i,this.samplesPerCycle=s;let o=this.max-this.min;t.units="x",t.lowerDisplayLimit=e,t.lowerAlarmLimit=e+o*.1,t.lowerWarningLimit=e+o*.2,t.upperWarningLimit=e+o*.8,t.upperAlarmLimit=e+o*.9,t.upperDisplayLimit=i}currentValue=0;generateSample(t){let e=this.max-this.min,i=Math.sin(this.currentValue*2*Math.PI/this.samplesPerCycle)*e/2+this.min+e/2;this.currentValue++,this.emit(t,i)}},Pe=class extends Ot{constructor(t,e,i,s,r){super(t,r),this.min=e,this.max=i,this.inc=s,s>=0?this.currentValue=e-s:this.currentValue=i-s;let o=this.max-this.min;t.units="x",t.lowerDisplayLimit=e,t.lowerAlarmLimit=e+o*.1,t.lowerWarningLimit=e+o*.2,t.upperWarningLimit=e+o*.8,t.upperAlarmLimit=e+o*.9,t.upperDisplayLimit=i}currentValue=0;generateSample(t){this.currentValue=this.currentValue+this.inc,this.currentValue>this.max&&(this.currentValue=this.min),this.currentValue<this.min&&(this.currentValue=this.max),this.emit(t,this.currentValue)}},sc=/sim\:\/\/([a-zA-Z]+)(\((.*)\))?/,rc=class{pvs=new Map;canProvide(t){return t.startsWith("sim://")}startProviding(t){for(let e of t){let i=new oc(e);this.pvs.set(e.name,i)}}stopProviding(t){for(let e of t){let i=this.pvs.get(e.name);i&&(i.fn.stop(),this.pvs.delete(e.name))}}isNavigable(){return!1}shutdown(){for(let t of this.pvs.values())t.fn.stop()}},oc=class{constructor(t){this.pv=t;let e=t.name.match(sc);if(e){let i=e[3]?e[3].split(","):[];for(let s=0;s<i.length;s++)i[s]=i[s].trim();this.fn=this.createGenerator(e[1],i)}else console.warn(`Unexpected pattern for PV ${t.name}`),this.fn=new Lt(t,void 0)}fn;createGenerator(t,e){switch(t){case"const":let i=this.saferEval(e[0]);return new Lt(this.pv,i);case"gaussianNoise":return this.createGaussianNoise(e);case"noise":return this.createNoise(e);case"ramp":return this.createRamp(e);case"sine":return this.createSine(e);default:return console.warn(`Unexpected function ${t} for PV ${this.pv.name}`),new Lt(this.pv,void 0)}}saferEval(t){return Function('"use strict";return ('+t+")")()}createNoise(t){if(t.length===0)return new ks(this.pv,-5,5,1e3);{let e=parseFloat(t[0]),i=parseFloat(t[1]),s=parseFloat(t[2])*1e3;return new ks(this.pv,e,i,s)}}createGaussianNoise(t){if(t.length===0)return new Ms(this.pv,0,1,100);{let e=parseFloat(t[0]),i=parseFloat(t[1]),s=parseFloat(t[2])*1e3;return new Ms(this.pv,e,i,s)}}createRamp(t){let e;if(t.length===0)e=new Pe(this.pv,-5,5,1,1e3);else if(t.length===3){let i=parseFloat(t[0]),s=parseFloat(t[1]),r=parseFloat(t[2])*1e3;e=new Pe(this.pv,i,s,1,r)}else if(t.length===4){let i=parseFloat(t[0]),s=parseFloat(t[1]),r=parseFloat(t[2]),o=parseFloat(t[3])*1e3;e=new Pe(this.pv,i,s,r,o)}else return console.warn(`Unexpected ramp arguments for PV ${this.pv.name}`),new Lt(this.pv,void 0);return e}createSine(t){let e;if(t.length===0)e=new Le(this.pv,-5,5,10,1e3);else if(t.length===3){let i=parseFloat(t[0]),s=parseFloat(t[1]),r=parseFloat(t[2])*1e3;e=new Le(this.pv,i,s,10,r)}else if(t.length===4){let i=parseFloat(t[0]),s=parseFloat(t[1]),r=parseFloat(t[2]),o=parseFloat(t[3])*1e3;e=new Le(this.pv,i,s,r,o)}else return console.warn(`Unexpected sine arguments for PV ${this.pv.name}`),new Lt(this.pv,void 0);return e}},ac=/sys\:\/\/([a-zA-Z]+)/,hc=class{constructor(t){this.formatter=t}pvs=new Map;canProvide(t){return t==="sys://time"}startProviding(t){for(let e of t){let i=new lc(e,this.formatter);this.pvs.set(e.name,i)}}stopProviding(t){for(let e of t){let i=this.pvs.get(e.name);i&&(i.fn.stop(),this.pvs.delete(e.name))}}isNavigable(){return!1}shutdown(){for(let t of this.pvs.values())t.fn.stop()}},lc=class{constructor(t,e){this.pv=t,this.formatter=e;let i=t.name.match(ac);i?this.fn=this.createGenerator(i[1]):(console.warn(`Unexpected pattern for PV ${t.name}`),this.fn=new Lt(t,void 0))}fn;createGenerator(t){switch(t){case"time":return new ic(this.pv,this.formatter);default:return console.warn(`Unexpected function ${t} for PV ${this.pv.name}`),new Lt(this.pv,void 0)}}},Rs="font",Es="push_action_index",Ws="release_action_index",Bs="toggle_button",Is="image",Yd=class extends G{areaRegion;pushed=!1;imageElement;imageLoaded=!1;constructor(t,e){super(t,e),this.properties.add(new O(Rs)),this.properties.add(new y(Bs)),this.properties.add(new b(Es)),this.properties.add(new b(Ws)),this.properties.add(new A(Is))}init(){this.image&&(this.imageElement=new Image,this.imageElement.onload=()=>{this.imageLoaded=!0,this.requestRepaint()},this.imageElement.src=this.resolvePath(this.image)),this.areaRegion={id:`${this.wuid}-area`,mouseDown:()=>{this.enabled&&!this.toggleButton&&(this.pushed=!0,this.requestRepaint())},mouseOut:()=>{this.enabled&&(this.pushed=!1),this.requestRepaint()},mouseUp:()=>{this.enabled&&!this.toggleButton&&(this.pushed=!1,this.requestRepaint())},click:()=>{this.enabled&&(this.executeActionByIndex(this.pushed?this.releaseActionIndex:this.pushActionIndex),this.toggleButton&&(this.pushed=!this.pushed))},tooltip:()=>this.tooltip,cursor:"pointer"}}draw(t){let e=t.ctx,{scale:i}=this;t.fillRect(_(C({},this.area),{color:this.backgroundColor})),t.addHitRegion(this.areaRegion).addRect(this.x,this.y,this.width,this.height);let s=1*i,r=this.holderY+s/2,o=this.holderX+s/2,a=this.holderY+this.holderHeight-s+s/2,h=this.holderX+this.holderWidth-s+s/2;t.strokePath({lineWidth:s,color:this.pushed?f.BUTTON_LIGHTEST:f.BLACK,path:new S(h,a).lineTo(h,r).moveTo(h,a).lineTo(o,a)}),t.strokePath({lineWidth:s,color:this.pushed?this.backgroundColor:f.BUTTON_DARKER,path:new S(h-s,a-s).lineTo(h-s,r+s).moveTo(h-s,a-s).lineTo(o+s,a-s)}),t.strokePath({lineWidth:s,color:this.pushed?f.BLACK:f.BUTTON_LIGHTEST,path:new S(o,r).lineTo(h-s,r).moveTo(o,r).lineTo(o,a-s)}),t.strokePath({lineWidth:s,color:this.pushed?f.BUTTON_DARKER:this.backgroundColor,path:new S(o+s,r+s).lineTo(h-s-s,r+s).moveTo(o+s,r+s).lineTo(o+s,a-s-s)});let l=this.text.split(`
`);e.fillStyle=this.foregroundColor.toString(),e.font=this.font.getFontString();let d,n;if(this.imageElement&&this.imageLoaded){let p=e.measureText(l[0]).width,g=this.font.height,v=this.imageElement.naturalHeight*i,w=this.imageElement.naturalWidth*i,T=(this.height-v)/g,B=(this.width-w)/p,M=5*i;if(B>T){e.textBaseline="middle",e.textAlign="left",d=this.x+(this.width-p)/2+M,n=this.y+this.height/2;let k=this.x+(this.width-p)/2-w,W=this.y+(this.height-v)/2;e.drawImage(this.imageElement,k,W,w,v)}else{e.textAlign="center",e.textBaseline="top";let k=g+v;d=this.x+this.width/2,n=this.y+(this.height-k)/2+v;let W=this.x+(this.width-w)/2,D=this.y+(this.height-k)/2;e.drawImage(this.imageElement,W,D,w,v)}this.pushed&&(d+=1*i,n+=1*i),this.enabled?(e.fillStyle=this.foregroundColor.toString(),e.fillText(l[0],d,n)):(e.fillStyle=f.BUTTON_LIGHTEST.toString(),e.fillText(l[0],d+1*i,n+1*i),e.fillStyle=f.BUTTON_DARKER.toString(),e.fillText(l[0],d,n))}else{e.textAlign="start",e.textBaseline="top";let p=0;for(let v of l){let w=e.measureText(v).width;p=Math.max(p,w)}d=this.x+(this.width-p)/2;let g=l.length*this.font.height+(l.length-1)*this.font.height*.2;n=this.y+(this.height-g)/2;for(let v of l){let w=d,T=n;this.pushed&&(w+=1*i,T+=1*i),this.enabled?(e.fillStyle=this.foregroundColor.toString(),e.fillText(v,w,T)):(e.fillStyle=f.BUTTON_LIGHTEST.toString(),e.fillText(v,w+1*i,T+1*i),e.fillStyle=f.BUTTON_DARKER.toString(),e.fillText(v,w,T)),n+=this.font.height*1.2}}}getHookedActions(){let{actions:t}=this;if(t.hookAllActionsToClick)return t.actions;if(this.pushed){let e=this.releaseActionIndex;return[t.getAction(e)]}else{let e=this.pushActionIndex;return[t.getAction(e)]}}get font(){return this.properties.getValue(Rs).scale(this.scale)}get image(){return this.properties.getValue(Is)}get toggleButton(){return this.properties.getValue(Bs)}get pushActionIndex(){return this.properties.getValue(Es)}get releaseActionIndex(){return this.properties.getValue(Ws)}get backgroundColor(){let t=this.properties.getProperty("background_color");return t&&t.value!==f.TRANSPARENT?t.value:f.BUTTON}},Hs="bit",Ds="data_type",Ns="effect_3d",Fs="font",$s="off_color",Os="off_label",Gs="off_state",zs="on_color",Us="on_label",qs="on_state",Ys="push_action_index",Xs="released_action_index",js="show_led",Ks="show_boolean_label",Zs="square_button",Js="toggle_button",nc=class extends G{hovered=!1;manualToggleState=!1;areaRegion;constructor(t,e){super(t,e),this.properties.add(new b(Hs)),this.properties.add(new b(Ds)),this.properties.add(new y(Zs)),this.properties.add(new y(js)),this.properties.add(new y(Ns)),this.properties.add(new R(zs)),this.properties.add(new A(Us)),this.properties.add(new A(qs)),this.properties.add(new R($s)),this.properties.add(new A(Os)),this.properties.add(new A(Gs)),this.properties.add(new O(Fs)),this.properties.add(new y(Js)),this.properties.add(new b(Ys)),this.properties.add(new b(Xs)),this.properties.add(new y(Ks))}init(){this.areaRegion={id:`${this.wuid}-area`,mouseDown:()=>{this.toggleButton?this.booleanValue?this.toggleOff():this.toggleOn():this.toggleOn(),this.requestRepaint()},mouseEnter:()=>{this.hovered=!0,this.requestRepaint()},mouseUp:()=>{this.booleanValue&&!this.toggleButton&&(this.toggleOff(),this.requestRepaint())},mouseOut:()=>{this.booleanValue&&!this.toggleButton&&this.toggleOff(),this.hovered=!1,this.requestRepaint()},tooltip:()=>this.tooltip,cursor:"pointer"}}toggleOn(){if(this.manualToggleState=!0,this.pv&&this.pv.writable)if(this.dataType===0)if(this.bit<0)this.display.pvEngine.setValue(new Date,this.pv.name,1);else{let t=this.pv.value|1<<this.bit;this.display.pvEngine.setValue(new Date,this.pv.name,t)}else this.display.pvEngine.setValue(new Date,this.pv.name,this.onState);this.executeActionByIndex(this.pushActionIndex)}toggleOff(){if(this.manualToggleState=!1,this.pv&&this.pv.writable)if(this.dataType===0)if(this.bit<0)this.display.pvEngine.setValue(new Date,this.pv.name,0);else{let t=this.pv.value&~(1<<this.bit);this.display.pvEngine.setValue(new Date,this.pv.name,t)}else this.display.pvEngine.setValue(new Date,this.pv.name,this.offState);this.releaseActionIndex!==void 0&&this.executeActionByIndex(this.releaseActionIndex)}get booleanValue(){return this.pv&&this.pv.value!==void 0?this.dataType===0?this.bit<0?!!this.pv?.toNumber():(this.pv?.value>>this.bit&1)>0:this.dataType===1?this.pv.toString()===this.onState:!1:this.manualToggleState}draw(t){let e=this.booleanValue;this.squareButton?this.drawSquare(t,e):this.drawEllipse(t,e),this.width>this.height?this.drawHorizontal(t,e):this.drawVertical(t,e),this.showBooleanLabel&&t.fillText({x:this.x+this.width/2,y:this.y+this.height/2,font:this.font,color:this.foregroundColor,align:"center",baseline:"middle",text:e?this.onLabel:this.offLabel})}drawSquare(t,e){t.fillRect({x:this.x,y:this.y,width:this.width,height:this.height,color:f.DARK_GRAY}),t.addHitRegion(this.areaRegion).addRect(this.x,this.y,this.width,this.height);let i=2*this.scale,s=e?f.DARK_GRAY:f.WHITE,r=e?f.WHITE:f.DARK_GRAY;this.effect3d&&(t.fillPath({color:s,path:new S(this.x,this.y).lineTo(this.x,this.y+this.height).lineTo(this.x+i,this.y+this.height-i).lineTo(this.x+i,this.y+i).lineTo(this.x+this.width-i,this.y+i).lineTo(this.x+this.width,this.y).closePath()}),t.fillPath({color:r,path:new S(this.x,this.y+this.height).lineTo(this.x+this.width,this.y+this.height).lineTo(this.x+this.width,this.y).lineTo(this.x+this.width-i,this.y+i).lineTo(this.x+this.width-i,this.y+this.height-i).lineTo(this.x+i,this.y+this.height-i).closePath()}));let o=this.backgroundColor;this.hovered&&(o=this.backgroundColor.mixWith(f.WHITE,.5)),t.fillRect({x:this.x+i,y:this.y+i,width:this.width-i-i,height:this.height-i-i,color:o})}drawEllipse(t,e){let{scale:i}=this;if(this.effect3d){let h=this.width/2,l=this.height/2,d=Math.sqrt(h*h+l*l),n=this.x+h+(l-h-d)/2-1*i,p=this.y+l-(l-h+d)/2-1*i,g=this.x+h+(l-h+d)/2+5*i,v=this.y+l-(l-h-d)/2+5*i,w=t.createLinearGradient(n,p,g,v);e?(w.addColorStop(0,f.DARK_GRAY.toString()),w.addColorStop(1,f.WHITE.toString())):(w.addColorStop(0,f.WHITE.toString()),w.addColorStop(1,f.DARK_GRAY.toString())),t.ctx.fillStyle=w}else e?t.ctx.fillStyle=f.WHITE.toString():t.ctx.fillStyle=f.DARK_GRAY.toString();let s=this.x+this.width/2,r=this.y+this.height/2,o=this.width/2,a=this.height/2;t.ctx.beginPath(),t.ctx.ellipse(s,r,o,a,0,0,2*Math.PI),t.ctx.fill(),t.addHitRegion(this.areaRegion).addEllipse(s,r,o,a,0,0,2*Math.PI),this.hovered?t.ctx.fillStyle=this.backgroundColor.mixWith(f.WHITE,.5).toString():t.ctx.fillStyle=this.backgroundColor.toString(),t.ctx.beginPath(),t.ctx.ellipse(s,r,o-i*2,a-i*2,0,0,2*Math.PI),t.ctx.fill()}drawHorizontal(t,e){let{scale:i}=this;if(this.showLed){let s;this.squareButton?(s=Math.floor(.3*(this.width+this.height)/2),s>Math.min(this.width,this.height)&&(s=Math.min(this.width,this.height)-2*i)):(s=Math.floor(.25*(this.width+this.height)/2),s>Math.min(this.width,this.height)&&(s=Math.min(this.width,this.height)-8*i));let r={x:Math.floor(this.x+this.width*.79999-s/2),y:Math.floor(this.y+this.height/2-s/2),width:s,height:s},o=r.x+r.width/2,a=r.y+r.height/2,h=r.width/2,l=r.height/2,d=e?this.onColor:this.offColor;if(t.fillEllipse({cx:o,cy:a,rx:h,ry:l,color:d}),this.effect3d){let n=t.createLinearGradient(r.x,r.y,r.x+r.width,r.y+r.height);n.addColorStop(0,"white"),n.addColorStop(1,d.withAlpha(0).toString()),t.ctx.beginPath(),t.ctx.ellipse(o,a,h,l,0,0,2*Math.PI),t.ctx.fillStyle=n,t.ctx.fill()}}}drawVertical(t,e){let{scale:i}=this;if(this.showLed){let s;this.squareButton?(s=Math.floor(.3*(this.width+this.height)/2),s>Math.min(this.width,this.height)&&(s=Math.min(this.width,this.height)-2*i)):(s=Math.floor(.25*(this.width+this.height)/2),s>Math.min(this.width,this.height)&&(s=Math.min(this.width,this.height)-8*i));let r={x:Math.floor(this.x+this.width/2-s/2),y:Math.floor(this.y+(1-.79999)*this.height-s/2),width:s,height:s},o=e?this.onColor:this.offColor,a=r.x+r.width/2,h=r.y+r.height/2,l=r.width/2,d=r.height/2;if(t.fillEllipse({cx:a,cy:h,rx:l,ry:d,color:o}),this.effect3d){let n=t.createLinearGradient(r.x,r.y,r.x+r.width,r.y+r.height);n.addColorStop(0,f.WHITE.toString()),n.addColorStop(1,o.withAlpha(0).toString()),t.ctx.beginPath(),t.ctx.ellipse(a,h,l,d,0,0,2*Math.PI),t.ctx.fillStyle=n,t.ctx.fill()}}}get bit(){return this.properties.getValue(Hs)}get dataType(){return this.properties.getValue(Ds)}get toggleButton(){return this.properties.getValue(Js)}get pushActionIndex(){return this.properties.getValue(Ys)}get releaseActionIndex(){return this.properties.getValue(Xs)}get squareButton(){return this.properties.getValue(Zs)}get showLed(){return this.properties.getValue(js)}get showBooleanLabel(){return this.properties.getValue(Ks)}get effect3d(){return this.properties.getValue(Ns)}get onColor(){return this.properties.getValue(zs)}get onLabel(){return this.properties.getValue(Us)}get onState(){return this.properties.getValue(qs)}get offColor(){return this.properties.getValue($s)}get offLabel(){return this.properties.getValue(Os)}get offState(){return this.properties.getValue(Gs)}get font(){return this.properties.getValue(Fs).scale(this.scale)}},Qs="bit",tr="data_type",er="effect_3d",ir="off_color",sr="off_label",rr="off_state",or="on_color",ar="on_label",hr="on_state",lr="push_action_index",nr="released_action_index",dr="toggle_button",dc=class extends G{manualToggleState=!1;shaftRegion;constructor(t,e){super(t,e),this.properties.add(new b(Qs)),this.properties.add(new b(tr)),this.properties.add(new y(er)),this.properties.add(new R(or)),this.properties.add(new A(ar)),this.properties.add(new A(hr)),this.properties.add(new R(ir)),this.properties.add(new A(sr)),this.properties.add(new A(rr)),this.properties.add(new b(lr)),this.properties.add(new b(nr)),this.properties.add(new y(dr))}init(){this.shaftRegion={id:`${this.wuid}-shaft`,mouseDown:()=>{this.toggleButton?this.booleanValue?this.toggleOff():this.toggleOn():this.toggleOn(),this.requestRepaint()},mouseUp:()=>{this.booleanValue&&!this.toggleButton&&(this.toggleOff(),this.requestRepaint())},mouseOut:()=>{this.booleanValue&&!this.toggleButton&&(this.toggleOff(),this.requestRepaint())},tooltip:()=>this.tooltip,cursor:"pointer"}}toggleOn(){if(this.manualToggleState=!0,this.pv&&this.pv.writable)if(this.dataType===0)if(this.bit<0)this.display.pvEngine.setValue(new Date,this.pv.name,1);else{let t=this.pv.value|1<<this.bit;this.display.pvEngine.setValue(new Date,this.pv.name,t)}else this.display.pvEngine.setValue(new Date,this.pv.name,this.onState);this.executeActionByIndex(this.pushActionIndex)}toggleOff(){if(this.manualToggleState=!1,this.pv&&this.pv.writable)if(this.dataType===0)if(this.bit<0)this.display.pvEngine.setValue(new Date,this.pv.name,0);else{let t=this.pv.value&~(1<<this.bit);this.display.pvEngine.setValue(new Date,this.pv.name,t)}else this.display.pvEngine.setValue(new Date,this.pv.name,this.offState);this.releaseActionIndex!==void 0&&this.executeActionByIndex(this.releaseActionIndex)}get booleanValue(){return this.pv&&this.pv.value!==void 0?this.dataType===0?this.bit<0?!!this.pv?.toNumber():(this.pv?.value>>this.bit&1)>0:this.dataType===1?this.pv.toString()===this.onState:!1:this.manualToggleState}draw(t){let e=this.booleanValue;this.width>this.height?this.drawHorizontal(t,e):this.drawVertical(t,e)}drawHorizontal(t,e){let i=this.width,s=this.height;s>i/2?s=Math.floor(this.width/2):i=Math.floor(2*this.height);let r={x:Math.floor(63/218*i),y:0,width:s/2,height:s/2};this.drawPedestal(t,r,e);let o=Math.floor(35/218*i),a=Math.floor(45/105*s),h=Math.floor(43/218*i),l=Math.floor(35/105*s),d=Math.floor(1/7*r.width);if(e){let n={x:2*r.x+r.width-o,y:r.height/2-a/2,width:o,height:a},p={x:r.x+r.width/2-h/2+d,y:r.y+r.height/2-l/2,width:h,height:l};this.drawHorizontalBar(t,p,n,!0)}else{let n={x:0,y:r.height/2-a/2,width:o,height:a},p={x:r.x+r.width/2-h/2-d,y:r.y+r.height/2-l/2,width:h,height:l};this.drawHorizontalBar(t,p,n,!1)}}drawVertical(t,e){let i=this.width,s=this.height;i>s/2?i=Math.floor(this.height/2):s=Math.floor(2*this.width);let r={x:0,y:Math.floor(63/218*s),width:i/2,height:i/2};this.drawPedestal(t,r,e);let o=Math.floor(45/105*i),a=Math.floor(35/218*s),h=Math.floor(35/105*i),l=Math.floor(43/218*s);if(e){let d={x:r.width/2-o/2,y:0,width:o,height:a},n={x:r.x+r.width/2-h/2,y:r.y+r.height/2-l/2,width:h,height:l};n.y-=Math.floor(1/7*r.height),this.drawVerticalBar(t,n,d,!0)}else{let d=r.y+r.height/2+l/2+2*this.scale,n={x:r.width/2-o/2,y:r.y+r.height/2-l/2+d-a,width:o,height:a},p={x:r.x+r.width/2-h/2,y:r.y+r.height/2-l/2,width:h,height:l};p.y+=Math.floor(1/7*r.height),this.drawVerticalBar(t,p,n,!1)}}drawPedestal(t,e,i){let s=this.x+e.x+e.width/2,r=this.y+e.y+e.height/2,o=e.width/2,a=e.height/2;if(t.ctx.fillStyle=this.effect3d?f.WHITE.toString():f.GRAY.toString(),t.ctx.beginPath(),t.ctx.ellipse(s,r,o,a,0,0,2*Math.PI),t.ctx.fill(),this.effect3d){let h=t.createLinearGradient(this.x+e.x,this.y+e.y,this.x+e.x+e.width,this.y+e.y+e.height);i?(h.addColorStop(0,`rgba(255,255,255,${10/255})`),h.addColorStop(1,`rgba(0,0,0,${100/255})`)):(h.addColorStop(0,"rgba(0,0,0,0)"),h.addColorStop(1,`rgba(0,0,0,${150/255})`)),t.ctx.fillStyle=h,t.ctx.fill()}}drawHorizontalBar(t,e,i,s){let r=(s?0:10)/255,o=(s?150:220)/255,a=t.createLinearGradient(this.x+i.x,this.y+i.y,this.x+i.x,this.y+i.y+i.height);a.addColorStop(0,`rgba(0,0,0,${r})`),a.addColorStop(1,`rgba(0,0,0,${o})`);let h=t.addHitRegion(this.shaftRegion),l=this.x+e.x+e.width/2,d=this.y+e.y+e.height/2,n=e.width/2,p=e.height/2;t.ctx.beginPath(),t.ctx.ellipse(l,d,n,p,0,0,2*Math.PI),h.addEllipse(l,d,n,p,0,0,2*Math.PI),t.ctx.fillStyle=s?this.onColor.toString():this.offColor.toString(),t.ctx.fill(),this.effect3d&&(t.ctx.fillStyle=a,t.ctx.fill());let g=[Math.round(this.x+i.x+i.width/2),Math.round(this.y+i.y),Math.round(this.x+i.x+i.width/2),Math.round(this.y+i.y+i.height),Math.round(this.x+e.x+e.width/2),Math.round(this.y+e.y+e.height),Math.round(this.x+e.x+e.width/2),Math.round(this.y+e.y)];if(t.ctx.beginPath(),t.ctx.moveTo(g[0],g[1]),t.ctx.lineTo(g[2],g[3]),t.ctx.lineTo(g[4],g[5]),t.ctx.lineTo(g[6],g[7]),t.ctx.closePath(),h.addPath(new S(g[0],g[1]).lineTo(g[2],g[3]).lineTo(g[4],g[5]).lineTo(g[6],g[7]).closePath()),t.ctx.fillStyle=s?this.onColor.toString():this.offColor.toString(),t.ctx.fill(),this.effect3d&&(t.ctx.fillStyle=a,t.ctx.fill()),l=this.x+i.x+i.width/2,d=this.y+i.y+i.height/2,n=i.width/2,p=i.height/2,t.ctx.beginPath(),t.ctx.ellipse(l,d,n,p,0,0,2*Math.PI),h.addEllipse(l,d,n,p,0,0,2*Math.PI),t.ctx.fillStyle=s?this.onColor.toString():this.offColor.toString(),t.ctx.fill(),this.effect3d){let{scale:v}=this,w=Math.sqrt(n*n+p*p),T=p-n,B=this.x+i.x+n+(T-w)/2-1*v,M=this.x+i.y+p-(T+w)/2-1*v,k=this.x+i.x+n+(T+w)/2+5*v,W=this.x+i.y+p-(T-w)/2+5*v,D=t.createLinearGradient(B,M,k,W);D.addColorStop(0,`rgba(0,0,0,${r})`),D.addColorStop(1,`rgba(0,0,0,${o})`),t.ctx.fillStyle=D,t.ctx.fill()}}drawVerticalBar(t,e,i,s){let r=t.createLinearGradient(this.x+i.x,this.y+i.y,this.x+i.x+i.width,this.y+i.y);r.addColorStop(0,`rgba(0,0,0,${10/255})`),r.addColorStop(1,`rgba(0,0,0,${s?210/255:160/255})`);let o=t.addHitRegion(this.shaftRegion),a=this.x+e.x+e.width/2,h=this.y+e.y+e.height/2;t.ctx.beginPath(),t.ctx.ellipse(a,h,e.width/2,e.height/2,0,0,2*Math.PI),o.addEllipse(a,h,e.width/2,e.height/2,0,0,2*Math.PI),t.ctx.fillStyle=s?this.onColor.toString():this.offColor.toString(),t.ctx.fill(),this.effect3d&&(t.ctx.fillStyle=r,t.ctx.fill());let l=[Math.round(this.x+i.x),Math.round(this.y+i.y+i.height/2),Math.round(this.x+i.x+i.width),Math.round(this.y+i.y+i.height/2),Math.round(this.x+e.x+e.width),Math.round(this.y+e.y+e.height/2),Math.round(this.x+e.x),Math.round(this.y+e.y+e.height/2)];t.ctx.beginPath(),t.ctx.moveTo(l[0],l[1]),t.ctx.lineTo(l[2],l[3]),t.ctx.lineTo(l[4],l[5]),t.ctx.lineTo(l[6],l[7]),t.ctx.closePath(),o.addPath(new S(l[0],l[1]).lineTo(l[2],l[3]).lineTo(l[4],l[5]).lineTo(l[6],l[7]).closePath()),t.ctx.fillStyle=s?this.onColor.toString():this.offColor.toString(),t.ctx.fill(),this.effect3d&&(t.ctx.fillStyle=r,t.ctx.fill()),a=this.x+i.x+i.width/2,h=this.y+i.y+i.height/2;let d=i.width/2,n=i.height/2;if(t.ctx.beginPath(),t.ctx.ellipse(a,h,d,n,0,0,2*Math.PI),o.addEllipse(a,h,d,n,0,0,2*Math.PI),t.ctx.fillStyle=s?this.onColor.toString():this.offColor.toString(),t.ctx.fill(),this.effect3d){let p=t.createLinearGradient(this.x+i.x,this.y+i.y,this.x+i.width,this.y+i.height);p.addColorStop(0,`rgba(0,0,0,${(s?5:10)/255})`),p.addColorStop(1,`rgba(0,0,0,${(s?180:160)/255})`),t.ctx.fillStyle=p,t.ctx.fill()}}get bit(){return this.properties.getValue(Qs)}get dataType(){return this.properties.getValue(tr)}get toggleButton(){return this.properties.getValue(dr)}get pushActionIndex(){return this.properties.getValue(lr)}get releaseActionIndex(){return this.properties.getValue(nr)}get effect3d(){return this.properties.getValue(er)}get onColor(){return this.properties.getValue(or)}get onLabel(){return this.properties.getValue(ar)}get onState(){return this.properties.getValue(hr)}get offColor(){return this.properties.getValue(ir)}get offLabel(){return this.properties.getValue(sr)}get offState(){return this.properties.getValue(rr)}},ur="bit",pr="enabled",cr="font",gr="label",mr="selected_color",uc=16,pc=new f(130,130,130),cc=new f(94,151,230),gc=4,mc=class extends G{hovered=!1;manualToggleState=!1;areaRegion;constructor(t,e){super(t,e),this.properties.add(new b(ur)),this.properties.add(new y(pr)),this.properties.add(new O(cr)),this.properties.add(new A(gr)),this.properties.add(new R(mr,new f(64,64,64)))}init(){this.areaRegion={id:`${this.wuid}-area`,mouseDown:()=>{this.enabled&&(this.booleanValue?this.toggleOff():this.toggleOn(),this.requestRepaint())},mouseEnter:()=>{this.hovered=!0,this.requestRepaint()},mouseOut:()=>{this.hovered=!1,this.requestRepaint()},tooltip:()=>this.tooltip,cursor:"pointer"}}toggleOn(){if(this.manualToggleState=!0,this.pv&&this.pv.writable)if(this.bit<0)this.display.pvEngine.setValue(new Date,this.pv.name,1);else{let t=this.pv.value|1<<this.bit;this.display.pvEngine.setValue(new Date,this.pv.name,t)}}toggleOff(){if(this.manualToggleState=!1,this.pv&&this.pv.writable)if(this.bit<0)this.display.pvEngine.setValue(new Date,this.pv.name,0);else{let t=this.pv.value&~(1<<this.bit);this.display.pvEngine.setValue(new Date,this.pv.name,t)}}get booleanValue(){return this.pv&&this.pv.value!==void 0?this.bit<0?!!this.pv?.toNumber():(this.pv?.value>>this.bit&1)>0:this.manualToggleState}draw(t){t.addHitRegion(this.areaRegion).addRect(this.x,this.y,this.width,this.height);let e=this.booleanValue,{boxSize:i,gap:s,scale:r}=this,o=this.backgroundColor;this.hovered&&(o=o.mixWith(cc,.7));let a={x:this.x,y:this.y+this.height/2-i/2,width:i,height:i},h=t.createLinearGradient(a.x,a.y+1*r,a.x,a.y+a.height);h.addColorStop(0,f.WHITE.toString()),h.addColorStop(1,o.toString()),t.fillRect(_(C({},a),{rx:2*r,ry:2*r,gradient:h})),t.strokeRect({x:a.x+.5*r,y:a.y+.5*r,width:a.width-1*r,height:a.height-1*r,rx:2*r,ry:2*r,color:pc}),e&&t.strokePath({lineWidth:3*r,color:this.selectedColor,path:new S(a.x+3*r,a.y+Math.floor(i*.45)).lineTo(a.x+Math.floor(i*.45),a.y+i*3/4-1*r).lineTo(a.x+i-2*r,a.y+3*r)}),this.enabled?t.fillText({x:a.x+a.width+s,y:a.y+a.height/2,align:"left",baseline:"middle",color:this.foregroundColor,font:this.font,text:this.label}):(t.fillText({x:a.x+a.width+s+1*r,y:a.y+a.height/2+1*r,align:"left",baseline:"middle",color:f.BUTTON_LIGHTEST,font:this.font,text:this.label}),t.fillText({x:a.x+a.width+s,y:a.y+a.height/2,align:"left",baseline:"middle",color:f.BUTTON_DARKER,font:this.font,text:this.label}))}get boxSize(){return this.scale*uc}get gap(){return this.scale*gc}get bit(){return this.properties.getValue(ur)}get enabled(){return this.properties.getValue(pr)}get selectedColor(){return this.properties.getValue(mr)}get font(){return this.properties.getValue(cr).scale(this.scale)}get label(){return this.properties.getValue(gr)}},fr="enabled",xr="font",wr="horizontal",yr="items",vr="items_from_pv",br="selected_color",fc=class extends G{pushedItem;itemRegions=[];constructor(t,e){super(t,e),this.properties.add(new y(fr)),this.properties.add(new O(xr)),this.properties.add(new y(wr)),this.properties.add(new de(yr,[])),this.properties.add(new y(vr)),this.properties.add(new R(br))}init(){for(let t=0;t<this.items.length;t++)this.itemRegions.push({id:`${this.wuid}-item-${t}`,cursor:"pointer",mouseDown:()=>{this.pushedItem=t,this.requestRepaint()},mouseOut:()=>{this.pushedItem=void 0,this.requestRepaint()},mouseUp:()=>{this.pushedItem=void 0,this.requestRepaint()},click:()=>{this.writeValue(this.items[t]),this.requestRepaint()},tooltip:()=>this.tooltip})}draw(t){this.horizontal?this.drawHorizontal(t):this.drawVertical(t)}drawHorizontal(t){let e=this.area.width/this.items.length,i=this.area.x;for(let s=0;s<this.items.length;s++){let r={x:i,y:this.area.y,width:e,height:this.area.height};i+=e,this.drawButton(t,r,s)}}drawVertical(t){let e=this.area.height/this.items.length,i=this.area.y;for(let s=0;s<this.items.length;s++){let r={x:Math.round(this.area.x),y:Math.round(i),width:Math.round(this.area.width),height:Math.round(e)};i+=e,this.drawButton(t,r,s)}}drawButton(t,e,i){let s=this.pv?.value===this.items[i],r=s||i===this.pushedItem;t.fillRect(_(C({},e),{color:s?this.selectedColor:this.backgroundColor})),t.addHitRegion(this.itemRegions[i]).addRect(e.x,e.y,e.width,e.height);let o=1*this.scale,a=e.y+o/2,h=e.x+o/2,l=e.y+e.height-o+o/2,d=e.x+e.width-o+o/2;t.strokePath({lineWidth:o,color:r?f.BUTTON_LIGHTEST:f.BLACK,path:new S(d,l).lineTo(d,a).moveTo(d,l).lineTo(h,l)}),t.strokePath({lineWidth:o,color:r?this.backgroundColor:f.BUTTON_DARKER,path:new S(d-o,l-o).lineTo(d-o,a+o).moveTo(d-o,l-o).lineTo(h+o,l-o)}),t.strokePath({lineWidth:o,color:r?f.BLACK:f.BUTTON_LIGHTEST,path:new S(h,a).lineTo(d-o,a).moveTo(h,a).lineTo(h,l-o)}),t.strokePath({lineWidth:o,color:r?f.BUTTON_DARKER:this.backgroundColor,path:new S(h+o,a+o).lineTo(d-o-o,a+o).moveTo(h+o,a+o).lineTo(h+o,l-o-o)}),t.fillText({x:e.x+e.width/2,y:e.y+e.height/2,text:this.items[i],align:"center",baseline:"middle",color:this.foregroundColor,font:this.font})}writeValue(t){this.pv&&this.pv.writable&&this.display.pvEngine.setValue(new Date,this.pv.name,t)}get enabled(){return this.properties.getValue(fr)}get font(){return this.properties.getValue(xr).scale(this.scale)}get horizontal(){return this.properties.getValue(wr)}get items(){return this.properties.getValue(yr)}get itemsFromPV(){return this.properties.getValue(vr)}get selectedColor(){return this.properties.getValue(br)}},Tr="enabled",Sr="font",Vr="items",Cr="items_from_pv",xc=8,wc=new f(0,0,0,.1),yc=class extends G{areaRegion;selectEl;renderedItems;constructor(t,e){super(t,e),this.properties.add(new y(Tr)),this.properties.add(new O(Sr)),this.properties.add(new de(Vr,[])),this.properties.add(new y(Cr))}init(){this.areaRegion={id:`${this.wuid}-area`,tooltip:()=>this.tooltip},this.selectEl=document.createElement("select"),this.selectEl.style.display="block",this.selectEl.style.position="absolute",this.selectEl.style.boxSizing="border-box",this.selectEl.style.opacity="0",this.selectEl.addEventListener("change",()=>{this.writeValue(this.selectEl?.value??""),this.requestRepaint()}),this.display.rootPanel.appendChild(this.selectEl)}draw(t){let e=this.display.measureAbsoluteArea(this);this.selectEl.style.display="block",this.selectEl.style.left=`${e.x}px`,this.selectEl.style.top=`${e.y}px`,this.selectEl.style.width=`${e.width}px`,this.selectEl.style.height=`${e.height}px`,this.updateSelectOptions(),e=U(this.bounds,2*this.scale),t.fillRect(_(C({},e),{color:this.backgroundColor})),t.strokeRect(_(C({},e),{color:wc,crispen:!0})),t.addHitRegion(this.areaRegion).addRect(e.x,e.y,e.width,e.height);let i=this.pv?.value??this.value;if(i){let a=this.itemsFromPV?this.pv?.labels??[]:this.items;for(let h of a){let l=h===i;if(!l)try{l=parseFloat(h)===i}catch{}l&&t.fillText({x:5*this.scale+e.x,y:e.y+e.height/2,align:"left",baseline:"middle",color:this.foregroundColor,font:this.font,text:i})}}let{selectorWidth:s}=this,r=Math.min(e.height,s/2),o={x:e.x+e.width-s-5*this.scale+s/2,y:e.y+(e.height-r)/2+r};t.fillPath({color:this.foregroundColor,path:new S(o.x,o.y).lineTo(o.x-r,o.y-r).lineTo(o.x+r,o.y-r).closePath()})}writeValue(t){this.pv?this.pv.writable&&this.display.pvEngine.setValue(new Date,this.pv.name,t):this.value=t}hide(){this.selectEl&&(this.selectEl.style.display="none")}updateSelectOptions(){let t=this.itemsFromPV?this.pv?.labels??[]:this.items,e=!1;if(this.renderedItems===void 0)e=!0;else if(t.length!==this.renderedItems.length)e=!0;else for(let i=0;i<t.length;i++)if(t[i]!==this.renderedItems[i]){e=!0;break}if(e){let i=this.selectEl;for(;i.firstChild;)i.removeChild(i.lastChild);let s=document.createElement("option");s.disabled=!0,s.value="",s.defaultSelected=!0,s.text=" -- select an option -- ",i.add(s);let r=this.itemsFromPV?this.pv?.labels??[]:this.items;for(let o=0;o<r.length;o++){let a=document.createElement("option");a.value=r[o],a.text=r[o],i.add(a)}this.renderedItems=r}}destroy(){this.selectEl&&(this.display.rootPanel.removeChild(this.selectEl),this.selectEl=void 0)}get selectorWidth(){return this.scale*xc}get enabled(){return this.properties.getValue(Tr)}get font(){return this.properties.getValue(Sr).scale(this.scale)}get items(){return this.properties.getValue(Vr)}get itemsFromPV(){return this.properties.getValue(Cr)}},_r="bit",Ar="data_type",Lr="effect_3d",Pr="font",kr="off_image",Mr="off_label",Rr="off_state",Er="on_image",Wr="on_label",Br="on_state",Ir="push_action_index",Hr="released_action_index",Dr="show_boolean_label",Nr="toggle_button",vc=class extends G{onImageElement;onImageLoaded=!1;offImageElement;offImageLoaded=!1;manualToggleState=!1;areaRegion;constructor(t,e){super(t,e),this.properties.add(new b(_r)),this.properties.add(new b(Ar)),this.properties.add(new y(Lr)),this.properties.add(new A(Er)),this.properties.add(new A(Wr)),this.properties.add(new A(Br)),this.properties.add(new A(kr)),this.properties.add(new A(Mr)),this.properties.add(new A(Rr)),this.properties.add(new O(Pr)),this.properties.add(new y(Nr)),this.properties.add(new b(Ir)),this.properties.add(new b(Hr)),this.properties.add(new y(Dr))}init(){this.onImageElement=new Image,this.onImageElement.onload=()=>{this.onImageLoaded=!0,this.requestRepaint()},this.offImageElement=new Image,this.offImageElement.onload=()=>{this.offImageLoaded=!0,this.requestRepaint()},this.onImage&&(this.onImageElement.src=this.resolvePath(this.onImage)),this.offImage&&(this.offImageElement.src=this.resolvePath(this.offImage)),this.areaRegion={id:`${this.wuid}-area`,mouseDown:()=>{this.toggleButton?this.booleanValue?this.toggleOff():this.toggleOn():this.toggleOn(),this.requestRepaint()},mouseUp:()=>{this.booleanValue&&!this.toggleButton&&(this.toggleOff(),this.requestRepaint())},mouseOut:()=>{this.booleanValue&&!this.toggleButton&&(this.toggleOff(),this.requestRepaint())},tooltip:()=>this.tooltip,cursor:"pointer"}}toggleOn(){if(this.manualToggleState=!0,this.pv&&this.pv.writable)if(this.dataType===0)if(this.bit<0)this.display.pvEngine.setValue(new Date,this.pv.name,1);else{let t=this.pv.value|1<<this.bit;this.display.pvEngine.setValue(new Date,this.pv.name,t)}else this.display.pvEngine.setValue(new Date,this.pv.name,this.onState);this.executeActionByIndex(this.pushActionIndex)}toggleOff(){if(this.manualToggleState=!1,this.pv&&this.pv.writable)if(this.dataType===0)if(this.bit<0)this.display.pvEngine.setValue(new Date,this.pv.name,0);else{let t=this.pv.value&~(1<<this.bit);this.display.pvEngine.setValue(new Date,this.pv.name,t)}else this.display.pvEngine.setValue(new Date,this.pv.name,this.offState);this.releaseActionIndex!==void 0&&this.executeActionByIndex(this.releaseActionIndex)}get booleanValue(){return this.pv&&this.pv.value!==void 0?this.dataType===0?this.bit<0?!!this.pv?.toNumber():(this.pv?.value>>this.bit&1)>0:this.dataType===1?this.pv.toString()===this.onState:!1:this.manualToggleState}draw(t){let e=this.bounds;this.borderAlarmSensitive&&(e=U(e,2*this.scale,2*this.scale));let i=this.booleanValue;i?this.onImageLoaded&&t.ctx.drawImage(this.onImageElement,e.x,e.y,e.width,e.height):this.offImageLoaded&&t.ctx.drawImage(this.offImageElement,e.x,e.y,e.width,e.height),t.addHitRegion(this.areaRegion).addRect(e.x,e.y,e.width,e.height),this.showBooleanLabel&&t.fillText({x:this.x+this.width/2,y:this.y+this.height/2,font:this.font,color:this.foregroundColor,align:"center",baseline:"middle",text:i?this.onLabel:this.offLabel})}get bit(){return this.properties.getValue(_r)}get dataType(){return this.properties.getValue(Ar)}get toggleButton(){return this.properties.getValue(Nr)}get pushActionIndex(){return this.properties.getValue(Ir)}get releaseActionIndex(){return this.properties.getValue(Hr)}get showBooleanLabel(){return this.properties.getValue(Dr)}get effect3d(){return this.properties.getValue(Lr)}get onImage(){return this.properties.getValue(Er)}get onLabel(){return this.properties.getValue(Wr)}get onState(){return this.properties.getValue(Br)}get offImage(){return this.properties.getValue(kr)}get offLabel(){return this.properties.getValue(Mr)}get offState(){return this.properties.getValue(Rr)}get font(){return this.properties.getValue(Pr).scale(this.scale)}},Fr="font",$r="label",bc=class extends G{areaRegion;selectEl;constructor(t,e){super(t,e),this.properties.add(new O(Fr)),this.properties.add(new A($r))}init(){this.areaRegion={id:`${this.wuid}-area`,tooltip:()=>this.tooltip,cursor:"pointer"},this.selectEl=document.createElement("select"),this.selectEl.style.display="block",this.selectEl.style.position="absolute",this.selectEl.style.boxSizing="border-box",this.selectEl.style.opacity="0",this.selectEl.addEventListener("change",i=>{let s=this.selectEl?.value;if(s){this.selectEl.selectedIndex=0;let r=Number(s.substring(7));this.executeActionByIndex(r)}});let t=document.createElement("option");t.disabled=!0,t.value="",t.defaultSelected=!0,t.text=" -- select an option -- ",this.selectEl.add(t);let e=this.actions.actions;for(let i=0;i<e.length;i++){let s=document.createElement("option");s.value=`action-${i}`,s.text=e[i]?.toString()??"",this.selectEl.add(s)}this.display.rootPanel.appendChild(this.selectEl)}draw(t){let e=this.display.measureAbsoluteArea(this);this.selectEl.style.display="block",this.selectEl.style.left=`${e.x}px`,this.selectEl.style.top=`${e.y}px`,this.selectEl.style.width=`${e.width}px`,this.selectEl.style.height=`${e.height}px`;let i=t.ctx;t.fillRect(_(C({},this.area),{color:this.backgroundColor})),t.addHitRegion(this.areaRegion).addRect(this.x,this.y,this.width,this.height);let s=this.label.split(`
`);i.fillStyle=this.foregroundColor.toString(),i.font=this.font.getFontString(),i.textBaseline="middle",i.textAlign="center";let r=this.x+this.width/2,o=this.y+this.height/2;i.fillText(s[0],r,o)}hide(){this.selectEl&&(this.selectEl.style.display="none")}destroy(){this.selectEl&&(this.display.rootPanel.removeChild(this.selectEl),this.selectEl=void 0)}get font(){return this.properties.getValue(Fr).scale(this.scale)}get backgroundColor(){let t=this.properties.getProperty("background_color");return t&&t.value!==f.TRANSPARENT?t.value:f.BUTTON}get label(){return this.properties.getValue($r)}},Tc=class extends Yd{},Or="enabled",Gr="font",zr="horizontal",Ur="items",qr="items_from_pv",Yr="selected_color",Sc=7,Vc=2,Cc=4,_c=new f(120,120,120),Ac=new f(94,151,230),Lc=class extends G{hoveredItem;itemRegions=[];constructor(t,e){super(t,e),this.properties.add(new y(Or)),this.properties.add(new O(Gr)),this.properties.add(new y(zr)),this.properties.add(new de(Ur,[])),this.properties.add(new y(qr)),this.properties.add(new R(Yr))}init(){for(let t=0;t<this.items.length;t++)this.itemRegions.push({id:`${this.wuid}-item-${t}`,cursor:"pointer",click:()=>{this.writeValue(this.items[t]),this.requestRepaint()},mouseEnter:()=>{this.hoveredItem=t,this.requestRepaint()},mouseOut:()=>{this.hoveredItem=void 0,this.requestRepaint()},tooltip:()=>this.tooltip})}draw(t){this.horizontal?this.drawHorizontal(t):this.drawVertical(t)}drawHorizontal(t){let e=this.area.width/this.items.length,i=this.area.x;for(let s=0;s<this.items.length;s++){let r={x:i,y:this.area.y,width:e,height:this.area.height};i+=e,this.drawRadio(t,r,s)}}drawVertical(t){let e=this.area.height/this.items.length,i=this.area.y;for(let s=0;s<this.items.length;s++){let r={x:this.area.x,y:i,width:this.area.width,height:e};i+=e,this.drawRadio(t,r,s)}}drawRadio(t,e,i){let{radioRadius:s,dotRadius:r,gap:o}=this,a=this.backgroundColor;i===this.hoveredItem&&(a=a.mixWith(Ac,.7));let h=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y+e.height);h.addColorStop(0,f.WHITE.toString()),h.addColorStop(1,a.toString()),t.fillEllipse({cx:e.x+s,cy:e.y+e.height/2,rx:s,ry:s,gradient:h});let l=1*this.scale;t.strokeEllipse({cx:e.x+s,cy:e.y+e.height/2,rx:s,ry:s,color:_c,lineWidth:l}),(this.pv?.value??this.value)===this.items[i]&&t.fillEllipse({cx:e.x+s,cy:e.y+e.height/2,rx:r+l/2,ry:r+l/2,color:this.selectedColor}),t.addHitRegion(this.itemRegions[i]).addRect(e.x,e.y,e.width,e.height),t.fillText({x:e.x+s+s+o,y:e.y+e.height/2,text:this.items[i],align:"left",baseline:"middle",color:this.foregroundColor,font:this.font})}writeValue(t){this.pv&&!this.pv.writable||(this.value=t,this.pv&&this.display.pvEngine.setValue(new Date,this.pv.name,t))}get radioRadius(){return this.scale*Sc}get dotRadius(){return this.scale*Vc}get gap(){return this.scale*Cc}get enabled(){return this.properties.getValue(Or)}get font(){return this.properties.getValue(Gr).scale(this.scale)}get horizontal(){return this.properties.getValue(zr)}get items(){return this.properties.getValue(Ur)}get itemsFromPV(){return this.properties.getValue(qr)}get selectedColor(){return this.properties.getValue(Yr)}},Xr="enabled",jr="font",Kr="maximum",Zr="minimum",Jr="horizontal",Qr="step_increment",to="page_increment",eo="bar_length",io="show_value_tip",so=new f(243,243,243),Ht=new f(232,232,231),ie=150,Pc=class extends G{decreaseRegion;decreasePressed=!1;increaseRegion;increasePressed=!1;pageDecreaseRegion;pageDecreasePressed=!1;pageIncreaseRegion;pageIncreasePressed=!1;thumbRegion;grabStartValue;dragRange;actionTimeout;constructor(t,e){super(t,e),this.properties.add(new y(Xr)),this.properties.add(new y(Jr)),this.properties.add(new y(io)),this.properties.add(new O(jr)),this.properties.add(new H(Kr)),this.properties.add(new H(Zr)),this.properties.add(new H(Qr)),this.properties.add(new H(to)),this.properties.add(new H(eo))}init(){this.decreaseRegion={id:`${this.wuid}-decrease`,mouseDown:()=>{this.decreasePressed=!0,this.stepDecreaseRepeatedly()},mouseUp:()=>{window.clearTimeout(this.actionTimeout),this.decreasePressed=!1,this.requestRepaint()},mouseOut:()=>{window.clearTimeout(this.actionTimeout),this.decreasePressed=!1,this.requestRepaint()},tooltip:()=>this.tooltip},this.increaseRegion={id:`${this.wuid}-increase`,mouseDown:()=>{this.increasePressed=!0,this.stepIncreaseRepeatedly()},mouseUp:()=>{window.clearTimeout(this.actionTimeout),this.increasePressed=!1,this.requestRepaint()},mouseOut:()=>{window.clearTimeout(this.actionTimeout),this.increasePressed=!1,this.requestRepaint()},tooltip:()=>this.tooltip},this.thumbRegion={id:`${this.wuid}-thumb`,mouseDown:()=>{this.grabStartValue=this.getCoercedValue()},grab:t=>{let e=this.horizontal?t.dx:t.dy,i=(this.maximum-this.minimum)*e/this.dragRange;this.setCoercedValue(this.grabStartValue+i),this.requestRepaint()},tooltip:()=>this.tooltip},this.pageDecreaseRegion={id:`${this.wuid}-page-decrease`,mouseDown:()=>{this.pageDecreasePressed=!0,this.pageDecreaseRepeatedly()},mouseUp:()=>{window.clearTimeout(this.actionTimeout),this.pageDecreasePressed=!1,this.requestRepaint()},mouseOut:()=>{window.clearTimeout(this.actionTimeout),this.pageDecreasePressed=!1,this.requestRepaint()},tooltip:()=>this.tooltip},this.pageIncreaseRegion={id:`${this.wuid}-page-increase`,mouseDown:()=>{this.pageIncreasePressed=!0,this.pageIncreaseRepeatedly()},mouseUp:()=>{window.clearTimeout(this.actionTimeout),this.pageIncreasePressed=!1,this.requestRepaint()},mouseOut:()=>{window.clearTimeout(this.actionTimeout),this.pageIncreasePressed=!1,this.requestRepaint()},tooltip:()=>this.tooltip}}draw(t){this.horizontal?this.drawHorizontal(t):this.drawVertical(t)}drawHorizontal(t){let{scale:e}=this,i=U(this.bounds,2*e);t.fillRect(_(C({},i),{color:so}));let s=Math.min(i.height,i.width/2);this.drawLeftButton(t,{x:i.x,y:i.y,width:s,height:i.height}),this.drawRightButton(t,{x:i.x+i.width-s,y:i.y,width:s,height:i.height});let r=this.barLength,o=this.maximum+r,a=this.minimum,h=o-a,l=h-r,d=i.width-s-s,n=Math.floor(Math.max(6*e,d*r/h));this.dragRange=d-n;let p=this.getCoercedValue(),g=Math.floor((d-n)*(p-a)/l),v=d-g-n,w={x:i.x+s+g,y:i.y,width:n,height:i.height};t.fillRect(_(C({},w),{color:Ht})),this.drawRaisedButtonBorder(t,w),t.addHitRegion(this.thumbRegion).addRect(w.x,w.y,w.width,w.height);let T={x:i.x+s,y:i.y,width:g,height:i.height};t.addHitRegion(this.pageDecreaseRegion).addRect(T.x,T.y,T.width,T.height),this.pageDecreasePressed&&t.fillRect(_(C({},T),{color:f.BLACK}));let B={x:i.x+s+g+n,y:i.y,width:v,height:i.height};t.addHitRegion(this.pageIncreaseRegion).addRect(B.x,B.y,B.width,B.height),this.pageIncreasePressed&&t.fillRect(_(C({},B),{color:f.BLACK}))}drawVertical(t){let{scale:e}=this,i=U(this.bounds,e);t.fillRect(_(C({},i),{color:so}));let s=Math.min(i.width,i.height/2);this.drawUpButton(t,{x:i.x,y:i.y,width:i.width,height:s}),this.drawDownButton(t,{x:i.x,y:i.y+i.height-s,width:i.width,height:s});let r=this.barLength,o=this.maximum+r,a=this.minimum,h=o-a,l=h-r,d=i.height-s-s,n=Math.floor(Math.max(6*e,d*r/h));this.dragRange=d-n;let p=this.getCoercedValue(),g=Math.floor((d-n)*(p-a)/l),v=d-g-n,w={x:i.x,y:i.y+s+g,width:i.width,height:n};t.fillRect(_(C({},w),{color:Ht})),this.drawRaisedButtonBorder(t,w),t.addHitRegion(this.thumbRegion).addRect(w.x,w.y,w.width,w.height);let T={x:i.x,y:i.y+s,width:i.width,height:g};t.addHitRegion(this.pageDecreaseRegion).addRect(T.x,T.y,T.width,T.height),this.pageDecreasePressed&&t.fillRect(_(C({},T),{color:f.BLACK}));let B={x:i.x,y:i.y+s+g+n,width:i.width,height:v};t.addHitRegion(this.pageIncreaseRegion).addRect(B.x,B.y,B.width,B.height),this.pageIncreasePressed&&t.fillRect(_(C({},B),{color:f.BLACK}))}drawLeftButton(t,e){t.fillRect(_(C({},e),{color:Ht})),this.decreasePressed?this.drawPressedButtonBorder(t,e):this.drawRaisedButtonBorder(t,e),t.addHitRegion(this.decreaseRegion).addRect(e.x,e.y,e.width,e.height);let i=U(e,3*this.scale),s=Math.min(i.height/2,i.width);i.x+=(i.width-s)/2,s=Math.max(s,1);let r={x:i.x,y:i.y+i.height/2};t.fillPath({color:f.BLACK,path:new S(r.x,r.y).lineTo(r.x+s,r.y-s).lineTo(r.x+s,r.y+s).closePath()})}drawRightButton(t,e){t.fillRect(_(C({},e),{color:Ht})),this.increasePressed?this.drawPressedButtonBorder(t,e):this.drawRaisedButtonBorder(t,e),t.addHitRegion(this.increaseRegion).addRect(e.x,e.y,e.width,e.height);let i=U(e,3*this.scale),s=Math.min(i.height/2,i.width);i.x+=(i.width-s)/2,s=Math.max(s,1);let r={x:i.x+s,y:i.y+i.height/2};t.fillPath({color:f.BLACK,path:new S(r.x,r.y).lineTo(r.x-s,r.y-s).lineTo(r.x-s,r.y+s).closePath()})}drawUpButton(t,e){t.fillRect(_(C({},e),{color:Ht})),this.decreasePressed?this.drawPressedButtonBorder(t,e):this.drawRaisedButtonBorder(t,e),t.addHitRegion(this.decreaseRegion).addRect(e.x,e.y,e.width,e.height);let i=U(e,3*this.scale),s=Math.min(i.height,i.width/2);i.y+=(i.height-s)/2,s=Math.max(s,1);let r={x:i.x+i.width/2,y:i.y};t.fillPath({color:f.BLACK,path:new S(r.x,r.y).lineTo(r.x-s,r.y+s).lineTo(r.x+s,r.y+s).closePath()})}drawDownButton(t,e){t.fillRect(_(C({},e),{color:Ht})),this.increasePressed?this.drawPressedButtonBorder(t,e):this.drawRaisedButtonBorder(t,e),t.addHitRegion(this.increaseRegion).addRect(e.x,e.y,e.width,e.height);let i=U(e,3*this.scale),s=Math.min(i.height,i.width/2);i.y+=(i.height-s)/2,s=Math.max(s,1);let r={x:i.x+i.width/2,y:i.y+s};t.fillPath({color:f.BLACK,path:new S(r.x,r.y).lineTo(r.x-s,r.y-s).lineTo(r.x+s,r.y-s).closePath()})}drawRaisedButtonBorder(t,e){this.drawButtonBorder(t,e,f.BUTTON_DARKEST,f.BUTTON_DARKER,f.BUTTON,f.BUTTON_LIGHTEST)}drawPressedButtonBorder(t,e){this.drawButtonBorder(t,e,f.BUTTON_LIGHTEST,f.BUTTON_LIGHTEST,f.BUTTON_DARKEST,f.BUTTON_DARKER)}drawButtonBorder(t,e,i,s,r,o){let a=1*this.scale,h=e.y+a/2,l=e.x+a/2,d=e.y+e.height-a+a/2,n=e.x+e.width-a+a/2;t.strokePath({color:i,path:new S(n,d).lineTo(n,h).moveTo(n,d).lineTo(l,d)}),t.strokePath({color:s,path:new S(n-a,d-a).lineTo(n-a,h+a).moveTo(n-a,d-a).lineTo(l+a,d-a)}),t.strokePath({color:r,path:new S(l,h).lineTo(n-a,h).moveTo(l,h).lineTo(l,d-a)}),t.strokePath({color:o,path:new S(l+a,h+a).lineTo(n-a-a,h+a).moveTo(l+a,h+a).lineTo(l+a,d-a-a)})}stepIncreaseRepeatedly(){window.clearTimeout(this.actionTimeout),this.stepIncrease(),this.requestRepaint(),this.actionTimeout=window.setTimeout(()=>this.stepIncreaseRepeatedly(),ie)}stepDecreaseRepeatedly(){window.clearTimeout(this.actionTimeout),this.stepDecrease(),this.requestRepaint(),this.actionTimeout=window.setTimeout(()=>this.stepDecreaseRepeatedly(),ie)}stepIncrease(){let t=this.pv?.value??(this.maximum-this.minimum)/2;this.setCoercedValue(t+this.stepIncrement)}stepDecrease(){let t=this.pv?.value??(this.maximum-this.minimum)/2;this.setCoercedValue(t-this.stepIncrement)}pageIncreaseRepeatedly(){window.clearTimeout(this.actionTimeout),this.pageIncrease(),this.requestRepaint(),this.actionTimeout=window.setTimeout(()=>this.pageIncreaseRepeatedly(),ie)}pageDecreaseRepeatedly(){window.clearTimeout(this.actionTimeout),this.pageDecrease(),this.requestRepaint(),this.actionTimeout=window.setTimeout(()=>this.pageDecreaseRepeatedly(),ie)}pageIncrease(){let t=this.pv?.value??(this.maximum-this.minimum)/2;this.setCoercedValue(t+this.pageIncrement)}pageDecrease(){let t=this.pv?.value??(this.maximum-this.minimum)/2;this.setCoercedValue(t-this.pageIncrement)}setCoercedValue(t){this.pv&&this.pv.writable&&(t=t<this.minimum?this.minimum:t>this.maximum?this.maximum:t,this.display.pvEngine.setValue(new Date,this.pv.name,t))}getCoercedValue(){let t=this.pv?.value??(this.maximum-this.minimum)/2;return t<this.minimum?this.minimum:t>this.maximum?this.maximum:t}destroy(){window.clearTimeout(this.actionTimeout)}get enabled(){return this.properties.getValue(Xr)}get horizontal(){return this.properties.getValue(Jr)}get showValueTip(){return this.properties.getValue(io)}get font(){return this.properties.getValue(jr).scale(this.scale)}get minimum(){return this.properties.getValue(Zr)}get maximum(){return this.properties.getValue(Kr)}get stepIncrement(){return this.properties.getValue(Qr)}get pageIncrement(){return this.properties.getValue(to)}get barLength(){return this.properties.getValue(eo)}},ro="confirm_message",oo="font",ao="format_type",ho="horizontal_alignment",lo="multiline_input",no="password_input",uo="precision",po="precision_from_pv",co="show_units",kc="text",go="vertical_alignment",Mc=class extends G{areaRegion;inputEl;editing=!1;constructor(t,e){super(t,e),this.properties.add(new A(ro)),this.properties.add(new O(oo)),this.properties.add(new b(ao)),this.properties.add(new b(ho)),this.properties.add(new y(lo)),this.properties.add(new y(no,!1)),this.properties.add(new b(uo)),this.properties.add(new y(po)),this.properties.add(new y(co,!0)),this.properties.add(new b(go,1))}init(){this.text&&(this.value=this.text),this.areaRegion={id:`${this.wuid}-area`,click:()=>{if(this.pv&&!this.pv.writable)return;this.editing=!0;let t=this.display.measureAbsoluteArea(this);if(t.x-=2*this.scale,t.y-=2*this.scale,t.width+=2*this.scale,t.height+=2*this.scale,this.inputEl.value=this.pv?.value??this.value??"",this.inputEl.style.display="block",this.inputEl.style.position="absolute",this.inputEl.style.boxSizing="border-box",this.inputEl.style.left=`${t.x}px`,this.inputEl.style.top=`${t.y}px`,this.inputEl.style.width=`${t.width}px`,this.inputEl.style.height=`${t.height}px`,this.inputEl.autocomplete="off",this.multilineInput){let e=this.inputEl;e.style.resize="none"}else{let e=this.inputEl;this.passwordInput&&(e.type="password")}this.inputEl.focus(),this.inputEl.select()},tooltip:()=>this.tooltip,cursor:"text"},this.inputEl=document.createElement(this.multilineInput?"textarea":"input"),this.inputEl.style.display="none",this.inputEl.addEventListener("keyup",t=>{if(t.key==="Enter"){if(!this.multilineInput||t.ctrlKey){let e=this.inputEl?.value||"";!this.confirmMessage||confirm(this.confirmMessage)?(this.value=e,this.pv&&this.display.pvEngine.setValue(new Date,this.pv.name,e),this.inputEl.style.display="none",this.editing=!1,this.requestRepaint()):this.cancelInput()}}else t.key==="Escape"&&this.cancelInput()}),this.inputEl.addEventListener("blur",t=>{this.pv?this.cancelInput():(this.value=this.inputEl?.value||"",this.cancelInput())}),this.display.rootPanel.appendChild(this.inputEl)}cancelInput(){this.inputEl.style.display="none",this.editing=!1,this.requestRepaint()}draw(t){if(this.editing)return;t.addHitRegion(this.areaRegion).addRect(this.x,this.y,this.width,this.height);let e=t.ctx;this.backgroundAlarmSensitive&&this.alarm?t.fillRect(_(C({},this.area),{color:this.alarmSensitiveBackgroundColor})):this.transparent||t.fillRect(_(C({},this.area),{color:this.backgroundColor}));let i=document.createElement("canvas");i.width=this.area.width,i.height=this.area.height;let s=i.getContext("2d");s.fillStyle=this.alarmSensitiveForegroundColor.toString(),s.font=this.font.getFontString();let r=this.x;this.horizAlignment===0?s.textAlign="start":this.horizAlignment===1?(r+=this.width/2,s.textAlign="center"):this.horizAlignment===2&&(r+=this.width,s.textAlign="end");let o=this.y;this.vertAlignment===0?s.textBaseline="top":this.vertAlignment===1?(o=o+this.height/2,s.textBaseline="middle"):this.vertAlignment===2&&(o=o+this.height,s.textBaseline="bottom");let a=this.text;if(this.pv&&this.pv.value!==void 0){let h=this.precisionFromPV?this.pv.precision:this.precision;h===-1&&(h=this.pv.precision??-1),a=ae(this.pv.value,this.formatType,h,this.pv.typeHint),this.showUnits&&this.pv?.units&&(a+=" "+this.pv.units)}s.fillText(a,r-this.area.x,o-this.area.y),e.drawImage(i,this.area.x,this.area.y)}hide(){this.editing=!1,this.inputEl&&(this.inputEl.style.display="none")}destroy(){this.inputEl&&(this.display.rootPanel.removeChild(this.inputEl),this.inputEl=void 0)}get value(){return this.text}set value(t){this.properties.setValue(kc,t),this.requestRepaint()}get confirmMessage(){return this.properties.getValue(ro)}get font(){return this.properties.getValue(oo).scale(this.scale)}get formatType(){return this.properties.getValue(ao)}get horizAlignment(){return this.properties.getValue(ho)}get multilineInput(){return this.properties.getValue(lo)}get passwordInput(){return this.properties.getValue(no)}get precision(){return this.properties.getValue(uo)}get precisionFromPV(){return this.properties.getValue(po)}get showUnits(){return this.properties.getValue(co)}get vertAlignment(){return this.properties.getValue(go)}},mo="alpha",fo="fill",xo="line_width",wo="line_style",yo="start_angle",vo="total_angle",Rc=class extends G{constructor(t,e){super(t,e),this.properties.add(new b(mo,255)),this.properties.add(new b(xo)),this.properties.add(new b(yo)),this.properties.add(new b(vo)),this.properties.add(new y(fo)),this.properties.add(new b(wo))}draw(t){t.ctx.globalAlpha=this.alpha/255,this.drawShape(t),t.ctx.globalAlpha=1}drawShape(t){let e=this.x+this.width/2,i=this.y+this.height/2,s=this.width/2,r=this.height/2,o=-$(this.startAngle),a=-$(this.totalAngle+this.startAngle);if(this.fill&&(t.ctx.fillStyle=this.alarmSensitiveBackgroundColor.toString(),t.ctx.beginPath(),t.ctx.moveTo(e,i),t.ctx.ellipse(e,i,s,r,0,o,a,!0),t.ctx.closePath(),t.ctx.fill()),this.lineWidth&&this.totalAngle!==0){let h,{scale:l}=this;this.lineStyle===0?h=[]:this.lineStyle===1?h=[6*l,2*l]:this.lineStyle===2?h=[2*l,2*l]:console.warn(`Unsupported arc line style ${this.lineStyle}`),t.strokeEllipse({cx:e,cy:i,rx:s,ry:r,startAngle:o,endAngle:a,lineWidth:this.lineWidth,anticlockwise:!0,color:this.alarmSensitiveForegroundColor,dash:h})}}get alpha(){return this.properties.getValue(mo)}get lineWidth(){return this.scale*this.properties.getValue(xo)}get lineStyle(){return this.properties.getValue(wo)}get startAngle(){return this.properties.getValue(yo)}get totalAngle(){return this.properties.getValue(vo)}get fill(){return this.properties.getValue(fo)}},bo="alpha",To="bg_gradient_color",So="fg_gradient_color",Vo="fill_level",Co="gradient",_o="horizontal_fill",Ao="line_color",Lo="line_width",Po="line_style",Ec=class extends G{constructor(t,e){super(t,e),this.properties.add(new b(bo,255)),this.properties.add(new R(To)),this.properties.add(new R(So)),this.properties.add(new y(Co)),this.properties.add(new b(Lo)),this.properties.add(new H(Vo)),this.properties.add(new y(_o)),this.properties.add(new R(Ao)),this.properties.add(new b(Po))}draw(t){t.ctx.globalAlpha=this.alpha/255,this.drawBackground(t),this.fillLevel&&this.drawFill(t),t.ctx.globalAlpha=1}drawBackground(t){let e=this.x+this.width/2,i=this.y+this.height/2,s=this.width/2,r=this.height/2;if(!this.transparent){let o=this.alarmSensitiveBackgroundColor;if(this.gradient){let a=this.horizontalFill?this.x:this.x+this.width,h=this.horizontalFill?this.y+this.height:this.y,l=t.createLinearGradient(this.x,this.y,a,h);l.addColorStop(0,this.backgroundGradientStartColor.toString()),l.addColorStop(1,o.toString()),t.fillEllipse({cx:e,cy:i,rx:s,ry:r,gradient:l})}else t.fillEllipse({cx:e,cy:i,rx:s,ry:r,color:o})}this.lineWidth&&(this.lineStyle===0?t.strokeEllipse({cx:e,cy:i,rx:s,ry:r,color:this.lineColor,lineWidth:this.lineWidth}):this.lineStyle===1?t.strokeEllipse({cx:e,cy:i,rx:s,ry:r,color:this.lineColor,lineWidth:this.lineWidth,dash:[6*this.scale,2*this.scale]}):console.warn(`Unsupported ellipse line style ${this.lineStyle}`))}drawFill(t){let e=U(this,this.lineWidth);if(t.ctx.save(),this.horizontalFill){let h=e.width*(this.fillLevel/100);t.ctx.beginPath(),t.ctx.rect(e.x,e.y,h,e.height)}else{let h=e.height*(this.fillLevel/100),l=e.y+e.height-h;t.ctx.beginPath(),t.ctx.rect(e.x,l,e.width,e.height)}t.ctx.clip();let i=this.x+this.width/2,s=this.y+this.height/2,r=(this.width-this.lineWidth)/2,o=(this.height-this.lineWidth)/2,a=this.alarmSensitiveForegroundColor;if(this.gradient){let h=this.horizontalFill?this.x:this.x+this.width,l=this.horizontalFill?this.y+this.height:this.y,d=t.createLinearGradient(this.x,this.y,h,l);d.addColorStop(0,this.foregroundGradientStartColor.toString()),d.addColorStop(1,a.toString()),t.fillEllipse({cx:i,cy:s,rx:r,ry:o,gradient:d})}else t.fillEllipse({cx:i,cy:s,rx:r,ry:o,color:a});t.ctx.restore()}get alpha(){return this.properties.getValue(bo)}get lineWidth(){return this.scale*this.properties.getValue(Lo)}get fillLevel(){return this.properties.getValue(Vo)}get horizontalFill(){return this.properties.getValue(_o)}get lineColor(){return this.properties.getValue(Ao)}get lineStyle(){return this.properties.getValue(Po)}get gradient(){return this.properties.getValue(Co)}get backgroundGradientStartColor(){return this.properties.getValue(To)}get foregroundGradientStartColor(){return this.properties.getValue(So)}},ko="image_file",Mo="no_animation",Ro="transparency",Wc=class extends G{currentImageFile;imageElement;imageSnapshot;imageLoading=!1;imageLoaded=!1;constructor(t,e){super(t,e),this.properties.add(new A(ko)),this.properties.add(new A(Mo)),this.properties.add(new y(Ro,!0))}init(){this.imageElement=new Image(this.width,this.height),this.imageElement.onload=()=>{this.snapshotImage(this.imageElement),this.imageLoading=!1,this.imageLoaded=!0,this.requestRepaint()},this.triggerImageLoad()}draw(t){this.imageFile&&this.currentImageFile!==this.imageFile&&this.triggerImageLoad(),this.transparency||(t.ctx.fillStyle=this.backgroundColor.toString(),t.ctx.fillRect(this.x,this.y,this.width,this.height)),this.imageLoading&&this.imageSnapshot?t.ctx.drawImage(this.imageSnapshot,this.x,this.y,this.width,this.height):this.imageLoaded&&(this.noAnimation?t.ctx.drawImage(this.imageSnapshot,this.x,this.y,this.width,this.height):t.ctx.drawImage(this.imageElement,this.x,this.y,this.width,this.height))}triggerImageLoad(){this.imageLoading=!0,this.imageLoaded=!1,this.imageElement&&this.imageFile&&(this.currentImageFile=this.imageFile,this.imageElement.src=this.resolvePath(this.imageFile))}snapshotImage(t){let e=document.createElement("canvas"),i=e.getContext("2d");e.width=t.naturalWidth,e.height=t.naturalHeight,i.drawImage(t,0,0),this.imageSnapshot=e}get transparency(){return this.properties.getValue(Ro)}get imageFile(){return this.properties.getValue(ko)}get noAnimation(){return this.properties.getValue(Mo)}},Eo="font",Wo="horizontal_alignment",Bo="vertical_alignment",Io="wrap_words",Bc=class extends G{constructor(t,e){super(t,e),this.properties.add(new O(Eo)),this.properties.add(new b(Wo)),this.properties.add(new b(Bo)),this.properties.add(new y(Io))}draw(t){this.transparent||t.fillRect({x:this.x,y:this.y,width:this.width,height:this.height,color:this.backgroundColor}),this.wrapWords?this.drawWrapped(t):this.drawText(t)}drawText(t){let e=t.ctx,i=C({},this.area),s=t.measureText(this.text,this.font,!0);e.font=this.font.getFontString(),e.textBaseline="alphabetic";let r=e.measureText(this.text).fontBoundingBoxAscent,o={x:i.x,y:i.y,width:s.width,height:s.height};this.horizAlignment===0||(this.horizAlignment===1?o.x+=(i.width-s.width)/2:this.horizAlignment===2&&(o.x+=i.width-s.width)),this.vertAlignment===0||i.height<=s.height||(this.vertAlignment===1?o.y+=i.height/2-s.height/2:this.vertAlignment===2&&(o.y+=i.height-s.height)),e.textAlign="start",e.textBaseline="top",o.y+=o.height/2-r/2,e.save(),e.beginPath();let a=this.area;e.rect(a.x,a.y,a.width,a.height),e.clip(),e.fillStyle=this.foregroundColor.toString(),e.fillText(this.text,o.x,o.y),e.restore()}drawWrapped(t){let e=t.ctx,i=this.wrapText(t,this.text,this.width);e.fillStyle=this.foregroundColor.toString(),e.font=this.font.getFontString(),e.textAlign="start",e.textBaseline="top";let s=0;for(let h of i){let l=e.measureText(h).width;s=Math.max(s,l)}let r=this.x;this.horizAlignment===1?r=this.x+(this.width-s)/2:this.horizAlignment===2&&(r=this.x+(this.width-s));let o=i.length*this.font.height+(i.length-1)*this.font.height*.2,a=this.y;this.vertAlignment===1?a+=(this.height-o)/2:this.vertAlignment===2&&(a+=this.height-o);for(let h of i)e.fillText(h,r,a),a+=this.font.height*1.2}wrapText(t,e,i){let s=[];for(let r of e.split(`
`))s=s.concat(this.wrapLine(t,r,i));return s}wrapLine(t,e,i){if(!e)return[""];let s=[],r,o,a,h=0;for(;e.length;){for(o=e.length;t.measureText(e.substr(0,o),this.font).width>i;o--);if(r=e.substr(0,o),o!==e.length)for(a=0;r.indexOf(" ",a)!==-1;a=r.indexOf(" ",a)+1);s.push(r.substr(0,a||r.length)),h=Math.max(h,t.measureText(s[s.length-1],this.font).width),e=e.substr(s[s.length-1].length,e.length)}return s}get font(){return this.properties.getValue(Eo).scale(this.scale)}get horizAlignment(){return this.properties.getValue(Wo)}get vertAlignment(){return this.properties.getValue(Bo)}get wrapWords(){return this.properties.getValue(Io)}},Ho="alpha",Do="fill_level",No="horizontal_fill",Fo="line_color",$o="line_style",Oo="line_width",Dt="points",Ic=class extends G{constructor(t,e){super(t,e),this.properties.add(new b(Ho,255)),this.properties.add(new b(Oo)),this.properties.add(new H(Do)),this.properties.add(new y(No)),this.properties.add(new R(Fo)),this.properties.add(new b($o)),this.properties.add(new ne(Dt,[]))}init(){this.addPropertyListener("x",(t,e)=>{let i=this.properties.getValue(Dt),s=re(i,t-e,0);this.properties.setValue(Dt,s),this.requestRepaint()}),this.addPropertyListener("y",(t,e)=>{let i=this.properties.getValue(Dt),s=re(i,0,t-e);this.properties.setValue(Dt,s),this.requestRepaint()})}draw(t){let{scale:e}=this;t.ctx.globalAlpha=this.alpha/255;let i=S.fromPoints(this.points).closePath();if(!this.transparent){let s=this.alarmSensitiveBackgroundColor;t.fillPath({path:i,color:s})}this.lineWidth&&(this.lineStyle===0?t.strokePath({path:i,lineWidth:this.lineWidth,color:this.lineColor}):this.lineStyle===2?t.strokePath({path:i,lineWidth:this.lineWidth,color:this.lineColor,dash:[6*e,2*e]}):console.warn(`Unsupported polygon line style ${this.lineStyle}`)),this.fillLevel&&this.drawFill(t,i),t.ctx.globalAlpha=1}drawFill(t,e){let i=this.y,s=this.width,r=this.height;this.horizontalFill?s*=this.fillLevel/100:(r*=this.fillLevel/100,i+=r),t.ctx.save();let o=this.x-this.lineWidth/2,a=i-this.lineWidth/2,h=s+this.lineWidth,l=r+this.lineWidth;t.ctx.beginPath(),t.ctx.rect(o,a,h,l),t.ctx.clip();let d=this.alarmSensitiveForegroundColor;t.fillPath({path:e,color:d}),t.ctx.restore()}get alpha(){return this.properties.getValue(Ho)}get lineWidth(){return this.scale*this.properties.getValue(Oo)}get fillLevel(){return this.properties.getValue(Do)}get horizontalFill(){return this.properties.getValue(No)}get lineColor(){return this.properties.getValue(Fo)}get lineStyle(){return this.properties.getValue($o)}get points(){return oe(this.properties.getValue(Dt),this.scale)}},Go="alpha",zo="arrows",Uo="arrow_length",qo="fill_arrow",Yo="fill_level",Xo="horizontal_fill",jo="line_width",Ko="points",Hc=class extends G{constructor(t,e){super(t,e),this.properties.add(new b(Go,255)),this.properties.add(new b(jo)),this.properties.add(new H(Yo)),this.properties.add(new y(Xo)),this.properties.add(new ne(Ko,[])),this.properties.add(new b(Uo)),this.properties.add(new y(qo)),this.properties.add(new b(zo))}draw(t){let e=t.ctx;e.globalAlpha=this.alpha/255,this.transparent&&(e.globalAlpha=0),this.drawShape(e,this.backgroundColor),this.fillLevel&&this.drawFill(e),e.globalAlpha=1}drawFill(t){let e=this.y,i=this.width,s=this.height;this.horizontalFill?i*=this.fillLevel/100:(s*=this.fillLevel/100,e+=s),t.save();let r=this.x-this.lineWidth/2,o=e-this.lineWidth/2,a=i+this.lineWidth,h=s+this.lineWidth;t.beginPath(),t.rect(r,o,a,h),t.clip(),this.drawShape(t,this.foregroundColor),t.restore()}drawShape(t,e){t.strokeStyle=e.toString(),t.lineWidth=this.lineWidth,t.beginPath();for(let i=0;i<this.points.length;i++)i===0?t.moveTo(this.points[i].x,this.points[i].y):t.lineTo(this.points[i].x,this.points[i].y);if(t.stroke(),this.points.length>=2){let i=this.points[0],s=this.points[this.points.length-1];if(this.arrows===2||this.arrows===3){let r=this.calculateArrowPoints(this.points[this.points.length-2],s);if(r[2]=s,this.fillArrow){t.fillStyle=e.toString(),t.beginPath();for(let o=0;o<r.length;o++)o===0?t.moveTo(r[o].x,r[o].y):t.lineTo(r[o].x,r[o].y);t.fill()}else t.strokeStyle=e.toString(),t.lineWidth=this.lineWidth,t.beginPath(),t.moveTo(s.x,s.y),t.lineTo(r[0].x,r[0].y),t.moveTo(s.x,s.y),t.lineTo(r[1].x,r[1].y),t.stroke()}if(this.arrows===1||this.arrows===3){let r=this.calculateArrowPoints(this.points[1],i);if(r[2]=i,this.fillArrow){t.fillStyle=e.toString(),t.beginPath();for(let o=0;o<r.length;o++)o===0?t.moveTo(r[o].x,r[o].y):t.lineTo(r[o].x,r[o].y);t.fill()}else t.strokeStyle=e.toString(),t.lineWidth=this.lineWidth,t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(r[0].x,r[0].y),t.moveTo(i.x,i.y),t.lineTo(r[1].x,r[1].y),t.stroke()}}}calculateArrowPoints(t,e){let i=kd(e,t),s=Math.PI/10,r=new kt(this.arrowLength,i.theta-s),o=new kt(this.arrowLength,i.theta+s),a=new kt(Math.floor(this.arrowLength*Math.cos(s)),i.theta),h=Pt(r.toPoint(),e.x,e.y),l=Pt(o.toPoint(),e.x,e.y),d=Pt(a.toPoint(),e.x,e.y);return[h,l,d]}get alpha(){return this.properties.getValue(Go)}get lineWidth(){return this.scale*this.properties.getValue(jo)}get fillLevel(){return this.properties.getValue(Yo)}get horizontalFill(){return this.properties.getValue(Xo)}get points(){let t=oe(this.properties.getValue(Ko),this.scale);return rp(t)}get arrows(){return this.properties.getValue(zo)}get fillArrow(){return this.properties.getValue(qo)}get arrowLength(){return this.properties.getValue(Uo)}},Zo="alpha",Jo="bg_gradient_color",Qo="fg_gradient_color",ta="fill_level",ea="gradient",ia="horizontal_fill",sa="line_color",ra="line_width",oa="line_style",Dc=class extends G{constructor(t,e){super(t,e),this.fillRoundRectangleBackgroundBorder=!1,this.properties.add(new b(Zo,255)),this.properties.add(new R(Jo)),this.properties.add(new R(Qo)),this.properties.add(new y(ea)),this.properties.add(new b(ra)),this.properties.add(new H(ta)),this.properties.add(new y(ia)),this.properties.add(new R(sa)),this.properties.add(new b(oa))}draw(t){t.ctx.globalAlpha=this.alpha/255,this.drawBackground(t),this.fillLevel&&this.drawFill(t),t.ctx.globalAlpha=1}drawBackground(t){if(!this.transparent){let e=this.alarmSensitiveBackgroundColor;if(this.gradient){let i=this.horizontalFill?this.x:this.x+this.width,s=this.horizontalFill?this.y+this.height:this.y,r=t.createLinearGradient(this.x,this.y,i,s);r.addColorStop(0,this.backgroundGradientStartColor.toString()),r.addColorStop(1,e.toString()),t.fillRect(_(C({},this.area),{gradient:r}))}else t.fillRect(_(C({},this.area),{color:e}))}this.lineWidth&&(this.lineStyle===0?t.strokeRect(_(C({},this.area),{color:this.lineColor,lineWidth:this.lineWidth,crispen:!0})):this.lineStyle===1?t.strokeRect(_(C({},this.area),{color:this.lineColor,lineWidth:this.lineWidth,crispen:!0,dash:[6*this.scale,2*this.scale]})):console.warn(`Unsupported rectangle line style ${this.lineStyle}`))}drawFill(t){let e=U(this,this.lineWidth);if(t.ctx.save(),this.horizontalFill){let s=e.width*(this.fillLevel/100);t.ctx.beginPath(),t.ctx.rect(e.x,e.y,s,e.height)}else{let s=e.height*(this.fillLevel/100),r=e.y+e.height-s;t.ctx.beginPath(),t.ctx.rect(e.x,r,e.width,e.height)}t.ctx.clip();let i=this.alarmSensitiveForegroundColor;if(this.gradient){let s=this.horizontalFill?e.x:e.x+e.width,r=this.horizontalFill?e.y+e.height:e.y,o=t.createLinearGradient(e.x,e.y,s,r);o.addColorStop(0,this.foregroundGradientStartColor.toString()),o.addColorStop(1,i.toString()),t.fillRect(_(C({},e),{gradient:o}))}else t.fillRect(_(C({},e),{color:i}));t.ctx.restore()}get alpha(){return this.properties.getValue(Zo)}get lineWidth(){return this.scale*this.properties.getValue(ra)}get fillLevel(){return this.properties.getValue(ta)}get horizontalFill(){return this.properties.getValue(ia)}get lineColor(){return this.properties.getValue(sa)}get lineStyle(){return this.properties.getValue(oa)}get gradient(){return this.properties.getValue(ea)}get backgroundGradientStartColor(){return this.properties.getValue(Jo)}get foregroundGradientStartColor(){return this.properties.getValue(Qo)}},aa="alpha",ha="bg_gradient_color",la="corner_width",na="corner_height",da="fg_gradient_color",ua="fill_level",pa="gradient",ca="horizontal_fill",ga="line_color",ma="line_width",fa="line_style",Nc=class extends G{constructor(t,e){super(t,e),this.fillRoundRectangleBackgroundBorder=!1,this.properties.add(new b(aa,255)),this.properties.add(new R(ha)),this.properties.add(new R(da)),this.properties.add(new y(pa)),this.properties.add(new b(ma)),this.properties.add(new H(ua)),this.properties.add(new y(ca)),this.properties.add(new R(ga)),this.properties.add(new b(la)),this.properties.add(new b(na)),this.properties.add(new b(fa))}draw(t){t.ctx.globalAlpha=this.alpha/255,this.drawBackground(t),this.fillLevel&&this.drawFill(t),t.ctx.globalAlpha=1}drawBackground(t){if(!this.transparent){let e=this.alarmSensitiveBackgroundColor;if(this.gradient){let i=this.horizontalFill?this.x:this.x+this.width,s=this.horizontalFill?this.y+this.height:this.y,r=t.createLinearGradient(this.x,this.y,i,s);r.addColorStop(0,this.backgroundGradientStartColor.toString()),r.addColorStop(1,e.toString()),t.fillRect(_(C({},this.area),{rx:this.cornerWidth/2,ry:this.cornerHeight/2,gradient:r}))}else t.fillRect(_(C({},this.area),{rx:this.cornerWidth/2,ry:this.cornerHeight/2,color:e}))}this.lineWidth&&(this.lineStyle===0?t.strokeRect(_(C({},this.area),{rx:this.cornerWidth/2,ry:this.cornerHeight/2,color:this.lineColor,lineWidth:this.lineWidth,crispen:!0})):this.lineStyle===1?t.strokeRect(_(C({},this.area),{rx:this.cornerWidth/2,ry:this.cornerHeight/2,color:this.lineColor,lineWidth:this.lineWidth,crispen:!0,dash:[6*this.scale,2*this.scale]})):console.warn(`Unsupported RoundedRectangle line style ${this.lineStyle}`))}drawFill(t){let e=this.cornerWidth/2,i=this.cornerHeight/2,s=U(this,this.lineWidth);if(t.ctx.save(),this.horizontalFill){let o=s.width*(this.fillLevel/100);t.ctx.beginPath(),t.ctx.rect(s.x,s.y,o,s.height)}else{let o=s.height*(this.fillLevel/100),a=s.y+s.height-o;t.ctx.beginPath(),t.ctx.rect(s.x,a,s.width,s.height)}t.ctx.clip();let r=this.alarmSensitiveForegroundColor;if(this.gradient){let o=this.horizontalFill?s.x:s.x+s.width,a=this.horizontalFill?s.y+s.height:s.y,h=t.createLinearGradient(s.x,s.y,o,a);h.addColorStop(0,this.foregroundGradientStartColor.toString()),h.addColorStop(1,r.toString()),t.fillRect(_(C({},s),{rx:e,ry:i,gradient:h}))}else t.fillRect(_(C({},s),{rx:e,ry:i,color:r}));t.ctx.restore()}get alpha(){return this.properties.getValue(aa)}get lineWidth(){return this.scale*this.properties.getValue(ma)}get fillLevel(){return this.properties.getValue(ua)}get horizontalFill(){return this.properties.getValue(ca)}get lineColor(){return this.properties.getValue(ga)}get lineStyle(){return this.properties.getValue(fa)}get gradient(){return this.properties.getValue(pa)}get cornerWidth(){return this.scale*this.properties.getValue(la)}get cornerHeight(){return this.scale*this.properties.getValue(na)}get backgroundGradientStartColor(){return this.properties.getValue(ha)}get foregroundGradientStartColor(){return this.properties.getValue(da)}},xa="bitReverse",wa="effect_3d",ya="horizontal",va="led_border",ba="led_border_color",Ta="led_packed",Sa="numBits",Va="off_color",Ca="on_color",_a="startBit",Aa="square_led",Fc=class extends G{constructor(t,e){super(t,e),this.properties.add(new y(xa)),this.properties.add(new y(wa)),this.properties.add(new y(ya)),this.properties.add(new b(Sa)),this.properties.add(new R(Va)),this.properties.add(new R(Ca)),this.properties.add(new b(_a)),this.properties.add(new y(Aa)),this.properties.add(new b(va,3)),this.properties.add(new R(ba,f.DARK_GRAY)),this.properties.add(new y(Ta,!1))}getLedColor(t){let e=!1;if(this.pv?.value!==void 0)for(let i=this.startBit;i<this.startBit+this.numBits;i++){let s=0;if(this.bitReverse?s=i-this.startBit:s=this.numBits-1-(i-this.startBit),s===t){e=(this.pv?.value>>i&1)>0;break}}return e?this.onColor:this.offColor}draw(t){if(this.numBits<1)return;let e=this.bounds;this.borderAlarmSensitive&&(e=U(e,2*this.scale)),this.horizontal?this.drawHorizontal(t,e):this.drawVertical(t,e)}drawHorizontal(t,e){let i,s;this.ledPacked?(i=Math.floor((e.width-this.ledBorder)/this.numBits+this.ledBorder),s=i-this.ledBorder):(i=Math.floor(e.width/this.numBits),s=i);let r=0;i>e.height||this.squareLed?r=e.height:r=i;for(let o=0;o<this.numBits;o++)if(this.squareLed){let a={x:e.x+o*s,y:e.y,width:i,height:r};this.effect3d?this.drawSquare3d(t,a,o):this.drawSquare2d(t,a,o)}else{let a=Math.min(i,r),h={x:e.x+o*s,y:e.y,width:a,height:a};this.effect3d?this.drawCircle3d(t,h,o):this.drawCircle2d(t,h,o)}}drawVertical(t,e){let i,s;this.ledPacked?(i=Math.floor((e.height-this.ledBorder)/this.numBits+this.ledBorder),s=i-this.ledBorder):(i=Math.floor(e.height/this.numBits),s=i);let r=0;i>e.width||this.squareLed?r=e.width:r=i;for(let o=0;o<this.numBits;o++)if(this.squareLed){let a={x:e.x,y:e.y+o*s,width:r,height:i};this.effect3d?this.drawSquare3d(t,a,o):this.drawSquare2d(t,a,o)}else{let a=Math.min(r,i),h={x:e.x,y:e.y+o*s,width:a,height:a};this.effect3d?this.drawCircle3d(t,h,o):this.drawCircle2d(t,h,o)}}drawCircle2d(t,e,i){let s=e.x+e.width/2,r=e.y+e.height/2,o=e.width/2,a=e.height/2;this.ledBorder>0&&(o-=this.ledBorder/2,a-=this.ledBorder/2),t.fillEllipse({cx:s,cy:r,rx:o,ry:a,color:this.getLedColor(i)}),t.strokeEllipse({cx:s,cy:r,rx:o,ry:a,color:this.ledBorderColor,lineWidth:this.ledBorder})}drawCircle3d(t,e,i){let s=e.x+e.width/2,r=e.y+e.height/2,o=e.width/2,a=e.height/2;t.fillEllipse({cx:s,cy:r,rx:o,ry:a,color:f.WHITE});let h=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y+e.height);h.addColorStop(0,this.ledBorderColor.toString()),h.addColorStop(1,this.ledBorderColor.withAlpha(0).toString()),t.fillEllipse({cx:s,cy:r,rx:o,ry:a,gradient:h});let l=e.width-2*this.ledBorder,d=e.height-2*this.ledBorder;o=l/2,a=d/2,t.fillEllipse({cx:s,cy:r,rx:o,ry:a,color:this.getLedColor(i)}),h=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y+e.height),h.addColorStop(0,f.WHITE.toString()),h.addColorStop(1,this.ledBorderColor.withAlpha(0).toString()),t.fillEllipse({cx:s,cy:r,rx:o,ry:a,gradient:h})}drawSquare2d(t,e,i){let s=Ft(e.x,e.y,e.width,e.height,this.ledBorder);t.fillRect(_(C({},s),{color:this.getLedColor(i)})),t.strokeRect(_(C({},s),{color:this.ledBorderColor,lineWidth:this.ledBorder}))}drawSquare3d(t,e,i){t.fillRect(_(C({},e),{color:this.ledBorderColor}));let s=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y);s.addColorStop(0,"rgba(0,0,0,0.078)"),s.addColorStop(1,"rgba(0,0,0,0.39)"),t.fillPath({gradient:s,path:new S(e.x,e.y).lineTo(e.x+this.ledBorder,e.y+this.ledBorder).lineTo(e.x+this.ledBorder,e.y+e.height-this.ledBorder).lineTo(e.x,e.y+e.height)}),s=t.createLinearGradient(e.x,e.y,e.x,e.y+e.height),s.addColorStop(0,"rgba(0,0,0,0.078)"),s.addColorStop(1,"rgba(0,0,0,0.39)"),t.fillPath({gradient:s,path:new S(e.x,e.y).lineTo(e.x+this.ledBorder,e.y+this.ledBorder).lineTo(e.x+e.width-this.ledBorder,e.y+this.ledBorder).lineTo(e.x+e.width,e.y)}),s=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y),s.addColorStop(0,"rgba(255,255,255,0.078)"),s.addColorStop(1,"rgba(255,255,255,0.39)"),t.fillPath({gradient:s,path:new S(e.x+e.width,e.y).lineTo(e.x+e.width-this.ledBorder,e.y+this.ledBorder).lineTo(e.x+e.width-this.ledBorder,e.y+e.height-this.ledBorder).lineTo(e.x+e.width,e.y+e.height)}),s=t.createLinearGradient(e.x,e.y,e.x,e.y+e.height),s.addColorStop(0,"rgba(255,255,255,0.078)"),s.addColorStop(1,"rgba(255,255,255,0.39)"),t.fillPath({gradient:s,path:new S(e.x,e.y+e.height).lineTo(e.x+this.ledBorder,e.y+e.height-this.ledBorder).lineTo(e.x+e.width-this.ledBorder,e.y+e.height-this.ledBorder).lineTo(e.x+e.width,e.y+e.height)});let r=e.x+this.ledBorder,o=e.y+this.ledBorder,a=e.width-2*this.ledBorder,h=e.height-2*this.ledBorder,l=this.getLedColor(i);t.fillRect({x:r,y:o,width:a,height:h,color:l}),s=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y+e.height),s.addColorStop(0,"rgba(255,255,255,0.784)"),s.addColorStop(1,l.withAlpha(0).toString()),t.fillRect({x:r,y:o,width:a,height:h,gradient:s})}get bitReverse(){return this.properties.getValue(xa)}get horizontal(){return this.properties.getValue(ya)}get numBits(){return this.properties.getValue(Sa)}get startBit(){return this.properties.getValue(_a)}get ledPacked(){return this.properties.getValue(Ta)}get ledBorder(){return this.scale*this.properties.getValue(va)}get ledBorderColor(){return this.properties.getValue(ba)}get offColor(){return this.properties.getValue(Va)}get onColor(){return this.properties.getValue(Ca)}get effect3d(){return this.properties.getValue(wa)}get squareLed(){return this.properties.getValue(Aa)}},Qt=class{prefix="";suffix="";comma=0;minInt=1;minFrac=0;maxFrac=0;constructor(t){for(let h=0;h<t.length;h++)if(t.charAt(h)=="#"||t.charAt(h)=="0"){this.prefix=t.substring(0,h),t=t.substring(h);break}this.suffix=t.replace(/[#]|[0]|[,]|[.]/g,"");let e=t.replace(/[^0#,.]/g,""),i="",s="",r=e.indexOf(".");r!==-1?(i=e.substring(0,r),s=e.substring(r+1)):i=e;let o=i.lastIndexOf(",");o!==-1&&(this.comma=i.length-1-o),i=i.replace(/[,]/g,""),s=s.replace(/[,]|[.]+/g,""),this.maxFrac=s.length;let a=i.replace(/[^0]/g,"");a.length>this.minInt&&(this.minInt=a.length),a=s.replace(/[^0]/g,""),this.minFrac=a.length}format(t){let e=this.formatBack(t).toLowerCase();if(isNaN(e)||e.length==0)return t;if(e.indexOf("e")!=-1){let g=Number(e);if(g===1/0||g===-1/0||(e=g+"",e.indexOf("e")!==-1))return e}let i=!1;e.charAt(0)==="-"?(i=!0,e=e.substring(1)):e.charAt(0)==="+"&&(e=e.substring(1));let s=e.indexOf("."),r="",o="";s!=-1?(r=e.substring(0,s),o=e.substring(s+1)):r=e,o=o.replace(/[.]/,"");let a=this.suffix&&this.suffix.charAt(0)==="%",h=this.minInt,l=this.minFrac,d=this.maxFrac;if(a&&(h-=2,l+=2,d+=2),o.length>d){let g=+("0."+o);g=d==0?Math.round(g):g.toFixed(d),o=g.toString(10).substr(2);let v=g>=1?1:0,w,T=r.length-1;for(;v;)if(T==-1){r="1"+r;break}else w=Number(r.charAt(T)),w===9?(w="0",v=1):(w=++w+"",v=0),r=r.substring(0,T)+w+r.substring(T+1,r.length),T--}for(let g=o.length;g<l;g++)o=o+"0";for(;o.length>l&&o.charAt(o.length-1)=="0";)o=o.substring(0,o.length-1);for(let g=r.length;g<h;g++)r="0"+r;for(;r.length>h&&r.charAt(0)=="0";)r=r.substring(1);a&&(r+=o.substring(0,2),o=o.substring(2));let n=0;for(let g=r.length;g>0;g--)n!=0&&n%this.comma==0&&(r=r.substring(0,g)+","+r.substring(g),n=0),n++;let p;return o.length>0?p=this.prefix+r+"."+o+this.suffix:p=this.prefix+r+this.suffix,i&&(p="-"+p),p}formatBack(t){if(t+="",!t)return"";if(!isNaN(t))return this.getNumericString(t);let e=t,i=!1;t.charAt(0)==="-"&&(e=e.substr(1),i=!0);let s=e.indexOf(this.prefix),r=this.suffix==""?e.length:e.indexOf(this.suffix,this.prefix.length+1);return s==0&&r>0&&(e=e.substr(0,r),e=e.substr(this.prefix.length),e=e.replace(/,/g,""),i&&(e="-"+e),!isNaN(e))?this.getNumericString(e):t}getNumericString(t){let e=Number(t)+"";if(t.indexOf(".")>-1&&e.indexOf(".")<0){for(var i=t.indexOf(".")+1;i<t.length;i++)if(t.charAt(i)!=="0")return t;return e}return t}},$c=1,Oc=8,Q=2,Xd=class{constructor(t,e,i){this.rampWidth=t,this.startAngle=e,this.endAngle=i}lolo=10;loloColor=f.RED;showLoLo=!0;lo=25;loColor=f.ORANGE;showLo=!0;hi=75;hiColor=f.ORANGE;showHi=!0;hihi=90;hihiColor=f.RED;showHiHi=!0;minimum=0;maximum=100;gradient=!0;logScale=!1;effect3d=!0;labelsOutside=!0;range={min:this.minimum,max:this.maximum};lengthInDegrees=0;radius=0;draw(t,e,i){if(this.labelsOutside){let s=$c+Oc;this.radius=e.width/2-s}else this.radius=e.width/2-1;this.range=this.getRenderedRange(),this.endAngle-this.startAngle>0?this.lengthInDegrees=360-(this.endAngle-this.startAngle):this.lengthInDegrees=this.startAngle-this.endAngle,this.drawRamp(t,i)}drawRamp(t,e){let i=e.x+e.width/2,s=e.y+e.height/2,r=e.width/2,o=e.height/2,a,h=360-this.endAngle;if(this.endAngle-this.startAngle>0?a=this.startAngle-90:a=this.startAngle+90,this.showLoLo){let v=a,w=360-this.getValuePosition(this.lolo,!0);t.strokeEllipse({cx:i,cy:s,rx:r-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(v),endAngle:$(w),color:this.loloColor})}if(this.showLo){let v;this.showLoLo?v=this.lolo:v=this.minimum;let w=360-this.getValuePosition(v,!0),T=360-this.getValuePosition(this.lo,!0);if(this.effect3d&&this.gradient&&this.showLoLo){let B=$(this.getValuePosition(v,!0)-Q),M=xt(e.width/2,B,e),k=$(this.getValuePosition(this.lo,!0)+Q),W=xt(e.width/2,k,e),D=t.createLinearGradient(M.x,M.y,W.x,W.y);D.addColorStop(0,this.loloColor.toString()),D.addColorStop(1,this.loColor.toString()),t.strokeEllipse({cx:i,cy:s,rx:r-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(w-Q/2),endAngle:$(T+Q/2),gradient:D})}else t.strokeEllipse({cx:i,cy:s,rx:r-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(w),endAngle:$(T),color:this.loColor})}let l=this.minimum;this.showLo?l=this.lo:this.showLoLo&&(l=this.lolo);let d=this.maximum;this.showHi?d=this.hi:this.showHiHi&&(d=this.hihi);let n=(l+d)/2,p=360-this.getValuePosition(l,!0),g=360-this.getValuePosition(n,!0);if(this.effect3d&&this.gradient&&(this.showLoLo||this.showLo)){let v=$(this.getValuePosition(l,!0)-Q),w=xt(e.width/2,v,e),T=$(this.getValuePosition(n,!0)+Q),B=xt(e.width/2,T,e),M=t.createLinearGradient(w.x,w.y,B.x,B.y);M.addColorStop(0,(this.showLo?this.loColor:this.loloColor).toString()),M.addColorStop(1,f.GREEN.toString()),t.strokeEllipse({cx:i,cy:s,rx:r-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(p-Q/2),endAngle:$(g+Q/2),gradient:M})}else t.strokeEllipse({cx:i,cy:s,rx:r-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(p),endAngle:$(g),color:f.GREEN});if(p=360-this.getValuePosition(n,!0),g=360-this.getValuePosition(d,!0),this.effect3d&&this.gradient&&(this.showHi||this.showHiHi)){let v=$(this.getValuePosition(n,!0)-Q),w=xt(e.width/2,v,e),T=$(this.getValuePosition(d,!0)+Q),B=xt(e.width/2,T,e),M=t.createLinearGradient(w.x,w.y,B.x,B.y);M.addColorStop(0,f.GREEN.toString()),M.addColorStop(1,(this.showHi?this.hiColor:this.hihiColor).toString());let k=g!==h?Q/2:0;t.strokeEllipse({cx:i,cy:s,rx:r-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(p-Q/2),endAngle:$(g+k),gradient:M})}else t.strokeEllipse({cx:i,cy:s,rx:r-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(p),endAngle:$(g),color:f.GREEN});if(this.showHi){let v;this.showHiHi?v=this.hihi:v=this.maximum;let w=360-this.getValuePosition(this.hi,!0),T=360-this.getValuePosition(v,!0);if(this.effect3d&&this.gradient&&this.showHiHi){let B=$(this.getValuePosition(this.hi,!0)-Q),M=xt(e.width/2,B,e),k=$(this.getValuePosition(v,!0)+Q),W=xt(e.width/2,k,e),D=t.createLinearGradient(M.x,M.y,W.x,W.y);D.addColorStop(0,this.hiColor.toString()),D.addColorStop(1,this.hihiColor.toString());let N=T!==h?Q/2:0;t.strokeEllipse({cx:i,cy:s,rx:r-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(w-Q/2),endAngle:$(T+N),gradient:D})}else t.strokeEllipse({cx:i,cy:s,rx:r-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(w),endAngle:$(T),color:this.hiColor})}if(this.showHiHi){p=360-this.getValuePosition(this.hihi,!0),g=h;let v=this.gradient?Q/2:0;t.strokeEllipse({cx:i,cy:s,rx:r-this.rampWidth/2,ry:o-this.rampWidth/2,lineWidth:this.rampWidth,startAngle:$(p-v),endAngle:$(g),color:this.hihiColor})}}getRadius(){return this.radius}getValuePosition(t,e=!1){e&&(t=this.getValueInRange(t));let i;return this.logScale?i=this.startAngle-(Math.log10(t)-Math.log10(this.range.min))/(Math.log10(this.range.max)-Math.log10(this.range.min))*this.lengthInDegrees:i=this.startAngle-(t-this.range.min)/(this.range.max-this.range.min)*this.lengthInDegrees,i<0&&(i+=360),i}getValueInRange(t){return this.range.min<=t&&t<=this.range.max?t:t>this.range.max?this.range.max:this.range.min}getRenderedRange(){let t={min:this.minimum,max:this.maximum};return this.logScale&&(this.minimum<=0&&(t.min=.1),t.max<=this.minimum&&(t.max=t.min+100)),t}},La=new f(100,100,100),Gc=16,zc=8,Uc=5,qc=-1,Pa="color_hi",ka="color_hihi",Ma="color_lo",Ra="color_lolo",Ea="effect_3d",Wa="font",Ba="value_label_format",Ia="level_hi",Ha="level_hihi",Da="level_lo",Na="level_lolo",Fa="limits_from_pv",$a="log_scale",Oa="minimum",Ga="maximum",za="needle_color",Ua="ramp_gradient",qa="show_ramp",ke=225,Yc=315,Xc=class extends G{constructor(t,e){super(t,e),this.properties.add(new R(Pa)),this.properties.add(new R(ka)),this.properties.add(new R(Ma)),this.properties.add(new R(Ra)),this.properties.add(new y(Ea)),this.properties.add(new O(Wa)),this.properties.add(new H(Ia)),this.properties.add(new H(Ha)),this.properties.add(new H(Da)),this.properties.add(new H(Na)),this.properties.add(new y($a)),this.properties.add(new y(Fa)),this.properties.add(new H(Ga)),this.properties.add(new H(Oa)),this.properties.add(new R(za)),this.properties.add(new y(Ua)),this.properties.add(new y(qa,!0)),this.properties.add(new A(Ba))}draw(t){let e;this.limitsFromPv&&this.pv&&!this.pv.disconnected?e={min:this.pv.lowerDisplayLimit??this.minimum,lolo:this.pv.lowerAlarmLimit,lo:this.pv.lowerWarningLimit,hi:this.pv.upperWarningLimit,hihi:this.pv.upperAlarmLimit,max:this.pv.upperDisplayLimit??this.maximum}:e={min:this.minimum,lolo:this.levelLoLo,lo:this.levelLo,hi:this.levelHi,hihi:this.levelHiHi,max:this.maximum},this.logScale&&(e.min=Math.max(.1,e.min),e.max<=e.min&&(e.max=e.min+100));let i=Math.min(this.width,this.height),s=i;this.drawBackground(t,i,s),this.showRamp&&this.drawRamp(t,i,s,e),this.drawLabel(t,i,s),this.drawNeedle(t,i,s,e),this.drawNeedleCenter(t,i,s)}drawBackground(t,e,i){if(t.fillEllipse({cx:this.x+e/2,cy:this.y+i/2,rx:e/2,ry:i/2,color:f.GRAY}),this.effect3d){let r=t.createLinearGradient(this.x,this.y,this.x+this.width,this.y+this.height);r.addColorStop(0,La.toString()),r.addColorStop(1,f.WHITE.toString()),t.fillEllipse({cx:this.x+e/2,cy:this.y+i/2,rx:e/2,ry:i/2,gradient:r})}let s=(this.effect3d?2:1)*this.scale;if(t.fillEllipse({cx:this.x+e/2,cy:this.y+i/2,rx:e/2-s,ry:i/2-s,color:this.backgroundColor}),this.effect3d){let r=e/2,o=9.5/10,a=1/2,h=8.5/10,l=$(0),d=$(35),n={x:Math.floor(this.x+e/2-r*h*Math.cos(l)),y:Math.floor(this.y+i/2-r*o),width:Math.floor(2*r*h*Math.cos(l)),height:Math.floor(r*o+r*a)},p=t.createLinearGradient(n.x,n.y,n.x,n.y+n.height);p.addColorStop(0,f.WHITE.withAlpha(90/255).toString()),p.addColorStop(1,f.WHITE.withAlpha(0).toString()),t.fillEllipse({cx:n.x+n.width/2,cy:n.y+n.height/2,rx:n.width/2,ry:n.height/2,gradient:p}),n={x:Math.floor(this.x+e/2-r*h*Math.sin(d)),y:Math.floor(Math.ceil(this.y+i/2+r*a)),width:Math.floor(2*r*h*Math.sin(d)),height:Math.floor(Math.ceil(r*o-r*a))},p=t.createLinearGradient(n.x,n.y,n.x,n.y+n.height),p.addColorStop(0,f.WHITE.withAlpha(0).toString()),p.addColorStop(1,f.WHITE.withAlpha(40/255).toString()),t.fillEllipse({cx:n.x+n.width/2,cy:n.y+n.height/2,rx:n.width/2,ry:n.height/2,gradient:p})}}drawRamp(t,e,i,s){let r=U({x:this.x,y:this.y,width:e,height:i},e/4,i/4),o=C({},r);o.width=Math.min(r.width,r.height),o.height=r.width;let a=new Xd(10*this.scale,225,315);a.lolo=s.lolo,a.loloColor=this.colorLoLo,a.lo=s.lo,a.loColor=this.colorLo,a.hi=s.hi,a.hiColor=this.colorHi,a.hihi=s.hihi,a.hihiColor=this.colorHiHi,a.minimum=s.min,a.maximum=s.max,a.effect3d=this.effect3d,a.gradient=this.rampGradient,a.logScale=this.logScale,a.draw(t,r,o)}drawLabel(t,e,i){let s=it.ARIAL_12_BOLD.scale(this.scale);if(this.pv?.value!==void 0){let r=this.formatLabelValue(this.pv.value),o=t.measureText(r,s);t.fillText({x:this.x+e/2-o.width/2,y:this.y+i*7/8-o.height/2,color:this.foregroundColor,align:"left",baseline:"top",font:s,text:r})}}drawNeedle(t,e,i,s){let r=this.x+e/2,o=this.y+i/2,a;if(this.pv?.value!==void 0){let T=this.getValueInRange(this.pv.value,s);a=360-this.getValuePosition(T,s),s.max>s.min?T>s.max?a+=10:T<s.min&&(a-=10):T>s.min?a-=10:T<s.max&&(a+=10)}else a=360-this.getValuePosition((s.min+s.max)/2,s);let h=$(a),{scale:l}=this,{needleDiameter:d,majorTickLength:n,gapBetweenNeedleScale:p}=this,g=$t(r,o-d/2+3*l,r,o,h),v=$t(r+e/2-n-p,o,r,o,h),w=$t(r,o+d/2-3*l,r,o,h);t.fillPath({color:this.needleColor,path:new S(g.x,g.y).lineTo(v.x,v.y).lineTo(w.x,w.y).closePath()})}drawNeedleCenter(t,e,i){let{needleDiameter:s}=this,r=this.x+e/2,o=this.y+i/2,a=s/2,h=s/2;if(this.effect3d){let l=t.createLinearGradient(r-a,o-h,r+a,o+h);l.addColorStop(0,f.WHITE.toString()),l.addColorStop(1,La.toString()),t.fillEllipse({cx:r,cy:o,rx:a,ry:h,gradient:l})}else t.fillEllipse({cx:r,cy:o,rx:a,ry:h,color:f.GRAY})}getValueInRange(t,e){return e.min<=t&&t<=e.max?t:t>e.max?e.max:e.min}getValuePosition(t,e){let i=360-(Yc-ke),s;return this.logScale?s=ke-(Math.log10(t)-Math.log10(e.min))/(Math.log10(e.max)-Math.log10(e.min))*i:s=ke-(t-e.min)/(e.max-e.min)*i,s<0&&(s+=360),s}formatLabelValue(t){return this.valueLabelFormat?new Qt(this.valueLabelFormat).format(t):String(Number(t.toFixed(3)))}get needleDiameter(){return this.scale*Gc}get majorTickLength(){return this.scale*zc}get minorTickLength(){return this.scale*Uc}get gapBetweenNeedleScale(){return this.scale*qc}get colorLo(){return this.properties.getValue(Ma)}get colorLoLo(){return this.properties.getValue(Ra)}get colorHi(){return this.properties.getValue(Pa)}get colorHiHi(){return this.properties.getValue(ka)}get effect3d(){return this.properties.getValue(Ea)}get font(){return this.properties.getValue(Wa).scale(this.scale)}get levelLo(){return this.properties.getValue(Da)}get levelLoLo(){return this.properties.getValue(Na)}get levelHi(){return this.properties.getValue(Ia)}get levelHiHi(){return this.properties.getValue(Ha)}get limitsFromPv(){return this.properties.getValue(Fa)}get logScale(){return this.properties.getValue($a)}get minimum(){return this.properties.getValue(Oa)}get maximum(){return this.properties.getValue(Ga)}get needleColor(){return this.properties.getValue(za)}get rampGradient(){return this.properties.getValue(Ua)}get showRamp(){return this.properties.getValue(qa)}get valueLabelFormat(){return this.properties.getValue(Ba)}},Ya="bit",Xa="data_type",ja="off_image",Ka="off_label",Za="font",Ja="on_image",Qa="on_label",th="show_boolean_label",jc=class extends G{onImageElement;onImageLoaded=!1;offImageElement;offImageLoaded=!1;constructor(t,e){super(t,e),this.properties.add(new b(Ya)),this.properties.add(new b(Xa)),this.properties.add(new A(ja)),this.properties.add(new A(Ka)),this.properties.add(new A(Ja)),this.properties.add(new A(Qa)),this.properties.add(new O(Za)),this.properties.add(new y(th))}init(){this.onImageElement=new Image,this.onImageElement.onload=()=>{this.onImageLoaded=!0,this.requestRepaint()},this.offImageElement=new Image,this.offImageElement.onload=()=>{this.offImageLoaded=!0,this.requestRepaint()},this.onImage&&(this.onImageElement.src=this.resolvePath(this.onImage)),this.offImage&&(this.offImageElement.src=this.resolvePath(this.offImage))}get booleanValue(){return this.bit<0?!!this.pv?.toNumber():this.pv?.value!==void 0?(this.pv?.value>>this.bit&1)>0:!1}get image(){return this.booleanValue?this.onImage:this.offImage}get label(){return this.booleanValue?this.onLabel:this.offLabel}draw(t){this.transparent||t.fillRect({x:this.x,y:this.y,width:this.width,height:this.height,color:this.backgroundColor}),this.booleanValue?this.onImageLoaded&&t.ctx.drawImage(this.onImageElement,this.x,this.y,this.width,this.height):this.offImageLoaded&&t.ctx.drawImage(this.offImageElement,this.x,this.y,this.width,this.height),this.showBooleanLabel&&t.fillText({x:this.x+this.width/2,y:this.y+this.height/2,font:this.font,baseline:"middle",align:"center",color:this.foregroundColor,text:this.label})}get bit(){return this.properties.getValue(Ya)}get dataType(){return this.properties.getValue(Xa)}get showBooleanLabel(){return this.properties.getValue(th)}get font(){return this.properties.getValue(Za).scale(this.scale)}get offLabel(){return this.properties.getValue(Ka)}get offImage(){return this.properties.getValue(ja)}get onLabel(){return this.properties.getValue(Qa)}get onImage(){return this.properties.getValue(Ja)}},Kc=["January","February","March","April","May","June","July","August","September","October","November","December"],Tt=class{constructor(t,e,i,s,r,o,a,h,l,d){this.formatter=t,this.scale=e,this.scaleFont=i,this.minimum=s,this.maximum=r,this.logScale=o,this.majorTickStepHint=a,this.foregroundColor=h,this.showMinorTicks=l,this.showScale=d}labels=[];labelValues=[];labelPositions=[];labelVisibilities=[];gridStepInPixel=0;horizontal=!1;x=0;y=0;scaleFormat="";timeFormat=0;length=0;margin=0;get scaleLength(){return this.length-2*this.margin}getX(){return this.x}getY(){return this.y}getGridPositions(){let t=[...this.labelPositions];return this.horizontal||(t=t.map(e=>this.length-e)),t.pop(),t.shift(),t}setDimensions(t,e,i,s){this.x=t,this.y=e,this.length=i,this.horizontal=s}getValuePosition(t){let{start:e,stop:i}=this.getMinMax(),s=0,r=this.length-2*this.margin;if(this.logScale)t<=0?s=this.margin:s=(Math.log10(t)-Math.log10(e))/(Math.log10(i)-Math.log10(e))*r+this.margin;else{let o=Math.max(Math.abs(e),Math.abs(i));i/=o,e/=o;let a=i-e;s=(t/o-e)/a*r+this.margin}return this.horizontal?s+this.x:this.length-s+this.y}getMinMax(){let t=this.minimum,e=this.maximum;return this.logScale&&(t<=0&&(t=.1),e<=t&&(e=t+100)),{start:t,stop:e}}getPositionValue(t){let e=this.getMinMax(),{start:i,stop:s}=e,r=this.horizontal?t-this.x:this.length+this.y-t,o=this.length-2*this.margin,a;if(this.logScale)a=Math.pow(10,(r-this.margin)*(Math.log10(s)-Math.log10(i))/o+Math.log10(i));else{let h=Math.max(Math.abs(i),Math.abs(s));s/=h,i/=h;let l=s-i;a=((r-this.margin)/o*l+i)*h}return a}calculateMargin(t,e){if(this.showScale){let i=t.measureText(this.format(this.minimum),this.scaleFont),s=t.measureText(this.format(this.maximum),this.scaleFont);return Math.ceil(e?Math.max(i.width,s.width)/2:Math.max(i.height,s.height)/2)}else return 0}measureHorizontalHeight(t){let e=t.measureText("dummy",this.scaleFont);return this.showScale?e.height+this.spaceBetweenMarkAndLabel+this.majorTickLength:0}drawHorizontal(t,e,i,s){let{scale:r}=this;this.length=s,this.horizontal=!0,this.margin=this.calculateMargin(t,this.horizontal);let o=s-2*this.margin;o>0&&this.updateLabels(t,o);let a=0;for(let l=0;l<this.labels.length;l++){let d=t.measureText(this.labels[l],this.scaleFont);d.height>a&&(a=d.height)}let h=this.showScale?a+this.spaceBetweenMarkAndLabel+this.majorTickLength:0;if(i=i-h,this.x=e,this.y=i,this.logScale)for(let l=0;l<this.labelPositions.length;l++){let d=this.x+this.labelPositions[l],n=this.y,p=0;if(this.labelVisibilities[l]?p=this.majorTickLength:p=this.minorTickLength,this.labelVisibilities[l]||this.showMinorTicks){let g=Math.round(d)-r*.5;t.strokePath({path:new S(g,n).lineTo(g,n+p),color:this.foregroundColor,lineWidth:r*1,opacity:100/255})}this.labelVisibilities[l]&&t.fillText({x:d,y:this.y+this.spaceBetweenMarkAndLabel+this.majorTickLength,align:"center",baseline:"top",font:this.scaleFont,color:this.foregroundColor,text:this.labels[l]})}else for(let l=0;l<this.labels.length;l++){let d=e+this.labelPositions[l];this.labelVisibilities[l]&&t.fillText({x:d,y:i+this.majorTickLength+this.spaceBetweenMarkAndLabel,align:"center",baseline:"top",font:this.scaleFont,color:this.foregroundColor,text:this.labels[l]});let n=Math.round(d)-r*.5;t.strokePath({path:new S(n,i).lineTo(n,i+this.majorTickLength),color:this.foregroundColor,lineWidth:r*1,opacity:100/255}),this.showMinorTicks&&this.drawMinorXTicks(t,l,e,i)}return h}drawVertical(t,e,i,s,r,o=!1){let{scale:a}=this;this.length=s,this.horizontal=!1,this.margin=this.calculateMargin(t,this.horizontal);let h=s-2*this.margin;h>0&&this.updateLabels(t,h);let l=0;for(let n=0;n<this.labels.length;n++){let p=t.measureText(this.labels[n],this.scaleFont);p.width>l&&(l=p.width)}let d=this.showScale?l+this.spaceBetweenMarkAndLabel+this.majorTickLength:0;if(r||(e=e-d),this.x=e,this.y=i,this.logScale)for(let n=0;n<this.labelPositions.length;n++){let p;this.labelVisibilities[n]?p=this.majorTickLength:p=this.minorTickLength;let g=e+l+this.spaceBetweenMarkAndLabel-1*a+this.majorTickLength-p,v=Math.round(i+s-this.labelPositions[n])-a*.5;if((this.labelVisibilities[n]||this.showMinorTicks)&&t.strokePath({path:new S(g,v).lineTo(g+p,v),color:this.foregroundColor,lineWidth:a*1,opacity:100/255}),this.labelVisibilities[n]){let w=i+s-this.labelPositions[n];t.fillText({x:e,y:w,align:"left",baseline:"middle",font:this.scaleFont,color:this.foregroundColor,text:this.labels[n]})}}else for(let n=0;n<this.labels.length;n++){let p=i+s-this.labelPositions[n],g=Math.round(p)-a*.5;if(o){if(t.strokePath({path:new S(e,g).lineTo(e+this.majorTickLength,g),color:this.foregroundColor,lineWidth:a*1,opacity:100/255}),this.labelVisibilities[n]){let v=e+this.majorTickLength+this.spaceBetweenMarkAndLabel;t.fillText({x:v,y:p,align:"left",baseline:"middle",font:this.scaleFont,color:this.foregroundColor,text:this.labels[n]})}}else{this.labelVisibilities[n]&&t.fillText({x:e,y:p,align:"left",baseline:"middle",font:this.scaleFont,color:this.foregroundColor,text:this.labels[n]});let v=e+l+this.spaceBetweenMarkAndLabel-a*1;t.strokePath({path:new S(v,g).lineTo(v+this.majorTickLength,g),color:this.foregroundColor,lineWidth:a*1,opacity:100/255}),this.showMinorTicks&&this.drawMinorYTicks(t,n,v,i+s)}}return d}drawMinorXTicks(t,e,i,s){let{gridStepInPixel:r}=this,o,a;r/5>=this.minorTickMarkStepHint?(o=5,a=Math.floor(r/5)):r/4>=this.minorTickMarkStepHint?(o=4,a=Math.floor(r/4)):(o=2,a=Math.floor(r/2));let{labelPositions:h,minorTickLength:l,scale:d}=this;if(e>0)if(e===1&&h[1]-h[0]<r){let n=h[1];for(;n-h[0]>a+3*d;){n=n-a;let p=Math.round(i+n)-d*.5;t.strokePath({path:new S(p,s).lineTo(p,s+l),color:this.foregroundColor,lineWidth:d*1,opacity:100/255})}}else if(e===h.length-1&&h[e]-h[e-1]<r){let n=h[e-1];for(;h[e]-n>a+3*d;){n=n+a;let p=Math.round(i+n)-d*.5;t.strokePath({path:new S(p,s).lineTo(p,s+l),color:this.foregroundColor,lineWidth:d*1,opacity:100/255})}}else for(let n=0;n<o;n++){let p=i+h[e-1]+(h[e]-h[e-1])*n/o;p=Math.round(p)-d*.5,t.strokePath({path:new S(p,s).lineTo(p,s+l),color:this.foregroundColor,lineWidth:d*1,opacity:100/255})}}drawMinorYTicks(t,e,i,s){let{gridStepInPixel:r}=this,o,a;r/5>=this.minorTickMarkStepHint?(o=5,a=Math.floor(r/5)):r/4>=this.minorTickMarkStepHint?(o=4,a=Math.floor(r/4)):(o=2,a=Math.floor(r/2));let{labelPositions:h,minorTickLength:l,majorTickLength:d,scale:n}=this;if(e>0)if(e===1&&h[1]-h[0]<r){let p=h[1];for(;p-h[0]>a+3*n;){p-=a;let g=Math.round(s-p)-n*.5;t.strokePath({path:new S(i+d-l,g).lineTo(i+d,g),color:this.foregroundColor,lineWidth:n*1,opacity:100/255})}}else if(e===h.length-1&&h[e]-h[e-1]<r){let p=h[e-1];for(;h[e]-p>a+3*n;){p+=a;let g=Math.round(s-p)-n*.5;t.strokePath({path:new S(i+d-l,g).lineTo(i+d,g),color:this.foregroundColor,lineWidth:n*1,opacity:100/255})}}else for(let p=0;p<o;p++){let g=s-h[e-1]-(h[e]-h[e-1])*p/o;g=Math.round(g)-n*.5,t.strokePath({path:new S(i+d-l,g).lineTo(i+d,g),color:this.foregroundColor,lineWidth:n*1,opacity:100/255})}}updateLabels(t,e){if(this.labels=[],this.labelValues=[],this.labelPositions=[],this.showScale)if(this.logScale)this.updateLabelsForLogScale(this.minimum,this.maximum,e);else{let i=this.getGridStep(e,this.minimum,this.maximum),s=Math.max(Math.abs(this.minimum),Math.abs(this.maximum)),r=this.maximum/s-this.minimum/s;this.gridStepInPixel=Math.floor(e*(i/s)/r),this.updateLabelsForLinearScale(this.minimum,this.maximum,e,i)}this.updateVisibility(t)}getGridStep(t,e,i){t<=0&&(t=1);let s=!1;if(e>=i)if(i===e)i++;else{s=!0;let d=e;e=i,i=d}let r=Math.abs(i-e),o=this.majorTickStepHint;o>t&&(o=t);let a=r/t*o,h=0;if(a<1){if(a!=0)for(;a<1;)a*=10,h--}else for(;a>=10;)a/=10,h++;let l;return a>7.5?l=10*Math.pow(10,h):a>3.5?l=5*Math.pow(10,h):a>1.5?l=2*Math.pow(10,h):l=Math.pow(10,h),s&&(l=-l),l}updateLabelsForLogScale(t,e,i){t<=0&&(t=.1),e<=t&&(e=t+100);let s=e<t,r=Math.log10(t),o=Math.ceil(r),a=Math.ceil(Math.log10(e)),h=Math.pow(10,o-1),l;t%h<=0||s?l=t-t%h:l=t-t%h+h,s&&t>l?this.addMinMaxTickInfo(t,i,!0):!s&&t<l&&this.addMinMaxTickInfo(t,i,!0);for(let d=o;s?d>=a:d<=a;d+=s?-1:1)if(Math.abs(a-o)>20){let n=Math.pow(10,d);if(n>e)break;this.addTickInfo(n,e,r,i)}else{for(let n=l;(s?n>=Math.pow(10,d-1):n<=Math.pow(10,d))&&!(s?n<e:n>e);n=s?n-h:n+h)this.addTickInfo(n,e,r,i);h=s?h/Math.pow(10,1):h*Math.pow(10,1),l=s?Math.pow(10,d-1):h+Math.pow(10,d)}(s?e<this.labelValues[this.labelValues.length-1]:e>this.labelValues[this.labelValues.length-1])&&this.addMinMaxTickInfo(e,i,!1)}addMinMaxTickInfo(t,e,i){i?(this.labelValues.push(t),this.labels.push(this.format(t)),this.labelPositions.push(this.margin)):(this.labelValues.push(t),this.labels.push(this.format(t)),this.labelPositions.push(this.margin+e))}addTickInfo(t,e,i,s){this.labels.push(this.format(t));let r=Math.floor((Math.log10(t)-i)/(Math.log10(e)-i)*s)+this.margin;this.labelPositions.push(r),this.labelValues.push(t)}updateLabelsForLinearScale(t,e,i,s){let r=e<t,o;t%s<=0?o=t-t%s:o=t-t%s+s,t>o==r&&(this.labelValues.push(t),this.labels.push(this.format(t)),this.labelPositions.push(this.margin));let a=1,h=Math.max(Math.abs(t),Math.abs(e));e/=h,t/=h,s/=h,o/=h;let l=e-t;for(let d=o;e>=t?d<e:d>e;d=o+a++*s){let n=d*h;this.labels.push(this.format(n)),this.labelValues.push(n);let p=Math.floor((d-t)/l*i)+this.margin;this.labelPositions.push(p)}e*=h,this.labelValues.push(e),this.labels.push(this.format(e)),this.labelPositions.push(this.margin+i)}updateVisibility(t){if(this.labelVisibilities=[],!this.labelPositions.length)return;for(let s=0;s<this.labelPositions.length;s++)this.labelVisibilities.push(!0);let e=0,i=null;for(let s=0;s<this.labelPositions.length;s++){let r=!0,o=this.labels[s],a=this.labelPositions[s];s!==0&&(r=this.hasSpaceToDraw(t,e,a,i||"",o));let h=o===i&&s!==0&&s!==this.labelPositions.length-1,l=!0;if(this.logScale){let d=Number(this.labels[s]);l=this.isMajorTick(d)||s===0||s===this.labelPositions.length-1}!r||h||!l?this.labelVisibilities[s]=!1:(e=a,i=o)}}hasSpaceToDraw(t,e,i,s,r){let o=t.measureText(r,this.scaleFont),a=t.measureText(s,this.scaleFont),h=i-e,l=Math.floor(this.horizontal?o.width/2+a.width/2:o.height),d=!0,n=!0;if(i!=this.labelPositions[this.labelPositions.length-1]){d=h>l+this.tickLabelGap;let p=t.measureText(this.labels[this.labels.length-1],this.scaleFont);h=this.labelPositions[this.labelPositions.length-1]-i,l=Math.floor(this.horizontal?o.width/2+p.width/2:o.height),n=h>l+this.tickLabelGap}return d&&n}isMajorTick(t){if(!this.logScale)return!0;let e=Math.log10(t);return e===Math.round(e)}format(t){if(this.timeFormat===0)return this.scaleFormat?new Qt(this.scaleFormat).format(t):String(Number(t.toFixed(2)));let e=new Date(t),i=this.formatter;switch(this.timeFormat){case 1:return i.formatDate(e,{year:!0,month:!0,day:!0})+`
`+i.formatTime(e,{hours:!0,minutes:!0,seconds:!0,milliseconds:!1});case 2:return i.formatDate(e,{year:!0,month:!0,day:!0})+`
`+i.formatTime(e,{hours:!0,minutes:!0,seconds:!0,milliseconds:!0});case 3:return i.formatTime(e,{hours:!0,minutes:!0,seconds:!0,milliseconds:!1});case 4:return i.formatTime(e,{hours:!0,minutes:!0,seconds:!0,milliseconds:!0});case 5:return i.formatTime(e,{hours:!0,minutes:!0,seconds:!1,milliseconds:!1});case 6:return i.formatDate(e,{year:!0,month:!0,day:!0});case 7:let s=this.formatter.utc,r=Kc[s?e.getUTCMonth():e.getMonth()],o=s?e.getUTCDate():e.getDate();return`${r} ${o}`;case 8:let a=Math.abs(this.maximum-this.minimum);return a<=5e3?i.formatTime(e,{hours:!1,minutes:!1,seconds:!0,milliseconds:!0}):a<=18e5?i.formatTime(e,{hours:!0,minutes:!0,seconds:!0,milliseconds:!1}):a<=864e5?i.formatTime(e,{hours:!0,minutes:!0,seconds:!1,milliseconds:!1}):a<=6048e5?i.formatDate(e,{year:!1,month:!0,day:!0})+`
`+i.formatTime(e,{hours:!0,minutes:!0,seconds:!1,milliseconds:!1}):a<=2592e6?i.formatDate(e,{year:!1,month:!0,day:!0}):i.formatDate(e,{year:!0,month:!0,day:!0})}return""}get spaceBetweenMarkAndLabel(){return this.scale*2}get majorTickLength(){return this.scale*6}get minorTickLength(){return this.scale*3}get minorTickMarkStepHint(){return this.scale*4}get tickLabelGap(){return this.horizontal?this.scale*10:this.scale*2}},eh="color_map",ih="crop_bottom",sh="crop_left",rh="crop_right",oh="crop_top",ah="data_height",hh="data_width",lh="font",nh="graph_area_height",dh="graph_area_width",uh="maximum",ph="minimum",ch="show_ramp",gh="x_axis_axis_color",mh="x_axis_axis_title",fh="x_axis_major_tick_step_hint",xh="x_axis_maximum",wh="x_axis_minimum",yh="x_axis_scale_font",vh="x_axis_show_minor_ticks",bh="x_axis_title_font",Th="x_axis_visible",Sh="y_axis_axis_color",Vh="y_axis_axis_title",Ch="y_axis_major_tick_step_hint",_h="y_axis_maximum",Ah="y_axis_minimum",Lh="y_axis_scale_font",Ph="y_axis_show_minor_ticks",kh="y_axis_title_font",Mh="y_axis_visible",Zc=class extends G{constructor(t,e){super(t,e),this.properties.add(new Fe(eh)),this.properties.add(new b(ih)),this.properties.add(new b(sh)),this.properties.add(new b(rh)),this.properties.add(new b(oh)),this.properties.add(new b(ah)),this.properties.add(new b(hh)),this.properties.add(new b(nh)),this.properties.add(new b(dh)),this.properties.add(new O(lh)),this.properties.add(new H(uh)),this.properties.add(new H(ph)),this.properties.add(new y(ch)),this.properties.add(new R(gh)),this.properties.add(new A(mh)),this.properties.add(new b(fh)),this.properties.add(new H(xh)),this.properties.add(new H(wh)),this.properties.add(new O(yh)),this.properties.add(new y(vh)),this.properties.add(new O(bh)),this.properties.add(new y(Th)),this.properties.add(new R(Sh)),this.properties.add(new A(Vh)),this.properties.add(new b(Ch)),this.properties.add(new H(_h)),this.properties.add(new H(Ah)),this.properties.add(new O(Lh)),this.properties.add(new y(Ph)),this.properties.add(new O(kh)),this.properties.add(new y(Mh))}draw(t){let{scale:e}=this,i=this.area;this.borderAlarmSensitive&&(i=U(i,2*e));let s=this.alarmSensitiveBackgroundColor;t.fillRect(_(C({},i),{color:s}));let{graphAreaWidth:r,graphAreaHeight:o}=this,a=0;this.xAxisVisible&&(a=t.measureText(this.xAxisAxisTitle,this.xAxisTitleFont).height);let h=0;this.yAxisVisible&&(h=t.measureText(this.yAxisAxisTitle,this.yAxisTitleFont).height);let l=new Tt(this.display.formatter,e,this.xAxisScaleFont,this.xAxisMinimum,this.xAxisMaximum,!1,this.xAxisMajorTickStepHint,this.xAxisAxisColor,this.xAxisShowMinorTicks,this.xAxisVisible),d=l.calculateMargin(t,!0),n=new Tt(this.display.formatter,e,this.yAxisScaleFont,this.yAxisMinimum,this.yAxisMaximum,!1,this.yAxisMajorTickStepHint,this.yAxisAxisColor,this.yAxisShowMinorTicks,this.yAxisVisible),p=n.calculateMargin(t,!1),g=l.measureHorizontalHeight(t),v=o+2*p,w=n.drawVertical(t,i.x+h,i.y,v,!0),T=r+2*d,B=i.x+h+w-d,M=i.y+v+g-p;l.drawHorizontal(t,B,M,T);let k=e*1,W=Math.round(i.x+h+w)-k/2,D=Math.round(i.y+p)-k/2;t.strokePath({path:new S(W,D).lineTo(W,D+o),color:this.yAxisAxisColor,opacity:100/255,lineWidth:k});let N=W,j=D+o+k;t.strokePath({path:new S(N,j).lineTo(N+r,j),color:this.xAxisAxisColor,opacity:100/255,lineWidth:k});let{dataWidth:J,dataHeight:ht,colorMap:tt}=this,{minimum:lt,maximum:rt}=this,[Rt,Gt]=tt.getMinMax();if(this.value&&this.value.length){let et=document.createElement("canvas"),{cropLeft:nt,cropRight:gt,cropTop:mt,cropBottom:Et}=this;et.width=J-nt-gt,et.height=ht-mt-Et;let St=et.getContext("2d");for(let pt=nt;pt<J-gt;pt++)for(let ot=mt;ot<ht-Et;ot++){let ct=this.value[ot*J+pt];if(tt.autoscale){let Yt=(ct-lt)/(rt-lt);ct=Rt+Yt*(Gt-Rt)}let[zt,Ut,qt]=tt.lookup(ct);St.fillStyle=`rgb(${zt},${Ut},${qt})`,St.fillRect(pt-nt,ot-mt,1,1)}let Vt=Math.round(i.x+h+w),ft=Math.round(i.y+n.margin);t.ctx.drawImage(et,Vt,ft,r,o)}if(this.showRamp){let et=new Tt(this.display.formatter,e,this.font,lt,rt,!1,50*e,this.alarmSensitiveForegroundColor,!1,!0),nt=i.y+n.margin,gt=o,mt=et.drawVertical(t,i.x+i.width,nt,gt,!1,!0),Et=i.x+h+w+r+this.gap,St=i.width-h-w-r-mt-this.gap,Vt=gt-2*et.margin,ft=document.createElement("canvas");ft.width=St,ft.height=Vt;let pt=ft.getContext("2d");for(let ot=0;ot<Vt;ot++){let ct=rt-ot/Vt*(rt-lt);if(tt.autoscale){let Yt=(ct-lt)/(rt-lt);ct=Rt+Yt*(Gt-Rt)}let[zt,Ut,qt]=tt.lookup(ct);pt.fillStyle=`rgb(${zt},${Ut},${qt})`,pt.fillRect(0,ot,St,1)}t.ctx.drawImage(ft,Et,nt+et.margin)}if(this.xAxisVisible){let et=i.x+w+r/2;this.yAxisVisible&&(et+=h),t.fillText({x:et,y:i.y+i.height,align:"center",baseline:"bottom",font:this.xAxisTitleFont,color:this.xAxisAxisColor,text:this.xAxisAxisTitle})}this.yAxisVisible&&(t.ctx.save(),t.ctx.translate(i.x+h/2,i.y+v/2),t.ctx.rotate(-Math.PI/2),t.fillText({x:0,y:0,align:"center",baseline:"middle",font:this.yAxisTitleFont,color:this.yAxisAxisColor,text:this.yAxisAxisTitle}),t.ctx.restore())}get gap(){return this.scale*3}get colorMap(){return this.properties.getValue(eh)}get cropBottom(){return this.properties.getValue(ih)}get cropLeft(){return this.properties.getValue(sh)}get cropRight(){return this.properties.getValue(rh)}get cropTop(){return this.properties.getValue(oh)}get dataHeight(){return this.properties.getValue(ah)}get dataWidth(){return this.properties.getValue(hh)}get font(){return this.properties.getValue(lh).scale(this.scale)}get graphAreaHeight(){return this.scale*this.properties.getValue(nh)}get graphAreaWidth(){return this.scale*this.properties.getValue(dh)}get maximum(){return this.properties.getValue(uh)}get minimum(){return this.properties.getValue(ph)}get showRamp(){return this.properties.getValue(ch)}get xAxisAxisColor(){return this.properties.getValue(gh)}get xAxisAxisTitle(){return this.properties.getValue(mh)}get xAxisMajorTickStepHint(){return this.scale*this.properties.getValue(fh)}get xAxisMaximum(){return this.properties.getValue(xh)}get xAxisMinimum(){return this.properties.getValue(wh)}get xAxisScaleFont(){return this.properties.getValue(yh).scale(this.scale)}get xAxisShowMinorTicks(){return this.properties.getValue(vh)}get xAxisTitleFont(){return this.properties.getValue(bh).scale(this.scale)}get xAxisVisible(){return this.properties.getValue(Th)}get yAxisAxisColor(){return this.properties.getValue(Sh)}get yAxisAxisTitle(){return this.properties.getValue(Vh)}get yAxisMajorTickStepHint(){return this.scale*this.properties.getValue(Ch)}get yAxisMaximum(){return this.properties.getValue(_h)}get yAxisMinimum(){return this.properties.getValue(Ah)}get yAxisScaleFont(){return this.properties.getValue(Lh).scale(this.scale)}get yAxisShowMinorTicks(){return this.properties.getValue(Ph)}get yAxisTitleFont(){return this.properties.getValue(kh).scale(this.scale)}get yAxisVisible(){return this.properties.getValue(Mh)}},Rh="bit",Eh="data_type",Wh="effect_3d",Bh="state_count",Ih="square_led",Hh="off_color",Dh="off_label",Nh="off_state",Fh="font",$h="on_color",Oh="on_label",Gh="on_state",zh="bulb_border",Uh="bulb_border_color",qh="state_color_fallback",Yh="state_label_fallback",Xh="show_boolean_label",Jc=class extends G{areaRegion;states=[];constructor(t,e){super(t,e),this.properties.add(new b(Rh)),this.properties.add(new b(Eh)),this.properties.add(new y(Wh)),this.properties.add(new y(Ih)),this.properties.add(new b(Bh,2)),this.properties.add(new R(Hh)),this.properties.add(new A(Dh)),this.properties.add(new A(Nh)),this.properties.add(new R($h)),this.properties.add(new A(Oh)),this.properties.add(new A(Gh)),this.properties.add(new O(Fh)),this.properties.add(new y(Xh)),this.properties.add(new R(qh)),this.properties.add(new A(Yh)),this.properties.add(new b(zh,3)),this.properties.add(new R(Uh,f.DARK_GRAY))}async parseNode(t){if(await super.parseNode(t),this.stateCount>2)for(let e=0;e<this.stateCount;e++){let i=new R(`state_color_${e}`);i.value=t.getColor(`state_color_${e}`),this.properties.add(i);let s=new A(`state_label_${e}`);s.value=t.getString(`state_label_${e}`),this.properties.add(s);let r=new H(`state_value_${e}`);r.value=t.getFloat(`state_value_${e}`),this.properties.add(r),this.states.push({label:this.properties.getValue(s.name),color:this.properties.getValue(i.name),value:this.properties.getValue(r.name)})}}init(){this.areaRegion={id:`${this.wuid}-area`,click:()=>{let t={pvName:this.pvName};this.display.fireEvent("openpv",t)},cursor:"pointer",tooltip:()=>this.tooltip}}get booleanValue(){return this.dataType===0?this.bit<0?!!(this.pv?.toNumber()??this.value):this.pv?.value!==void 0?(this.pv?.value>>this.bit&1)>0:this.value!==void 0?(this.value>>this.bit&1)>0:!1:this.dataType===1?(this.pv?.toString()??this.value)===this.onState:!1}get bulbColor(){if(this.stateCount<=2)return this.booleanValue?this.onColor:this.offColor;for(let t of this.states)if(t.value===(this.pv?.value??this.value))return t.color;return this.stateColorFallback}get label(){if(this.stateCount===2)return this.booleanValue?this.onLabel:this.offLabel;for(let t of this.states)if(t.value===(this.pv?.value??this.value))return t.label;return this.stateLabelFallback}draw(t){let e=U(this.bounds,3*this.scale);if(this.squareLed?this.effect3d?this.drawSquare3d(t,e):this.drawSquare2d(t,e):this.effect3d?this.drawCircle3d(t,e):this.drawCircle2d(t,e),this.showBooleanLabel){let i=this.bulbColor;i.red*299+i.green*587+i.blue*114>105e3?i=f.BLACK:i=f.WHITE,t.fillText({x:e.x+e.width/2,y:e.y+e.height/2,font:this.font,baseline:"middle",align:"center",color:i,text:this.label})}}drawCircle2d(t,e){let i=e.x+e.width/2,s=e.y+e.height/2,r=e.width/2,o=e.height/2;this.bulbBorder>0&&(r-=this.bulbBorder/2,o-=this.bulbBorder/2),t.fillEllipse({cx:i,cy:s,rx:r,ry:o,color:this.bulbColor}),t.strokeEllipse({cx:i,cy:s,rx:r,ry:o,color:this.bulbBorderColor,lineWidth:this.bulbBorder}),this.pv&&this.pv.navigable&&!this.pv.disconnected&&t.addHitRegion(this.areaRegion).addEllipse(i,s,r,o,0,0,2*Math.PI)}drawCircle3d(t,e){let i=e.x+e.width/2,s=e.y+e.height/2,r=e.width/2,o=e.height/2;t.fillEllipse({cx:i,cy:s,rx:r,ry:o,color:f.WHITE});let a=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y+e.height);a.addColorStop(0,this.bulbBorderColor.toString()),a.addColorStop(1,this.bulbBorderColor.withAlpha(0).toString()),t.fillEllipse({cx:i,cy:s,rx:r,ry:o,gradient:a});let h=e.width-2*this.bulbBorder,l=e.height-2*this.bulbBorder;r=h/2,o=l/2,t.fillEllipse({cx:i,cy:s,rx:r,ry:o,color:this.bulbColor}),a=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y+e.height),a.addColorStop(0,f.WHITE.toString()),a.addColorStop(1,this.bulbBorderColor.withAlpha(0).toString()),t.fillEllipse({cx:i,cy:s,rx:r,ry:o,gradient:a}),this.pv&&this.pv.navigable&&!this.pv.disconnected&&t.addHitRegion(this.areaRegion).addEllipse(i,s,r,o,0,0,2*Math.PI)}drawSquare2d(t,e){let i=Ft(e.x,e.y,e.width,e.height,this.bulbBorder);t.fillRect(_(C({},i),{color:this.bulbColor})),t.strokeRect(_(C({},i),{color:this.bulbBorderColor,lineWidth:this.bulbBorder})),this.pv&&this.pv.navigable&&!this.pv.disconnected&&t.addHitRegion(this.areaRegion).addRect(e.x,e.y,e.width,e.height)}drawSquare3d(t,e){t.fillRect(_(C({},e),{color:this.bulbBorderColor})),this.pv&&this.pv.navigable&&!this.pv.disconnected&&t.addHitRegion(this.areaRegion).addRect(e.x,e.y,e.width,e.height);let i=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y);i.addColorStop(0,"rgba(0,0,0,0.078)"),i.addColorStop(1,"rgba(0,0,0,0.39)"),t.fillPath({gradient:i,path:new S(e.x,e.y).lineTo(e.x+this.bulbBorder,e.y+this.bulbBorder).lineTo(e.x+this.bulbBorder,e.y+e.height-this.bulbBorder).lineTo(e.x,e.y+e.height)}),i=t.createLinearGradient(e.x,e.y,e.x,e.y+e.height),i.addColorStop(0,"rgba(0,0,0,0.078)"),i.addColorStop(1,"rgba(0,0,0,0.39)"),t.fillPath({gradient:i,path:new S(e.x,e.y).lineTo(e.x+this.bulbBorder,e.y+this.bulbBorder).lineTo(e.x+e.width-this.bulbBorder,e.y+this.bulbBorder).lineTo(e.x+e.width,e.y)}),i=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y),i.addColorStop(0,"rgba(255,255,255,0.078)"),i.addColorStop(1,"rgba(255,255,255,0.39)"),t.fillPath({gradient:i,path:new S(e.x+e.width,e.y).lineTo(e.x+e.width-this.bulbBorder,e.y+this.bulbBorder).lineTo(e.x+e.width-this.bulbBorder,e.y+e.height-this.bulbBorder).lineTo(e.x+e.width,e.y+e.height)}),i=t.createLinearGradient(e.x,e.y,e.x,e.y+e.height),i.addColorStop(0,"rgba(255,255,255,0.078)"),i.addColorStop(1,"rgba(255,255,255,0.39)"),t.fillPath({gradient:i,path:new S(e.x,e.y+e.height).lineTo(e.x+this.bulbBorder,e.y+e.height-this.bulbBorder).lineTo(e.x+e.width-this.bulbBorder,e.y+e.height-this.bulbBorder).lineTo(e.x+e.width,e.y+e.height)});let s=e.x+this.bulbBorder,r=e.y+this.bulbBorder,o=e.width-2*this.bulbBorder,a=e.height-2*this.bulbBorder;t.fillRect({x:s,y:r,width:o,height:a,color:this.bulbColor}),i=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y+e.height),i.addColorStop(0,"rgba(255,255,255,0.784)"),i.addColorStop(1,this.bulbColor.withAlpha(0).toString()),t.fillRect({x:s,y:r,width:o,height:a,gradient:i})}get bit(){return this.properties.getValue(Rh)}get dataType(){return this.properties.getValue(Eh)}get squareLed(){return this.properties.getValue(Ih)}get showBooleanLabel(){return this.properties.getValue(Xh)}get font(){return this.properties.getValue(Fh).scale(this.scale)}get effect3d(){return this.properties.getValue(Wh)}get stateCount(){return this.properties.getValue(Bh)}get bulbBorder(){return this.scale*this.properties.getValue(zh)}get bulbBorderColor(){return this.properties.getValue(Uh)}get offLabel(){return this.properties.getValue(Dh)}get offColor(){return this.properties.getValue(Hh)}get offState(){return this.properties.getValue(Nh)}get onLabel(){return this.properties.getValue(Oh)}get onColor(){return this.properties.getValue($h)}get onState(){return this.properties.getValue(Gh)}get stateLabelFallback(){return this.properties.getValue(Yh)}get stateColorFallback(){return this.properties.getValue(qh)}},Qc=16,tg=12,eg=-5,ig=45,le=$(ig),jh=(1-Math.sin(le)/2)/(2*Math.cos(le)),Kh="color_hi",Zh="color_hihi",Jh="color_lo",Qh="color_lolo",tl="font",el="level_hi",il="level_hihi",sl="level_lo",rl="level_lolo",ol="log_scale",al="minimum",hl="maximum",ll="needle_color",nl="ramp_gradient",dl="scale_font",ul="show_hi",pl="show_hihi",cl="show_lo",gl="show_lolo",ml="show_ramp",fl="value_label_format",sg=class extends G{areaRegion;constructor(t,e){super(t,e),this.properties.add(new R(Kh)),this.properties.add(new R(Zh)),this.properties.add(new R(Jh)),this.properties.add(new R(Qh)),this.properties.add(new O(tl)),this.properties.add(new b(el)),this.properties.add(new b(il)),this.properties.add(new b(sl)),this.properties.add(new b(rl)),this.properties.add(new y(ol)),this.properties.add(new b(hl)),this.properties.add(new b(al)),this.properties.add(new R(ll)),this.properties.add(new y(nl)),this.properties.add(new O(dl)),this.properties.add(new y(ul)),this.properties.add(new y(pl)),this.properties.add(new y(cl)),this.properties.add(new y(gl)),this.properties.add(new y(ml,!0)),this.properties.add(new A(fl))}init(){this.areaRegion={id:`${this.wuid}-area`,click:()=>{let t={pvName:this.pvName};this.display.fireEvent("openpv",t)},tooltip:()=>this.tooltip,cursor:"pointer"}}draw(t){t.fillRect({x:this.x,y:this.y,width:this.width,height:this.height,color:this.backgroundColor}),this.showRamp&&this.drawRamp(t),this.pv&&this.pv.navigable&&!this.pv.disconnected&&t.addHitRegion(this.areaRegion).addRect(this.x,this.y,this.width,this.height)}drawRamp(t){let e=String(this.minimum),i=t.measureText(e,this.scaleFont),s=String(this.maximum),r=t.measureText(s,this.scaleFont),o=Math.max(i.width,r.width)/2,a=this.height,h=this.width;a>jh*(h-2*o)&&(a=Math.floor(jh*(h-2*o)));let l=a/(1-Math.sin(le)/2),d=Math.floor(this.x-l*(1-Math.cos(le))+o),n=this.y,p={x:d,y:n,width:Math.floor(2*l),height:Math.floor(2*l)},{rampWidth:g}=this,v=U(p,p.width/4-g,p.height/4-g);v.width=Math.min(v.width,v.height),v.height=v.width;let w=new Xd(g,135,45);w.lolo=this.levelLoLo,w.loloColor=this.colorLoLo,w.showLoLo=!0,w.lo=this.levelLo,w.loColor=this.colorLo,w.showLo=!0,w.hi=this.levelHi,w.hiColor=this.colorHi,w.showHi=!0,w.hihi=this.levelHiHi,w.hihiColor=this.colorHiHi,w.showHiHi=!0,w.minimum=this.minimum,w.maximum=this.maximum,w.gradient=this.rampGradient,w.logScale=this.logScale,w.draw(t,p,v),this.drawNeedle(t,p,w);let T=it.ARIAL_12_BOLD.scale(this.scale);if(this.pv&&this.pv.value!==void 0){let B=this.format(this.pv.value),M=t.measureText(B,T);t.fillText({x:p.x+p.width/2-M.width/2,y:p.y+p.height/2-p.height/4-(w.getRadius()-p.height/4)/2-M.height/2,align:"left",baseline:"top",font:T,text:B,color:this.foregroundColor})}}drawNeedle(t,e,i){let s=e.x+e.width/2,r=e.y+e.height/2,o;if(this.pv&&this.pv.value!==void 0){let v=i.getValueInRange(this.pv.value);o=360-i.getValuePosition(v),this.maximum>this.minimum?v>this.maximum?o+=8:v<this.minimum&&(o-=8):v>this.minimum?o-=8:v<this.maximum&&(o+=8)}else o=360-i.getValuePosition(this.minimum+this.maximum/2);let a=$(o),{needleWidth:h,gapBetweenNeedleScale:l,scale:d}=this,n=$t(s+e.width/4,r-h/2+3*d,s,r,a),p=$t(s+i.getRadius()-l,r,s,r,a),g=$t(s+e.width/4,r+h/2-3*d,s,r,a);t.fillPath({color:this.needleColor,path:new S(n.x,n.y).lineTo(p.x,p.y).lineTo(g.x,g.y).closePath()})}get needleWidth(){return this.scale*Qc}get gapBetweenNeedleScale(){return this.scale*eg}get rampWidth(){return this.scale*tg}format(t){return this.valueLabelFormat?new Qt(this.valueLabelFormat).format(t):String(Number(t.toFixed(2)))}get colorLo(){return this.properties.getValue(Jh)}get colorLoLo(){return this.properties.getValue(Qh)}get colorHi(){return this.properties.getValue(Kh)}get colorHiHi(){return this.properties.getValue(Zh)}get font(){return this.properties.getValue(tl).scale(this.scale)}get levelLo(){return this.properties.getValue(sl)}get levelLoLo(){return this.properties.getValue(rl)}get levelHi(){return this.properties.getValue(el)}get levelHiHi(){return this.properties.getValue(il)}get logScale(){return this.properties.getValue(ol)}get minimum(){return this.properties.getValue(al)}get maximum(){return this.properties.getValue(hl)}get needleColor(){return this.properties.getValue(ll)}get rampGradient(){return this.properties.getValue(nl)}get scaleFont(){return this.properties.getValue(dl).scale(this.scale)}get showLo(){return this.properties.getValue(cl)}get showLoLo(){return this.properties.getValue(gl)}get showHi(){return this.properties.getValue(ul)}get showHiHi(){return this.properties.getValue(pl)}get showRamp(){return this.properties.getValue(ml)}get valueLabelFormat(){return this.properties.getValue(fl)}},xl="color_hi",wl="color_hihi",yl="color_lo",vl="color_lolo",bl="color_fillbackground",Tl="effect_3d",Sl="fill_color",Vl="fillcolor_alarm_sensitive",Cl="font",_l="horizontal",Al="indicator_mode",Ll="level_hi",Pl="level_hihi",kl="level_lo",Ml="level_lolo",Rl="limits_from_pv",El="log_scale",Wl="maximum",Bl="major_tick_step_hint",Il="minimum",Hl="origin",Dl="origin_ignored",Nl="scale_font",Fl="scale_format",$l="show_hi",Ol="show_hihi",Gl="show_label",zl="show_lo",Ul="show_lolo",ql="show_markers",Yl="show_minor_ticks",Xl="show_scale",jl="transparent_background",Kl="value_label_format",rg=class extends G{constructor(t,e){super(t,e),this.properties.add(new R(xl)),this.properties.add(new R(wl)),this.properties.add(new R(yl)),this.properties.add(new R(vl)),this.properties.add(new R(bl)),this.properties.add(new y(Tl)),this.properties.add(new R(Sl)),this.properties.add(new y(Vl,!1)),this.properties.add(new O(Cl)),this.properties.add(new y(_l)),this.properties.add(new y(Al)),this.properties.add(new H(Ll)),this.properties.add(new H(Pl)),this.properties.add(new H(kl)),this.properties.add(new H(Ml)),this.properties.add(new y(Rl)),this.properties.add(new y(El)),this.properties.add(new H(Wl)),this.properties.add(new H(Bl)),this.properties.add(new H(Il)),this.properties.add(new H(Hl,0)),this.properties.add(new y(Dl,!0)),this.properties.add(new O(Nl)),this.properties.add(new A(Fl)),this.properties.add(new y($l)),this.properties.add(new y(Ol)),this.properties.add(new y(Gl)),this.properties.add(new y(zl)),this.properties.add(new y(Ul)),this.properties.add(new y(ql)),this.properties.add(new y(Yl)),this.properties.add(new y(Xl)),this.properties.add(new y(jl)),this.properties.add(new A(Kl))}draw(t){let e=this.area;this.borderAlarmSensitive&&(e=U(this.area,2*this.scale));let i=this.alarmSensitiveBackgroundColor;this.transparentBackground||t.fillRect(_(C({},e),{color:i})),this.horizontal?this.drawHorizontal(t,e):this.drawVertical(t,e)}drawVertical(t,e){let i=this.alarmSensitiveForegroundColor,s=new Tt(this.display.formatter,this.scale,this.scaleFont,this.min,this.max,this.logScale,this.majorTickStepHint,i,this.showMinorTicks,this.showScale);s.scaleFormat=this.scaleFormat;let r=s.drawVertical(t,e.x,e.y,e.height,!0),o=0;this.showMarkers&&(o=this.drawVerticalMarkers(t,s,e)),this.drawVerticalBar(t,s,{x:e.x+r,y:e.y+s.margin,width:e.width-r-o,height:e.height-2*s.margin})}drawVerticalMarkers(t,e,i){let{lolo:s,lo:r,hi:o,hihi:a}=this,h=it.ARIAL_9.scale(this.scale),l=0;if(this.showLoLo&&s!==void 0){let n=t.measureText("LOLO",h);l=Math.max(l,n.width)}if(this.showLo&&r!==void 0){let n=t.measureText("LO",h);l=Math.max(l,n.width)}if(this.showHi&&o!==void 0){let n=t.measureText("HI",h);l=Math.max(l,n.width)}if(this.showHiHi&&a!==void 0){let n=t.measureText("HIHI",h);l=Math.max(l,n.width)}let d=i.x+i.width;if(this.showLoLo&&s!==void 0){let n=d-l-this.markerGap,p=Math.round(e.getValuePosition(s));t.strokePath({path:new S(n,p).lineTo(n-this.markerTickLength,p),color:this.colorLoLo,lineWidth:this.markerTickLineWidth}),t.fillText({x:n+this.markerGap,y:p,text:"LOLO",align:"left",baseline:"middle",color:this.colorLoLo,font:h})}if(this.showLo&&r!==void 0){let n=d-l-this.markerGap,p=Math.round(e.getValuePosition(r));t.strokePath({path:new S(n,p).lineTo(n-this.markerTickLength,p),color:this.colorLo,lineWidth:this.markerTickLineWidth}),t.fillText({x:n+this.markerGap,y:p,text:"LO",align:"left",baseline:"middle",color:this.colorLo,font:h})}if(this.showHi&&o!==void 0){let n=d-l-this.markerGap,p=Math.round(e.getValuePosition(o));t.strokePath({path:new S(n,p).lineTo(n-this.markerTickLength,p),color:this.colorHi,lineWidth:this.markerTickLineWidth}),t.fillText({x:n+this.markerGap,y:p,text:"HI",align:"left",baseline:"middle",color:this.colorHi,font:h})}if(this.showHiHi&&a!==void 0){let n=d-l-this.markerGap,p=Math.round(e.getValuePosition(a));t.strokePath({path:new S(n,p).lineTo(n-this.markerTickLength,p),color:this.colorHiHi,lineWidth:this.markerTickLineWidth}),t.fillText({x:n+this.markerGap,y:p,text:"HIHI",align:"left",baseline:"middle",color:this.colorHiHi,font:h})}return this.markerTickLength+this.markerGap+l}drawVerticalBar(t,e,i){let{outlineWidth:s}=this;if(t.fillRect(_(C({},i),{color:this.colorFillbackground})),this.effect3d){let a=t.createLinearGradient(i.x,0,i.x+i.width,0);a.addColorStop(0,f.WHITE.toString()),a.addColorStop(1,this.colorFillbackground.withAlpha(0).toString()),t.fillRect(_(C({},i),{gradient:a}));let h=U(i,s/2);t.strokeRect(_(C({},h),{color:f.GRAY,lineWidth:s}))}let r=this.alarmSensitiveFillColor;if(this.indicatorMode){let a=Math.round(e.getValuePosition(this.getFillValue())),h=i.width,l=this.thumbBreadth,d=re([{x:0,y:l/2},{x:h/2,y:0},{x:h-1,y:l/2},{x:h/2,y:l}],i.x,a-l/2),n=S.fromPoints(d);if(this.effect3d){let{x:p,y:g}=d[0],{x:v,y:w}=d[2],T=t.createLinearGradient(p,g,v,w);T.addColorStop(0,f.WHITE.toString()),T.addColorStop(1,r.toString()),t.fillPath({path:n,gradient:T}),t.strokePath({path:n,color:f.GRAY,lineWidth:s})}else t.fillPath({path:n,color:r})}else{let a=this.originIgnored?this.min:this.origin,h=this.getFillValue();if(h<a){let p=a;a=h,h=p}let l=Math.round(e.getValuePosition(a)),d=Math.round(e.getValuePosition(h)),n=U(_(C({},i),{y:l,height:d-l}),s);if(t.fillRect(_(C({},n),{color:r})),this.effect3d){let p=t.createLinearGradient(n.x,0,n.x+n.width,0);p.addColorStop(0,f.WHITE.toString()),p.addColorStop(1,r.withAlpha(0).toString()),t.fillRect(_(C({},n),{gradient:p}))}}let o=this.pv?.value;this.showLabel&&o!==void 0&&t.fillText({x:i.x+i.width/2,y:i.y+i.height/2,align:"center",baseline:"middle",color:this.alarmSensitiveForegroundColor,font:this.font,text:this.format(o)})}drawHorizontal(t,e){let i=this.alarmSensitiveForegroundColor,s=new Tt(this.display.formatter,this.scale,this.scaleFont,this.min,this.max,this.logScale,this.majorTickStepHint,i,this.showMinorTicks,this.showScale);s.scaleFormat=this.scaleFormat;let r=s.drawHorizontal(t,e.x,e.y+e.height,e.width),o=0;this.showMarkers&&(o=this.drawHorizontalMarkers(t,s,e)),this.drawHorizontalBar(t,s,{x:e.x+s.margin,y:e.y+o,width:e.width-2*s.margin,height:e.height-r-o})}drawHorizontalMarkers(t,e,i){let{lolo:s,lo:r,hi:o,hihi:a}=this,h=it.ARIAL_9.scale(this.scale),l=0;if(this.showLoLo&&s!==void 0){let n=t.measureText("LOLO",h);l=Math.max(l,n.height)}if(this.showLo&&r!==void 0){let n=t.measureText("LO",h);l=Math.max(l,n.height)}if(this.showHi&&o!==void 0){let n=t.measureText("HI",h);l=Math.max(l,n.height)}if(this.showHiHi&&a!==void 0){let n=t.measureText("HIHI",h);l=Math.max(l,n.height)}let d=i.y;if(this.showLoLo&&s!==void 0){let n=Math.round(e.getValuePosition(s)),p=d+l+this.markerGap;t.strokePath({path:new S(n,p).lineTo(n,p+this.markerTickLength),color:this.colorLoLo,lineWidth:this.markerTickLineWidth}),t.fillText({x:n,y:d,text:"LOLO",align:"center",baseline:"top",color:this.colorLoLo,font:h})}if(this.showLo&&r!==void 0){let n=Math.round(e.getValuePosition(r)),p=d+l+this.markerGap;t.strokePath({path:new S(n,p).lineTo(n,p+this.markerTickLength),color:this.colorLo,lineWidth:this.markerTickLineWidth}),t.fillText({x:n,y:d,text:"LO",align:"center",baseline:"top",color:this.colorLo,font:h})}if(this.showHi&&o!==void 0){let n=Math.round(e.getValuePosition(o)),p=d+l+this.markerGap;t.strokePath({path:new S(n,p).lineTo(n,p+this.markerTickLength),color:this.colorHi,lineWidth:this.markerTickLineWidth}),t.fillText({x:n,y:d,text:"HI",align:"center",baseline:"top",color:this.colorHi,font:h})}if(this.showHiHi&&a!==void 0){let n=Math.round(e.getValuePosition(a)),p=d+l+this.markerGap;t.strokePath({path:new S(n,p).lineTo(n,p+this.markerTickLength),color:this.colorHiHi,lineWidth:this.markerTickLineWidth}),t.fillText({x:n,y:d,text:"HIHI",align:"center",baseline:"top",color:this.colorHiHi,font:h})}return this.markerTickLength+this.markerGap+l}drawHorizontalBar(t,e,i){let{outlineWidth:s}=this;if(t.fillRect(_(C({},i),{color:this.colorFillbackground})),this.effect3d){let a=t.createLinearGradient(0,i.y,0,i.y+i.height);a.addColorStop(0,f.WHITE.toString()),a.addColorStop(1,this.colorFillbackground.withAlpha(0).toString()),t.fillRect(_(C({},i),{gradient:a}));let h=U(i,s/2);t.strokeRect(_(C({},h),{color:f.GRAY,lineWidth:s}))}let r=this.alarmSensitiveFillColor;if(this.indicatorMode){let a=Math.round(e.getValuePosition(this.getFillValue())),h=i.height,l=this.thumbBreadth,d=re([{x:l/2,y:0},{x:l,y:h/2},{x:l/2,y:h-1},{x:0,y:h/2}],a-l/2,i.y),n=S.fromPoints(d);if(this.effect3d){let{x:p,y:g}=d[0],{x:v,y:w}=d[2],T=t.createLinearGradient(p,g,v,w);T.addColorStop(0,f.WHITE.toString()),T.addColorStop(1,r.toString()),t.fillPath({path:n,gradient:T}),t.strokePath({path:n,color:f.GRAY,lineWidth:s})}else t.fillPath({path:n,color:r})}else{let a=this.originIgnored?this.min:this.origin,h=this.getFillValue();if(h<a){let p=a;a=h,h=p}let l=Math.round(e.getValuePosition(a)),d=Math.round(e.getValuePosition(h)),n=U(_(C({},i),{x:l,width:d-l}),s);if(t.fillRect(_(C({},n),{color:r})),this.effect3d){let p=t.createLinearGradient(0,n.y,0,n.y+n.height);p.addColorStop(0,f.WHITE.toString()),p.addColorStop(1,r.withAlpha(0).toString()),t.fillRect(_(C({},n),{gradient:p}))}}let o=this.pv?.value;this.showLabel&&o!==void 0&&t.fillText({x:i.x+i.width/2,y:i.y+i.height/2,align:"center",baseline:"middle",color:this.alarmSensitiveForegroundColor,font:this.font,text:this.format(o)})}get min(){return this.limitsFromPv?this.pv?.lowerDisplayLimit??this.minimum:this.minimum}get max(){return this.limitsFromPv?this.pv?.upperDisplayLimit??this.maximum:this.maximum}get lolo(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.lowerAlarmLimit:this.levelLoLo}get lo(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.lowerWarningLimit:this.levelLo}get hi(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.upperWarningLimit:this.levelHi}get hihi(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.upperAlarmLimit:this.levelHiHi}get markerTickLength(){return this.scale*10}get markerTickLineWidth(){return this.scale*2}get markerGap(){return this.scale*3}get thumbBreadth(){return this.scale*13}get outlineWidth(){return this.scale*1}get alarmSensitiveFillColor(){if(this.fillColorAlarmSensitive){if(this.isMajorSeverity())return this.display.majorColor;if(this.isMinorSeverity())return this.display.minorColor}return this.fillColor}getFillValue(){let t=this.pv?.value??this.min;return t=Math.max(this.min,t),t=Math.min(this.max,t),t}format(t){return this.valueLabelFormat?new Qt(this.valueLabelFormat).format(t):String(Number(t.toFixed(2)))}get colorLo(){return this.properties.getValue(yl)}get colorLoLo(){return this.properties.getValue(vl)}get colorHi(){return this.properties.getValue(xl)}get colorHiHi(){return this.properties.getValue(wl)}get colorFillbackground(){return this.properties.getValue(bl)}get effect3d(){return this.properties.getValue(Tl)}get fillColorAlarmSensitive(){return this.properties.getValue(Vl)}get fillColor(){return this.properties.getValue(Sl)}get font(){return this.properties.getValue(Cl).scale(this.scale)}get horizontal(){return this.properties.getValue(_l)}get indicatorMode(){return this.properties.getValue(Al)}get levelLo(){return this.properties.getValue(kl)}get levelLoLo(){return this.properties.getValue(Ml)}get levelHi(){return this.properties.getValue(Ll)}get levelHiHi(){return this.properties.getValue(Pl)}get limitsFromPv(){return this.properties.getValue(Rl)}get logScale(){return this.properties.getValue(El)}get minimum(){return this.properties.getValue(Il)}get majorTickStepHint(){return this.scale*this.properties.getValue(Bl)}get maximum(){return this.properties.getValue(Wl)}get origin(){return this.properties.getValue(Hl)}get originIgnored(){return this.properties.getValue(Dl)}get scaleFont(){return this.properties.getValue(Nl).scale(this.scale)}get scaleFormat(){return this.properties.getValue(Fl)}get showHi(){return this.properties.getValue($l)}get showHiHi(){return this.properties.getValue(Ol)}get showLabel(){return this.properties.getValue(Gl)}get showLo(){return this.properties.getValue(zl)}get showLoLo(){return this.properties.getValue(Ul)}get showMarkers(){return this.properties.getValue(ql)}get showMinorTicks(){return this.properties.getValue(Yl)}get showScale(){return this.properties.getValue(Xl)}get transparentBackground(){return this.properties.getValue(jl)}get valueLabelFormat(){return this.properties.getValue(Kl)}},Zl="color_hi",Jl="color_hihi",Ql="color_lo",tn="color_lolo",en="color_fillbackground",sn="fill_color",rn="fillcolor_alarm_sensitive",on="effect_3d",an="level_hi",hn="level_hihi",ln="level_lo",nn="level_lolo",dn="limits_from_pv",un="log_scale",pn="maximum",cn="major_tick_step_hint",gn="minimum",mn="scale_font",fn="scale_format",xn="show_hi",wn="show_hihi",yn="show_lo",vn="show_lolo",bn="show_markers",Tn="show_minor_ticks",Sn="show_scale",Vn="transparent_background",og=new f(160,160,160),ag=class extends G{constructor(t,e){super(t,e),this.properties.add(new R(Zl)),this.properties.add(new R(Jl)),this.properties.add(new R(Ql)),this.properties.add(new R(tn)),this.properties.add(new R(en)),this.properties.add(new y(on)),this.properties.add(new R(sn)),this.properties.add(new y(rn,!1)),this.properties.add(new H(an)),this.properties.add(new H(hn)),this.properties.add(new H(ln)),this.properties.add(new H(nn)),this.properties.add(new y(dn)),this.properties.add(new y(un)),this.properties.add(new H(pn)),this.properties.add(new H(cn)),this.properties.add(new H(gn)),this.properties.add(new O(mn)),this.properties.add(new A(fn)),this.properties.add(new y(xn)),this.properties.add(new y(wn)),this.properties.add(new y(yn)),this.properties.add(new y(vn)),this.properties.add(new y(bn)),this.properties.add(new y(Tn)),this.properties.add(new y(Sn)),this.properties.add(new y(Vn))}draw(t){let{scale:e,min:i,max:s}=this,r=this.area;this.borderAlarmSensitive&&(r=U(r,2*e));let o=this.alarmSensitiveBackgroundColor;this.transparentBackground||t.fillRect(_(C({},r),{color:o}));let a=this.alarmSensitiveForegroundColor,h=new Tt(this.display.formatter,e,this.scaleFont,i,s,this.logScale,this.majorTickStepHint,a,this.showMinorTicks,this.showScale);h.scaleFormat=this.scaleFormat;let l=h.drawVertical(t,r.x,r.y,r.height,!0),d=0;this.showMarkers&&(d=this.drawMarkers(t,r,h)),this.drawTank(t,r,l,d,h)}drawMarkers(t,e,i){let{lolo:s,lo:r,hi:o,hihi:a}=this,h=it.ARIAL_9.scale(this.scale),l=0;if(this.showLoLo&&s!==void 0){let n=t.measureText("LOLO",h);l=Math.max(l,n.width)}if(this.showLo&&r!==void 0){let n=t.measureText("LO",h);l=Math.max(l,n.width)}if(this.showHi&&o!==void 0){let n=t.measureText("HI",h);l=Math.max(l,n.width)}if(this.showHiHi&&a!==void 0){let n=t.measureText("HIHI",h);l=Math.max(l,n.width)}let d=e.x+e.width-l-this.markerGap-this.markerTickLength;if(this.showLoLo&&s!==void 0){let n=Math.round(i.getValuePosition(s));t.strokePath({path:new S(d,n).lineTo(d+this.markerTickLength,n),color:this.colorLoLo,lineWidth:this.markerTickLineWidth}),t.fillText({x:d+this.markerTickLength+this.markerGap,y:n,text:"LOLO",align:"left",baseline:"middle",color:this.colorLoLo,font:h})}if(this.showLo&&r!==void 0){let n=Math.round(i.getValuePosition(r));t.strokePath({path:new S(d,n).lineTo(d+this.markerTickLength,n),color:this.colorLo,lineWidth:this.markerTickLineWidth}),t.fillText({x:d+this.markerTickLength+this.markerGap,y:n,text:"LO",align:"left",baseline:"middle",color:this.colorLo,font:h})}if(this.showHi&&o!==void 0){let n=Math.round(i.getValuePosition(o));t.strokePath({path:new S(d,n).lineTo(d+this.markerTickLength,n),color:this.colorHi,lineWidth:this.markerTickLineWidth}),t.fillText({x:d+this.markerTickLength+this.markerGap,y:n,text:"HI",align:"left",baseline:"middle",color:this.colorHi,font:h})}if(this.showHiHi&&a!==void 0){let n=Math.round(i.getValuePosition(a));t.strokePath({path:new S(d,n).lineTo(d+this.markerTickLength,n),color:this.colorHiHi,lineWidth:this.markerTickLineWidth}),t.fillText({x:d+this.markerTickLength+this.markerGap,y:n,text:"HIHI",align:"left",baseline:"middle",color:this.colorHiHi,font:h})}return this.markerTickLength+this.markerGap+l}drawTank(t,e,i,s,r){let o=this.alarmSensitiveForegroundColor,{scale:a,outlineWidth:h}=this,l=e.x+i,d=e.y+r.margin,n=e.width-i-s,p=e.height-2*r.margin,g=this.defaultCorner,v=11/20;n<2*g&&(v=12/20);let w=Math.floor(n*v);g>2*w-n-2*h&&(g=2*w-n);let T=r.getValuePosition(this.getFillValue()),B=this.alarmSensitiveFillColor;if(this.effect3d){t.fillRect({x:l,y:d,width:n,height:p,rx:g/2,ry:g/2,color:f.WHITE});let k=t.createLinearGradient(l,d,l+w+2*a,d);k.addColorStop(0,this.colorFillbackground.toString()),k.addColorStop(1,f.WHITE.withAlpha(0).toString()),t.fillRect({x:l,y:d,width:w,height:p,rx:g/2,ry:g/2,gradient:k}),k=t.createLinearGradient(l+n-w-2*a,d,l+n,d),k.addColorStop(0,f.WHITE.withAlpha(0).toString()),k.addColorStop(1,this.colorFillbackground.toString()),t.fillRect({x:l+n-w,y:d,width:w,height:p,rx:g/2,ry:g/2,gradient:k});let W=T,D=d+p-T;k=t.createLinearGradient(l,W,l+w+2*a,W),k.addColorStop(0,B.toString()),k.addColorStop(1,f.WHITE.withAlpha(0).toString()),t.fillRect({x:l,y:W,width:w,height:D,rx:g/2,ry:g/2,gradient:k}),k=t.createLinearGradient(l+n-w-2*a,W,l+n,W),k.addColorStop(0,f.WHITE.withAlpha(0).toString()),k.addColorStop(1,B.toString()),t.fillRect({x:l+n-w,y:W,width:w,height:D,rx:g/2,ry:g/2,gradient:k})}else t.fillRect({x:l,y:d,width:n,height:p,rx:g/2,ry:g/2,color:this.colorFillbackground}),t.fillRect({x:l,y:T,width:n,height:d+p-T,rx:g/2,ry:g/2,color:B});let M=U({x:l,y:d,width:n,height:p},h/2);t.strokeRect(_(C({},M),{rx:g/2,ry:g/2,color:this.effect3d?og:o,lineWidth:h}))}get min(){return this.limitsFromPv?this.pv?.lowerDisplayLimit??this.minimum:this.minimum}get max(){return this.limitsFromPv?this.pv?.upperDisplayLimit??this.maximum:this.maximum}get lolo(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.lowerAlarmLimit:this.levelLoLo}get lo(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.lowerWarningLimit:this.levelLo}get hi(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.upperWarningLimit:this.levelHi}get hihi(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.upperAlarmLimit:this.levelHiHi}get defaultCorner(){return this.scale*15}get markerTickLength(){return this.scale*10}get markerTickLineWidth(){return this.scale*2}get markerGap(){return this.scale*3}get outlineWidth(){return this.scale*1}get alarmSensitiveFillColor(){if(this.fillColorAlarmSensitive){if(this.isMajorSeverity())return this.display.majorColor;if(this.isMinorSeverity())return this.display.minorColor}return this.fillColor}getFillValue(){let t=this.pv?.value??this.min;return t=Math.max(this.min,t),t=Math.min(this.max,t),t}get colorLo(){return this.properties.getValue(Ql)}get colorLoLo(){return this.properties.getValue(tn)}get colorHi(){return this.properties.getValue(Zl)}get colorHiHi(){return this.properties.getValue(Jl)}get colorFillbackground(){return this.properties.getValue(en)}get fillColorAlarmSensitive(){return this.properties.getValue(rn)}get fillColor(){return this.properties.getValue(sn)}get effect3d(){return this.properties.getValue(on)}get levelLo(){return this.properties.getValue(ln)}get levelLoLo(){return this.properties.getValue(nn)}get levelHi(){return this.properties.getValue(an)}get levelHiHi(){return this.properties.getValue(hn)}get limitsFromPv(){return this.properties.getValue(dn)}get logScale(){return this.properties.getValue(un)}get minimum(){return this.properties.getValue(gn)}get majorTickStepHint(){return this.scale*this.properties.getValue(cn)}get maximum(){return this.properties.getValue(pn)}get scaleFont(){return this.properties.getValue(mn).scale(this.scale)}get scaleFormat(){return this.properties.getValue(fn)}get showLo(){return this.properties.getValue(yn)}get showLoLo(){return this.properties.getValue(vn)}get showHi(){return this.properties.getValue(xn)}get showHiHi(){return this.properties.getValue(wn)}get showMarkers(){return this.properties.getValue(bn)}get showMinorTicks(){return this.properties.getValue(Tn)}get showScale(){return this.properties.getValue(Sn)}get transparentBackground(){return this.properties.getValue(Vn)}},Cn="font",_n="format_type",An="horizontal_alignment",Ln="precision",Pn="precision_from_pv",kn="show_lohi",Mn="show_units",Rn="vertical_alignment",hg=class extends G{areaRegion;tooltipRegion;constructor(t,e){super(t,e),this.properties.add(new O(Cn)),this.properties.add(new b(_n)),this.properties.add(new b(An)),this.properties.add(new b(Ln)),this.properties.add(new y(Pn)),this.properties.add(new y(kn,!0)),this.properties.add(new y(Mn,!0)),this.properties.add(new b(Rn))}init(){this.areaRegion={id:`${this.wuid}-area`,click:()=>{let t={pvName:this.pvName};this.display.fireEvent("openpv",t)},tooltip:()=>this.tooltip,cursor:"pointer"},this.tooltipRegion={id:`${this.wuid}-tooltip`,tooltip:()=>this.tooltip}}draw(t){let e=t.ctx;this.backgroundAlarmSensitive&&this.alarm?t.fillRect(_(C({},this.area),{color:this.alarmSensitiveBackgroundColor})):this.transparent||t.fillRect(_(C({},this.area),{color:this.backgroundColor})),this.pv&&this.pv.navigable&&!this.pv.disconnected?t.addHitRegion(this.areaRegion).addRect(this.x,this.y,this.width,this.height):this.tooltip&&t.addHitRegion(this.tooltipRegion).addRect(this.x,this.y,this.width,this.height);let{scale:i}=this,s=this.area;this.borderAlarmSensitive&&(s=U(s,2*i,2*i));let r=this.text;if(this.pv?.value!==void 0){let d=this.precisionFromPV?this.pv.precision:this.precision;d===-1&&(d=this.pv.precision??-1),r=ae(this.pv.value,this.formatType,d,this.pv.typeHint)}else this.value!==void 0&&(r=ae(this.value,this.formatType,this.precision,void 0));this.showUnits&&this.pv?.units&&(r+=" "+this.pv.units),this.showLohi&&(this.pv?.alarmName==="LOLO"||this.pv?.alarmName==="LOW"?r+=" \u2193":(this.pv?.alarmName==="HIHI"||this.pv?.alarmName==="HIGH")&&(r+=" \u2191"));let o=t.measureText(r,this.font,!0);e.font=this.font.getFontString(),e.textBaseline="alphabetic";let a=e.measureText(r).fontBoundingBoxAscent,h={x:s.x,y:s.y,width:o.width,height:o.height};this.horizAlignment===0||(this.horizAlignment===1?h.x+=(s.width-o.width)/2:this.horizAlignment===2&&(h.x+=s.width-o.width)),this.vertAlignment===0||s.height<=o.height||(this.vertAlignment===1?h.y+=s.height/2-o.height/2:this.vertAlignment===2&&(h.y+=s.height-o.height)),e.textAlign="start",e.textBaseline="top",h.y+=h.height/2-a/2,e.save(),e.beginPath();let l=this.area;e.rect(l.x,l.y,l.width,l.height),e.clip(),e.fillStyle=this.alarmSensitiveForegroundColor.toString(),e.fillText(r,h.x,h.y),e.restore()}get font(){return this.properties.getValue(Cn).scale(this.scale)}get formatType(){return this.properties.getValue(_n)}get horizAlignment(){return this.properties.getValue(An)}get precision(){return this.properties.getValue(Ln)}get precisionFromPV(){return this.properties.getValue(Pn)}get showLohi(){return this.properties.getValue(kn)}get showUnits(){return this.properties.getValue(Mn)}get vertAlignment(){return this.properties.getValue(Rn)}},En="color_hi",Wn="color_hihi",Bn="color_lo",In="color_lolo",Hn="color_fillbackground",Dn="fill_color",Nn="fillcolor_alarm_sensitive",Fn="font",$n="effect_3d",On="level_hi",Gn="level_hihi",zn="level_lo",Un="level_lolo",qn="limits_from_pv",Yn="log_scale",Xn="maximum",jn="major_tick_step_hint",Kn="minimum",Zn="scale_font",Jn="scale_format",Qn="show_bulb",td="show_hi",ed="show_hihi",id="show_lo",sd="show_lolo",rd="show_markers",od="show_minor_ticks",ad="show_scale",hd="transparent_background",ld="unit",nd="value_label_format",dd=new f(160,160,160),lg=class extends G{constructor(t,e){super(t,e),this.properties.add(new R(En)),this.properties.add(new R(Wn)),this.properties.add(new R(Bn)),this.properties.add(new R(In)),this.properties.add(new R(Hn)),this.properties.add(new R(Dn)),this.properties.add(new y(Nn,!1)),this.properties.add(new y($n)),this.properties.add(new H(On)),this.properties.add(new H(Gn)),this.properties.add(new H(zn)),this.properties.add(new H(Un)),this.properties.add(new y(qn)),this.properties.add(new O(Fn)),this.properties.add(new y(Yn)),this.properties.add(new H(Xn)),this.properties.add(new H(jn)),this.properties.add(new H(Kn)),this.properties.add(new O(Zn)),this.properties.add(new A(Jn)),this.properties.add(new y(Qn)),this.properties.add(new y(td)),this.properties.add(new y(ed)),this.properties.add(new y(id)),this.properties.add(new y(sd)),this.properties.add(new y(rd)),this.properties.add(new y(od)),this.properties.add(new y(ad)),this.properties.add(new y(hd)),this.properties.add(new b(ld)),this.properties.add(new A(nd))}draw(t){let{scale:e,min:i,max:s}=this,r=this.area;this.borderAlarmSensitive&&(r=U(this.area,2*this.scale));let o=this.alarmSensitiveBackgroundColor,a=this.alarmSensitiveForegroundColor,h=this.alarmSensitiveFillColor;this.transparentBackground||t.fillRect(_(C({},r),{color:o}));let l=r.height;if(this.showBulb){let M=Math.min(r.width/2,this.bulbMaxDiameter);l=r.height<M?0:r.height-M}let d=_(C({},r),{height:l}),n=new Tt(this.display.formatter,e,this.scaleFont,i,s,this.logScale,this.majorTickStepHint,a,this.showMinorTicks,this.showScale);n.scaleFormat=this.scaleFormat;let p=0,g="";if(this.unit===0?g="\xB0C":this.unit===1?g="\xB0F":this.unit===2&&(g="K"),g){let M=it.ARIAL_9.scale(e),k=t.measureText(g,M),W=2*e;p=k.height+2*W,t.fillText({x:r.x+r.width/2-this.pipeWidth/2-W,y:r.y+W,baseline:"top",align:"right",color:a,font:M,text:g})}let v=d.x+d.width/2-this.pipeWidth/2-1*e,w=_(C({},d),{y:d.y+p,height:d.height-p+n.calculateMargin(t,!1)}),T=n.drawVertical(t,v,w.y,w.height,!1),B=Math.floor(this.pipeWidth/2);if(d=_(C({},d),{y:n.getValuePosition(s)-B,height:n.scaleLength+2*B}),this.drawPipe(t,d,n),this.showMarkers&&this.drawMarkers(t,r,n),this.showBulb){let M=Math.min(r.width/2,this.bulbMaxDiameter),k=1*e,W=r.x+r.width/2,D=r.y+l+M/2,N=M/2,j=M/2;if(t.fillEllipse({cx:W,cy:D,rx:N,ry:j,color:h}),this.effect3d){let tt=t.createLinearGradient(W-N,D-j,W+N,D+j);tt.addColorStop(0,f.WHITE.toString()),tt.addColorStop(1,h.withAlpha(0).toString()),t.fillEllipse({cx:W,cy:D,rx:N,ry:j,gradient:tt})}t.strokeEllipse({cx:W,cy:D,rx:N-k/2,ry:j-k/2,color:this.effect3d?dd:a,lineWidth:k});let J={x:Math.round(d.x+d.width/2-this.pipeWidth/2)+this.outlineWidth,y:Math.floor(n.getValuePosition(i)),width:this.pipeWidth-2*this.outlineWidth,height:e*3};if(this.effect3d){let tt=Math.round(d.x+d.width/2-this.pipeWidth/2),lt=tt+this.pipeWidth,rt=t.createLinearGradient(tt,J.y,lt,J.y);rt.addColorStop(0,f.WHITE.toString()),rt.addColorStop(1,h.toString()),t.fillRect(_(C({},J),{gradient:rt}))}else t.fillRect(_(C({},J),{color:h}));let ht=this.pv?.value;ht&&t.fillText({x:W,y:D,align:"center",baseline:"middle",color:h.contrast(),font:this.font,text:this.format(ht)})}}drawPipe(t,e,i){let{scale:s,outlineWidth:r,min:o,max:a}=this,h=this.alarmSensitiveForegroundColor,l=this.alarmSensitiveFillColor,d={x:Math.round(e.x+e.width/2-this.pipeWidth/2),y:e.y,width:this.pipeWidth,height:e.height},n=this.getFillValue(),p=i.getValuePosition(n);a>o?n>a?p-=10*s:n<o&&(p+=10*s):n>o?p+=10*s:n<a&&(p-=10*s);let g=this.pipeWidth/2,{x:v,y:w,width:T,height:B}=d;if(this.effect3d){let k=t.createLinearGradient(v,w,v+T,w);k.addColorStop(0,f.WHITE.toString()),k.addColorStop(1,this.colorFillbackground.toString()),t.fillRect(_(C({},d),{rx:g/2,ry:g/2,gradient:k})),k=t.createLinearGradient(v,w,v+T,w),k.addColorStop(0,f.WHITE.toString()),k.addColorStop(1,l.toString()),t.fillRect({x:v,y:p,width:T,height:w+B-p,rx:g/2,ry:g/2,gradient:k})}else t.fillRect(_(C({},d),{rx:g/2,ry:g/2,color:this.colorFillbackground})),t.fillRect({x:v,y:p,width:T,height:w+B-p,rx:g/2,ry:g/2,color:l});let M=U(d,r/2);t.strokeRect(_(C({},M),{rx:g/2,ry:g/2,color:this.effect3d?dd:h,lineWidth:r}))}drawMarkers(t,e,i){let{lolo:s,lo:r,hi:o,hihi:a}=this,h=it.ARIAL_9.scale(this.scale),l=e.x+e.width/2+this.pipeWidth/2;if(this.showLoLo&&s!==void 0){let d=Math.round(i.getValuePosition(s));t.strokePath({path:new S(l,d).lineTo(l+this.markerTickLength,d),color:this.colorLoLo,lineWidth:this.markerTickLineWidth}),t.fillText({x:l+this.markerTickLength+this.markerGap,y:d,text:"LOLO",align:"left",baseline:"middle",color:this.colorLoLo,font:h})}if(this.showLo&&r!==void 0){let d=Math.round(i.getValuePosition(r));t.strokePath({path:new S(l,d).lineTo(l+this.markerTickLength,d),color:this.colorLo,lineWidth:this.markerTickLineWidth}),t.fillText({x:l+this.markerTickLength+this.markerGap,y:d,text:"LO",align:"left",baseline:"middle",color:this.colorLo,font:h})}if(this.showHi&&o!==void 0){let d=Math.round(i.getValuePosition(o));t.strokePath({path:new S(l,d).lineTo(l+this.markerTickLength,d),color:this.colorHi,lineWidth:this.markerTickLineWidth}),t.fillText({x:l+this.markerTickLength+this.markerGap,y:d,text:"HI",align:"left",baseline:"middle",color:this.colorHi,font:h})}if(this.showHiHi&&a!==void 0){let d=Math.round(i.getValuePosition(a));t.strokePath({path:new S(l,d).lineTo(l+this.markerTickLength,d),color:this.colorHiHi,lineWidth:this.markerTickLineWidth}),t.fillText({x:l+this.markerTickLength+this.markerGap,y:d,text:"HIHI",align:"left",baseline:"middle",color:this.colorHiHi,font:h})}}get min(){return this.limitsFromPv?this.pv?.lowerDisplayLimit??this.minimum:this.minimum}get max(){return this.limitsFromPv?this.pv?.upperDisplayLimit??this.maximum:this.maximum}get lolo(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.lowerAlarmLimit:this.levelLoLo}get lo(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.lowerWarningLimit:this.levelLo}get hi(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.upperWarningLimit:this.levelHi}get hihi(){return this.limitsFromPv&&this.pv&&!this.pv.disconnected?this.pv.upperAlarmLimit:this.levelHiHi}get pipeWidth(){return this.scale*15}get bulbMaxDiameter(){return this.scale*40}get outlineWidth(){return this.scale*1}get markerTickLength(){return this.scale*10}get markerTickLineWidth(){return this.scale*2}get markerGap(){return this.scale*3}get alarmSensitiveFillColor(){if(this.fillColorAlarmSensitive){if(this.isMajorSeverity())return this.display.majorColor;if(this.isMinorSeverity())return this.display.minorColor}return this.fillColor}getFillValue(){let t=this.pv?.value??this.min;return t=Math.max(this.min,t),t=Math.min(this.max,t),t}format(t){return this.valueLabelFormat?new Qt(this.valueLabelFormat).format(t):String(Number(t.toFixed(3)))}get colorLo(){return this.properties.getValue(Bn)}get colorLoLo(){return this.properties.getValue(In)}get colorHi(){return this.properties.getValue(En)}get colorHiHi(){return this.properties.getValue(Wn)}get colorFillbackground(){return this.properties.getValue(Hn)}get fillColorAlarmSensitive(){return this.properties.getValue(Nn)}get fillColor(){return this.properties.getValue(Dn)}get font(){return this.properties.getValue(Fn).scale(this.scale)}get effect3d(){return this.properties.getValue($n)}get levelLo(){return this.properties.getValue(zn)}get levelLoLo(){return this.properties.getValue(Un)}get levelHi(){return this.properties.getValue(On)}get levelHiHi(){return this.properties.getValue(Gn)}get limitsFromPv(){return this.properties.getValue(qn)}get logScale(){return this.properties.getValue(Yn)}get minimum(){return this.properties.getValue(Kn)}get majorTickStepHint(){return this.scale*this.properties.getValue(jn)}get maximum(){return this.properties.getValue(Xn)}get scaleFont(){return this.properties.getValue(Zn).scale(this.scale)}get scaleFormat(){return this.properties.getValue(Jn)}get showBulb(){return this.properties.getValue(Qn)}get showMarkers(){return this.properties.getValue(rd)}get showMinorTicks(){return this.properties.getValue(od)}get showLo(){return this.properties.getValue(id)}get showLoLo(){return this.properties.getValue(sd)}get showHi(){return this.properties.getValue(td)}get showHiHi(){return this.properties.getValue(ed)}get showScale(){return this.properties.getValue(ad)}get transparentBackground(){return this.properties.getValue(hd)}get unit(){return this.properties.getValue(ld)}get valueLabelFormat(){return this.properties.getValue(nd)}},ud=-323.3062,pd=308.2547,ng=class{constructor(t,e){this.widget=t,this.index=e}linearScale;_effectiveMinimum;_effectiveMaximum;get scale(){return this.widget.scale}getValue(t){return this.widget.properties.getValue(`axis_${this.index}_${t}`)}isDateEnabled(){return this.timeFormat!==0}isHorizontal(){return this.index===0||this.index!==1&&!this.yAxis}isVertical(){return!this.isHorizontal()}isPrimary(){return this.index<=1}get effectiveMinimum(){return this._effectiveMinimum??this.minimum}set effectiveMinimum(t){this._effectiveMinimum=t}get effectiveMaximum(){return this._effectiveMaximum??this.maximum}set effectiveMaximum(t){this._effectiveMaximum=t}performAutoScale(){let t={start:this.minimum,stop:this.maximum},e=this.widget.calculateAutoscaledRange(this,t);e&&(this.effectiveMinimum=e.start,this.effectiveMaximum=e.stop,this.widget.requestRepaint())}applyZoom(t,e){let i=this.effectiveMinimum,s=this.effectiveMaximum,r,o;if(this.logScale){s=Math.log10(s),i=Math.log10(i);let a=Math.log10(t)*e,h=1-e;r=a+i*h,o=a+s*h,r<ud&&(r=ud),r=Math.pow(10,r),o>pd&&(o=pd),o=Math.pow(10,o)}else{let a=Math.max(Math.abs(i),Math.abs(s));i/=a,s/=a;let h=t/a*e,l=1-e;r=(h+i*l)*a,o=(h+s*l)*a}this.effectiveMinimum=r,this.effectiveMaximum=o,this.widget.requestRepaint()}get autoScale(){return this.getValue("auto_scale")}get autoScaleTreshold(){return this.getValue("auto_scale_treshold")}get axisColor(){return this.getValue("axis_color")}get axisTitle(){return this.getValue("axis_title")}get dashGridLine(){return this.getValue("dash_grid_line")}get gridColor(){return this.getValue("grid_color")}get leftBottomSide(){return this.getValue("left_bottom_side")}get logScale(){return this.getValue("log_scale")}get maximum(){return this.getValue("maximum")}get minimum(){return this.getValue("minimum")}get scaleFont(){return this.getValue("scale_font").scale(this.scale)}get scaleFormat(){return this.getValue("scale_format")}get showGrid(){return this.getValue("show_grid")}get timeFormat(){return this.getValue("time_format")}get titleFont(){return this.getValue("title_font").scale(this.scale)}get visible(){return this.getValue("visible")}get yAxis(){return this.getValue("y_axis")}},_t=class{constructor(t,e){this.xAxis=t,this.yAxis=e;for(let i of t)this.beforeXRanges.push({min:i.effectiveMinimum,max:i.effectiveMaximum});for(let i of e)this.beforeYRanges.push({min:i.effectiveMinimum,max:i.effectiveMaximum})}beforeXRanges=[];beforeYRanges=[];afterXRanges=[];afterYRanges=[];saveState(){for(let t of this.xAxis)this.afterXRanges.push({min:t.effectiveMinimum,max:t.effectiveMaximum});for(let t of this.yAxis)this.afterYRanges.push({min:t.effectiveMinimum,max:t.effectiveMaximum})}undo(){for(let t=0;t<this.xAxis.length;t++){let e=this.xAxis[t],i=this.beforeXRanges[t];e.effectiveMinimum=i.min,e.effectiveMaximum=i.max}for(let t=0;t<this.yAxis.length;t++){let e=this.yAxis[t],i=this.beforeYRanges[t];e.effectiveMinimum=i.min,e.effectiveMaximum=i.max}}redo(){for(let t=0;t<this.xAxis.length;t++){let e=this.xAxis[t],i=this.afterXRanges[t];e.effectiveMinimum=i.min,e.effectiveMaximum=i.max}for(let t=0;t<this.yAxis.length;t++){let e=this.yAxis[t],i=this.afterYRanges[t];e.effectiveMinimum=i.min,e.effectiveMaximum=i.max}}},dg=class{undoStack=[];redoStack=[];canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}add(t){this.undoStack.push(t),this.redoStack.length=0}undo(){let t=this.undoStack.pop();t&&(t.undo(),this.redoStack.push(t))}redo(){let t=this.redoStack.pop();t&&(t.redo(),this.undoStack.push(t))}},ug=class{constructor(t,e){this.widget=e,this.id=t}id;cursor;selection;grabStart;prevGrabEvent;grabZoomCommand;tooltip(){return this.widget.tooltip}mouseDown(t){let{widget:e}=this;switch(e.toolbar?.currentTool){case"rubberband-zoom":case"horizontal-zoom":case"vertical-zoom":this.grabStart=t;break;case"panning":this.grabZoomCommand=new _t(e.getXAxes(),e.getYAxes());break}}grab(t){switch(this.widget.toolbar?.currentTool){case"rubberband-zoom":case"horizontal-zoom":case"vertical-zoom":this.grabStart&&(this.selection=_(C({},this.grabStart.point),{width:t.dx,height:t.dy}),this.widget.requestRepaint());break;case"panning":this.pan(t),this.prevGrabEvent=t,this.widget.requestRepaint();break}}grabEnd(){let{grabZoomCommand:t,selection:e,widget:i}=this;switch(i.toolbar?.currentTool){case"rubberband-zoom":if(e){let s=new _t(i.getXAxes(),i.getYAxes());this.rangeZoomXAxes(e),this.rangeZoomYAxes(e),s.saveState(),i.toolbar.addCommand(s)}break;case"horizontal-zoom":if(e){let s=new _t(i.getXAxes(),i.getYAxes());this.rangeZoomXAxes(e),s.saveState(),i.toolbar.addCommand(s)}break;case"vertical-zoom":if(e){let s=new _t(i.getXAxes(),i.getYAxes());this.rangeZoomYAxes(e),s.saveState(),i.toolbar.addCommand(s)}break;case"panning":t&&(t.saveState(),i.toolbar.addCommand(t));break}this.selection=void 0,this.prevGrabEvent=void 0,this.grabZoomCommand=void 0,this.widget.requestRepaint()}click(t){let{widget:e}=this;switch(e.toolbar?.currentTool){case"zoom-in":let i=new _t(e.getXAxes(),e.getYAxes());for(let r of e.getAxes()){let o=r.isHorizontal()?t.point.x:t.point.y,a=r.linearScale.getPositionValue(o);r.applyZoom(a,.1)}i.saveState(),e.toolbar.addCommand(i);break;case"zoom-out":let s=new _t(e.getXAxes(),e.getYAxes());for(let r of e.getAxes()){let o=r.isHorizontal()?t.point.x:t.point.y,a=r.linearScale.getPositionValue(o);r.applyZoom(a,-.1)}s.saveState(),e.toolbar.addCommand(s);break}}rangeZoomXAxes(t){for(let e of this.widget.getXAxes()){let i=e.linearScale.getPositionValue(t.x),s=e.linearScale.getPositionValue(t.x+t.width);if(i>s){let o=i;i=s,s=o}let r=e.linearScale.getMinMax();i=Math.max(r.start,i),s=Math.min(r.stop,s),e.effectiveMinimum=i,e.effectiveMaximum=s}}rangeZoomYAxes(t){for(let e of this.widget.getYAxes()){let i=e.linearScale.getPositionValue(t.y),s=e.linearScale.getPositionValue(t.y+t.height);if(i>s){let o=i;i=s,s=o}let r=e.linearScale.getMinMax();i=Math.max(r.start,i),s=Math.min(r.stop,s),e.effectiveMinimum=i,e.effectiveMaximum=s}}pan(t){let{prevGrabEvent:e,widget:i}=this;if(e){let s=e.dx-t.dx;if(s!==0)for(let o of i.getXAxes()){let a=o.linearScale,h=a.getMinMax(),l=a.getValuePosition(h.start)+s,d=a.getValuePosition(h.stop)+s;o.effectiveMinimum=a.getPositionValue(l),o.effectiveMaximum=a.getPositionValue(d)}let r=e.dy-t.dy;if(r!==0)for(let o of i.getYAxes()){let a=o.linearScale,h=a.getMinMax(),l=a.getValuePosition(h.start)+r,d=a.getValuePosition(h.stop)+r;o.effectiveMinimum=a.getPositionValue(l),o.effectiveMaximum=a.getPositionValue(d)}}}},pg=class{pointer=0;samples=[];constructor(t){this.samples=Array(t).fill(void 0)}push(t,e){this.samples[this.pointer]={x:t,y:e},this.pointer=(this.pointer+1)%this.samples.length}clear(){this.samples.fill(void 0),this.pointer=0}isFull(){let t=(this.pointer+1)%this.samples.length;return this.samples[t]!==void 0}isEmpty(){return this.tail()===void 0}tail(){return this.pointer===0?this.samples[this.samples.length-1]:this.samples[this.pointer-1]}snapshot(t=!1){if(t)return this.samples.filter(e=>e!==void 0).sort((e,i)=>e.x-i.x);{let e=this.samples.slice(this.pointer).filter(s=>s!==void 0),i=this.samples.slice(0,this.pointer).filter(s=>s!==void 0);return e.concat(i)}}},cg=class{constructor(t,e,i,s,r,o){this.bufferSize=t,this.plotMode=e,this.updateMode=i,this.concatenateData=s,this.chronological=r,this.historicalDataProvider=o,this.traceData=new pg(t)}traceData;x=0;xPending=!1;y=0;yTimestamp=0;yPending=!1;xArray=[];xArrayPending=!1;yArray=[];yArrayPending=!1;clear(){this.traceData.clear(),this.x=0,this.xPending=!1,this.y=0,this.yPending=!1,this.yTimestamp=0,this.xArray=[],this.xArrayPending=!1,this.yArray=[],this.yArrayPending=!1}snapshot(){return this.historicalDataProvider?this.historicalDataProvider.getSamples():this.traceData.snapshot()}updateX(t){this.x=t,this.xPending=!0,this.maybeAddPoint()}updateY(t,e){this.y=t,this.yTimestamp=e,this.yPending=!0,this.maybeAddPoint()}updateXArray(t){this.xArray=t,this.xArrayPending=!0,this.maybeAddArray()}updateYArray(t){this.yArray=t,this.yArrayPending=!0,this.maybeAddArray()}maybeAddPoint(){if(this.plotMode===1&&this.traceData.isFull())return;let{xPending:t,yPending:e,chronological:i,updateMode:s}=this;s===0?(i&&e||!i&&(t||e))&&this.addPoint():s===1?(i&&e||!i&&t&&e)&&this.addPoint():s===2?(i&&e||!i&&t)&&this.addPoint():s===3&&this.yPending&&this.addPoint()}maybeAddArray(){if(this.plotMode===1&&this.traceData.isFull())return;let{xArrayPending:t,yArrayPending:e,chronological:i,updateMode:s}=this;s===0?(i&&e||!i&&(t||e))&&this.addArray():s===1?(i&&e||!i&&t&&e)&&this.addArray():s===2?(i&&e||!i&&t)&&this.addArray():s===3&&this.yArrayPending&&this.addArray()}addPoint(){this.concatenateData||this.traceData.clear();let t=this.x;if(this.chronological)if(this.updateMode===5)t=new Date().getTime();else if(this.yTimestamp!==void 0)t=this.yTimestamp;else{let e=this.traceData.tail();t=e?e.x+1:0}this.traceData.push(t,this.y),this.xPending=!1,this.yPending=!1}addArray(){this.concatenateData||this.traceData.clear();let{xArray:t,yArray:e}=this;if(this.chronological)if(t=Array(e.length),this.traceData.isEmpty())for(let r=0;r<e.length;r++)t[r]=r;else{let r=this.traceData.tail();for(let o=1;o<e.length;o++)t[o-1]=r.x+o}let i=Math.min(t.length,e.length),s=Math.min(i,this.bufferSize);for(let r=0;r<s;r++)this.traceData.push(t[r],e[r]);this.xArrayPending=!1,this.yArrayPending=!1}},gg=class{constructor(t,e){this.widget=t,this.i=e}traceData;historicalDataProvider;xPVInstance;yPVInstance;xPVListener=()=>{let t=this.xPVInstance;if(t)if(Array.isArray(t.value))this.traceData?.updateXArray(t.value);else{let e=t.toNumber();e!=null&&this.traceData?.updateX(e)}};yPVListener=()=>{let t=this.yPVInstance;if(t)if(Array.isArray(t.value))this.traceData?.updateYArray(t.value);else{let e=this.widget.getAxis(this.xAxisIndex),i=t.toNumber();if(i!=null)if(e.isDateEnabled()){let s=(t.time||new Date).getTime();this.traceData?.updateY(i,s)}else this.traceData?.updateY(i)}};init(){let{bufferSize:t,plotMode:e,updateMode:i,concatenateData:s,widget:r}=this,o=!this.xPV,{pvEngine:a}=r.display;this.historicalDataProvider=void 0,o&&this.yPV&&(this.historicalDataProvider=a.createHistoricalDataProvider(this.yPV,r)||void 0),this.traceData=new cg(t,e,i,s,o,this.historicalDataProvider),this.xPV&&(this.xPVInstance=a.createPV(this.xPV),this.xPVInstance.addListener(this.xPVListener)),this.yPV&&(this.yPVInstance=a.createPV(this.yPV),this.yPVInstance.addListener(this.yPVListener)),r.addPropertyListener(`trace_${this.i}_x_pv`,()=>{let h=a.createPV(this.xPV);h!==this.xPVInstance&&(this.xPVInstance?.removeListener(this.xPVListener),this.xPVInstance=h,this.xPVInstance.addListener(this.xPVListener))}),r.addPropertyListener(`trace_${this.i}_y_pv`,()=>{let h=a.createPV(this.yPV);h!==this.yPVInstance&&(this.yPVInstance?.removeListener(this.yPVListener),this.yPVInstance=h,this.yPVInstance.addListener(this.yPVListener))})}snapshot(){return this.traceData?.snapshot()||[]}drawTrace(t,e){let{lineWidth:i}=this;if(this.traceType===0)t.strokePath({path:S.fromPoints(e),color:this.traceColor,lineWidth:i});else if(this.traceType===1)t.strokePath({path:S.fromPoints(e),color:this.traceColor,lineWidth:i,dash:[6*this.scale,2*this.scale]});else if(this.traceType!==2){if(this.traceType===3){let s=this.widget.getAxis(this.yAxisIndex).linearScale.getValuePosition(0);for(let r of e)r.y!==null&&t.strokePath({path:new S(r.x,r.y).lineTo(r.x,s),lineWidth:i,color:this.traceColor,opacity:100/255})}else if(this.traceType===4||this.traceType===5){let s=this.widget.getAxis(this.yAxisIndex).linearScale.getValuePosition(0);for(let r=1;r<e.length;r++){let o=e[r-1],a=e[r];o.y!==null&&a.y!==null&&t.fillPath({path:new S(o.x,o.y).lineTo(o.x,s).lineTo(a.x,s).lineTo(a.x,a.y),color:this.traceColor,opacity:100/255})}this.traceType===5&&t.strokePath({path:S.fromPoints(e),color:this.traceColor,lineWidth:i})}else if(this.traceType===6)for(let s=1;s<e.length;s++){let r=e[s-1],o=e[s];r.y!==null&&o.y!==null&&t.strokePath({path:new S(r.x,r.y).lineTo(r.x,o.y).lineTo(o.x,o.y),color:this.traceColor,lineWidth:i})}else if(this.traceType===7)for(let s=1;s<e.length;s++){let r=e[s-1],o=e[s];r.y!==null&&o.y!==null&&t.strokePath({path:new S(r.x,r.y).lineTo(o.x,r.y).lineTo(o.x,o.y),color:this.traceColor,lineWidth:i})}else if(this.traceType===8){let{scale:s}=this;t.strokePath({path:S.fromPoints(e),color:this.traceColor,lineWidth:i,dash:[6*s,2*s,2*s,2*s]})}else if(this.traceType===9){let{scale:s}=this;t.strokePath({path:S.fromPoints(e),color:this.traceColor,lineWidth:i,dash:[6*s,2*s,2*s,2*s,2*s,2*s]})}else if(this.traceType===10){let{scale:s}=this;t.strokePath({path:S.fromPoints(e),color:this.traceColor,lineWidth:i,dash:[2*s,2*s]})}}}drawPoint(t,e){t.ctx.fillStyle=this.traceColor.toString(),t.ctx.strokeStyle=this.traceColor.toString(),t.ctx.lineWidth=1*this.scale;let i=this.pointSize/2,s=e.x,r=e.y;switch(this.pointStyle){case 1:t.ctx.beginPath(),t.ctx.ellipse(s,r,i,i,0,0,2*Math.PI),t.ctx.fill();break;case 2:t.ctx.beginPath(),t.ctx.ellipse(s,r,i,i,0,0,2*Math.PI),t.ctx.stroke();break;case 3:t.ctx.beginPath(),t.ctx.ellipse(s,r,i,i,0,0,2*Math.PI),t.ctx.fill();break;case 4:t.ctx.lineWidth=1*this.scale,t.ctx.beginPath(),t.ctx.moveTo(s-i,r+i),t.ctx.lineTo(s,r-i),t.ctx.lineTo(s+i,r+i),t.ctx.closePath(),t.ctx.stroke();break;case 5:t.ctx.lineWidth=1*this.scale,t.ctx.beginPath(),t.ctx.moveTo(s-i,r+i),t.ctx.lineTo(s,r-i),t.ctx.lineTo(s+i,r+i),t.ctx.closePath(),t.ctx.fill();break;case 6:t.ctx.strokeRect(s-i,r-i,2*i,2*i);break;case 7:t.ctx.fillRect(s-i,r-i,2*i,2*i);break;case 8:t.ctx.beginPath(),t.ctx.moveTo(s-i,r),t.ctx.lineTo(s,r-i),t.ctx.lineTo(s+i,r),t.ctx.lineTo(s,r+i),t.ctx.closePath(),t.ctx.stroke();break;case 9:t.ctx.beginPath(),t.ctx.moveTo(s-i,r),t.ctx.lineTo(s,r-i),t.ctx.lineTo(s+i,r),t.ctx.lineTo(s,r+i),t.ctx.closePath(),t.ctx.stroke();break;case 10:t.ctx.beginPath(),t.ctx.moveTo(s-i,r-i),t.ctx.lineTo(s+i,r+i),t.ctx.moveTo(s+i,r-i),t.ctx.lineTo(s-i,r+i),t.ctx.stroke();break;case 11:t.ctx.beginPath(),t.ctx.moveTo(s-i,r),t.ctx.lineTo(s+i,r),t.ctx.moveTo(s,r-i),t.ctx.lineTo(s,r+i),t.ctx.stroke();break;case 12:t.ctx.beginPath(),t.ctx.moveTo(s,r-i),t.ctx.lineTo(s,r+i),t.ctx.stroke()}}clearData(){this.traceData?.clear()}get scale(){return this.widget.scale}getValue(t){return this.widget.properties.getValue(`trace_${this.i}_${t}`)}get antiAlias(){return this.getValue("anti_alias")}get bufferSize(){return this.getValue("buffer_size")}get concatenateData(){return this.getValue("concatenate_data")}get lineWidth(){return this.scale*this.getValue("line_width")}get name(){return this.getValue("name")}get plotMode(){return this.getValue("plot_mode")}get pointSize(){return this.scale*this.getValue("point_size")}get pointStyle(){return this.getValue("point_style")}get traceColor(){return this.getValue("trace_color")}get traceType(){return this.getValue("trace_type")}get updateDelay(){return this.getValue("update_delay")}get updateMode(){return this.getValue("update_mode")}get visible(){return this.getValue("visible")}get xAxisIndex(){return this.getValue("x_axis_index")}get xPV(){return this.getValue("x_pv")}get yAxisIndex(){return this.getValue("y_axis_index")}get yPV(){return this.getValue("y_pv")}destroy(){this.historicalDataProvider?.disconnect()}},mg=new f(236,236,236),fg=new f(130,130,130),xg=class{constructor(t,e,i,s,r){this.imageFile=e,this.disabledImageFile=i,this.action=r,this.loadPromise=new Promise((o,a)=>{this.imageElement.onload=()=>o()}),this.disabledLoadPromise=new Promise((o,a)=>{this.disabledImageElement.onload=()=>o()}),this.region={id:`${t.xyGraph.wuid}-${e}`,mouseDown:()=>{this.toggleButton||(this.pushed=!0,t.xyGraph.requestRepaint())},mouseOut:()=>{this.toggleButton||(this.pushed=!1),t.xyGraph.requestRepaint()},mouseUp:()=>{this.toggleButton||(this.pushed=!1,t.xyGraph.requestRepaint())},click:()=>{this.toggleButton&&(this.pushed=!this.pushed,this.toolButton&&t.toggleTool(this)),this.action(),t.updateState()},tooltip:()=>s}}imageElement=new Image;disabledImageElement=new Image;loadPromise;disabledLoadPromise;toggleButton=!1;toolButton=!1;pushed=!1;disabled=!1;region;loadImage(t){this.imageElement.src=t+this.imageFile,this.disabledImageElement.src=t+this.disabledImageFile}},wg=class{constructor(t){this.xyGraph=t,this.showLegend=this.createToggleButton("ShowLegend.png","Show Legend",()=>{t.properties.setValue("show_legend",this.showLegend.pushed)}),this.showLegend.pushed=t.showLegend,t.addPropertyListener("show_legend",i=>{this.showLegend.pushed=i}),this.autoScale=this.createButton("AutoScale.png","AutoScale.png","Perform Auto Scale",()=>{let i=new _t(t.getXAxes(),t.getYAxes());t.performAutoScale(),i.saveState(),this.addCommand(i)}),this.rubberbandZoom=this.createToolButton("RubberbandZoom.png","Rubberband Zoom",()=>{this.rubberbandZoom.pushed?(this.currentTool="rubberband-zoom",t.setCursor("crosshair"),t.autoScaleAllowed=!1):(this.currentTool="default",t.setCursor(void 0),t.autoScaleAllowed=!0)}),this.horizontalZoom=this.createToolButton("HorizontalZoom.png","Horizontal Zoom",()=>{this.horizontalZoom.pushed?(this.currentTool="horizontal-zoom",t.setCursor("col-resize"),t.autoScaleAllowed=!1):(this.currentTool="default",t.setCursor(void 0),t.autoScaleAllowed=!0)}),this.verticalZoom=this.createToolButton("VerticalZoom.png","Vertical Zoom",()=>{this.verticalZoom.pushed?(this.currentTool="vertical-zoom",t.setCursor("row-resize"),t.autoScaleAllowed=!1):(this.currentTool="default",t.setCursor(void 0),t.autoScaleAllowed=!0)}),this.zoomIn=this.createToolButton("ZoomIn.png","Zoom In",()=>{this.zoomIn.pushed?(this.currentTool="zoom-in",t.setCursor("zoom-in"),t.autoScaleAllowed=!1):(this.currentTool="default",t.setCursor(void 0),t.autoScaleAllowed=!0)}),this.zoomOut=this.createToolButton("ZoomOut.png","Zoom Out",()=>{this.zoomOut.pushed?(this.currentTool="zoom-out",t.setCursor("zoom-out"),t.autoScaleAllowed=!1):(this.currentTool="default",t.setCursor(void 0),t.autoScaleAllowed=!0)}),this.panning=this.createToolButton("Panning.png","Panning",()=>{this.panning.pushed?(this.currentTool="panning",t.setCursor("grab"),t.autoScaleAllowed=!1):(this.currentTool="default",t.setCursor(void 0),t.autoScaleAllowed=!0)}),this.mouseArrow=this.createToolButton("MouseArrow.png","None",()=>{this.currentTool="default",t.setCursor(void 0),t.autoScaleAllowed=!0}),this.undo=this.createButton("Undo.png","Undo_Gray.png","Undo",()=>{this.commandBuffer.undo()}),this.undo.disabled=!0,this.redo=this.createButton("Redo.png","Redo_Gray.png","Redo",()=>{this.commandBuffer.redo()}),this.redo.disabled=!0,this.camera=this.createButton("camera.png","camera.png","Save Snapshot to PNG File",()=>{let i=document.createElement("a");try{i.href=t.toDataURL(),i.download=`${t.name}_export.png`,document.body.appendChild(i),i.click()}finally{document.body.removeChild(i)}}),this.toggleTool(this.mouseArrow);let e=this.buttons.map(i=>i.loadPromise).concat(this.buttons.map(i=>i.disabledLoadPromise));Promise.all(e).finally(()=>{this.imagesLoaded=!0,t.requestRepaint()});for(let i of this.buttons)i.loadImage(t.display.imagesPrefix)}buttons=[];showLegend;autoScale;rubberbandZoom;horizontalZoom;verticalZoom;zoomIn;zoomOut;panning;mouseArrow;undo;redo;camera;imagesLoaded=!1;currentTool="default";commandBuffer=new dg;updateState(){this.undo.disabled=!this.commandBuffer.canUndo(),this.redo.disabled=!this.commandBuffer.canRedo(),this.xyGraph.requestRepaint()}addCommand(t){this.commandBuffer.add(t),this.updateState()}toggleTool(t){let e=t.pushed;for(let i of this.buttons)i.toolButton&&(i.pushed=!1);e?t.pushed=!0:this.mouseArrow.pushed=!0,this.xyGraph.requestRepaint()}createToolButton(t,e,i){let s=this.createToggleButton(t,e,i);return s.toolButton=!0,s}createToggleButton(t,e,i){let s=this.createButton(t,t,e,i);return s.toggleButton=!0,s}createButton(t,e,i,s){let r=new xg(this,t,e,i,s);return this.buttons.push(r),r}draw(t,e){let{buttonSize:i}=this,s={x:e.x,y:e.y};return this.drawButton(t,s.x,s.y,this.showLegend),s.x+=i,this.maybeWrap(s,e),this.drawButton(t,s.x,s.y,this.autoScale),s.x+=i,this.maybeWrap(s,e,i/2),this.drawSeparator(t,s.x,s.y),s.x+=i/2,this.maybeWrap(s,e),this.drawButton(t,s.x,s.y,this.rubberbandZoom),s.x+=i,this.maybeWrap(s,e),this.drawButton(t,s.x,s.y,this.horizontalZoom),s.x+=i,this.maybeWrap(s,e),this.drawButton(t,s.x,s.y,this.verticalZoom),s.x+=i,this.maybeWrap(s,e),this.drawButton(t,s.x,s.y,this.zoomIn),s.x+=i,this.maybeWrap(s,e),this.drawButton(t,s.x,s.y,this.zoomOut),s.x+=i,this.maybeWrap(s,e),this.drawButton(t,s.x,s.y,this.panning),s.x+=i,this.maybeWrap(s,e),this.drawButton(t,s.x,s.y,this.mouseArrow),s.x+=i,this.maybeWrap(s,e,i/2),this.drawSeparator(t,s.x,s.y),s.x+=i/2,this.maybeWrap(s,e),this.drawButton(t,s.x,s.y,this.undo),s.x+=i,this.maybeWrap(s,e),this.drawButton(t,s.x,s.y,this.redo),s.x+=i,this.maybeWrap(s,e,i/2),this.drawSeparator(t,s.x,s.y),s.x+=i/2,this.maybeWrap(s,e),this.drawButton(t,s.x,s.y,this.camera),s.x+=i,s.y+i-e.y}maybeWrap(t,e,i){i=i??this.buttonSize,t.x+i>e.x+e.width&&(t.x=e.x,t.y+=this.buttonSize)}drawSeparator(t,e,i){let{buttonSize:s}=this,r=1*this.scale,o=Math.round(e+s/4)-r/2;t.strokePath({path:new S(o,i).lineTo(o,i+s),color:fg,lineWidth:r})}drawButton(t,e,i,s){let{buttonSize:r,scale:o}=this;t.fillRect({x:e,y:i,width:r,height:r,color:mg}),this.xyGraph.enabled&&!s.disabled&&t.addHitRegion(s.region).addRect(e,i,r,r);let a=1*o,h=Math.round(i+a/2)-.5,l=Math.round(e+a/2)-.5,d=Math.round(i+r-a+a/2)-.5,n=Math.round(e+r-a+a/2)-.5;if(t.strokePath({color:s.pushed?f.WHITE:f.BLACK,path:new S(n,d).lineTo(n,h).moveTo(n,d).lineTo(l,d),lineWidth:a}),t.strokePath({color:s.pushed?f.BLACK:f.WHITE,path:new S(l,h).lineTo(n-a,h).moveTo(l,h).lineTo(l,d-a),lineWidth:a}),this.imagesLoaded){let p=s.disabled?s.disabledImageElement:s.imageElement,g=p.naturalHeight*o,v=p.naturalWidth*o,w=Math.round(e+(r-v)/2),T=Math.round(i+(r-g)/2);t.ctx.drawImage(p,w,T,v,g)}}get scale(){return this.xyGraph.scale}get buttonSize(){return 25*this.scale}},Me="axis_count",cd="plot_area_background_color",gd="show_legend",md="show_plot_area_border",fd="show_toolbar",xd="title",wd="title_font",Re="trace_count",yd="transparent",yg=class extends G{toolbar;plotAreaRegion;axes=[];traces=[];autoScaleAllowed=!0;constructor(t,e){super(t,e),this.properties.add(new b(Me)),this.properties.add(new R(cd)),this.properties.add(new y(gd)),this.properties.add(new y(md)),this.properties.add(new y(fd)),this.properties.add(new A(xd)),this.properties.add(new O(wd)),this.properties.add(new b(Re)),this.properties.add(new y(yd)),this.properties.addGenerator(()=>{let i=[];this.axes=[];let s=this.properties.getValue(Me);for(let o=0;o<s;o++)this.axes.push(new ng(this,o)),i.push(new y(`axis_${o}_auto_scale`),new H(`axis_${o}_auto_scale_treshold`),new R(`axis_${o}_axis_color`),new A(`axis_${o}_axis_title`),new y(`axis_${o}_dash_grid_line`),new R(`axis_${o}_grid_color`),new y(`axis_${o}_log_scale`),new H(`axis_${o}_maximum`),new H(`axis_${o}_minimum`),new O(`axis_${o}_scale_font`),new A(`axis_${o}_scale_format`),new y(`axis_${o}_show_grid`),new b(`axis_${o}_time_format`),new O(`axis_${o}_title_font`),new y(`axis_${o}_visible`)),o>1&&i.push(new y(`axis_${o}_left_bottom_side`),new y(`axis_${o}_y_axis`));this.traces=[];let r=this.properties.getValue(Re);for(let o=0;o<r;o++)this.traces.push(new gg(this,o)),i.push(new y(`trace_${o}_anti_alias`),new b(`trace_${o}_buffer_size`),new y(`trace_${o}_concatenate_data`),new b(`trace_${o}_line_width`),new A(`trace_${o}_name`),new b(`trace_${o}_plot_mode`),new b(`trace_${o}_point_size`),new b(`trace_${o}_point_style`),new R(`trace_${o}_trace_color`),new b(`trace_${o}_trace_type`),new b(`trace_${o}_update_delay`),new b(`trace_${o}_update_mode`),new y(`trace_${o}_visible`),new b(`trace_${o}_x_axis_index`),new A(`trace_${o}_x_pv`),new Jt(`trace_${o}_x_pv_value`,`trace_${o}_x_pv`),new b(`trace_${o}_y_axis_index`),new A(`trace_${o}_y_pv`),new Jt(`trace_${o}_y_pv_value`,`trace_${o}_y_pv`));return i})}init(){this.plotAreaRegion=new ug(`${this.wuid}-plotarea`,this),this.traces.forEach(t=>t.init())}draw(t){let{scale:e}=this,i=this.area;if(this.borderAlarmSensitive&&(i=U(this.area,2*e)),!this.transparent){let o=this.alarmSensitiveBackgroundColor;t.fillRect(_(C({},i),{color:o}))}this.showToolbar&&this.drawToolbar(t,i),this.title&&this.drawTitle(t,i);for(let o of this.axes){if(o.autoScale&&this.autoScaleAllowed){let l={start:o.minimum,stop:o.maximum},d=this.calculateAutoscaledRange(o,l);d&&(o.effectiveMinimum=d.start,o.effectiveMaximum=d.stop)}let a=o.effectiveMinimum,h=o.effectiveMaximum;o.linearScale=new Tt(this.display.formatter,e,o.scaleFont,a,h,o.logScale,50*e,o.axisColor,!0,o.visible),o.linearScale.scaleFormat=o.scaleFormat,o.linearScale.timeFormat=o.timeFormat}this.showLegend&&this.drawLegend(t,i),t.addHitRegion(this.plotAreaRegion).addRect(i.x,i.y,i.width,i.height);let s=this.drawAxes(t,i);this.drawPlotArea(t,s);let r=this.plotAreaRegion?.selection;r&&this.drawZoomSelection(t,s,sp(s,r))}drawToolbar(t,e){this.toolbar||(this.toolbar=new wg(this));let i=3*this.scale,s=U(e,i),r=this.toolbar.draw(t,s);e.y+=i+r+i,e.height-=i+r+i}drawTitle(t,e){let i=t.measureText(this.title,this.titleFont).height;t.fillText({x:e.x+e.width/2,y:e.y+i/2,align:"center",baseline:"middle",color:this.alarmSensitiveForegroundColor,font:this.titleFont,text:this.title});let s=2*this.scale;e.y+=i+s,e.height-=i+s}drawAxes(t,e){let{scale:i}=this,s=5*i,r=C({},e),o=0,a=0;for(let n of this.getXAxes())if(n.visible){let p=0;n.axisTitle&&(p=s+t.measureText(n.axisTitle,n.titleFont).height),o+=p,a+=p+n.linearScale.measureHorizontalHeight(t)}let h=0,l=0;for(let n of this.getYAxes().reverse()){let p=n.linearScale;if(n.visible){let g=p.calculateMargin(t,!1),v=r.height-a+(a>0?g:0),w=0;n.axisTitle&&(w=t.measureText(n.axisTitle,n.titleFont).height,t.ctx.save(),t.ctx.translate(r.x+s+w/2,e.y+v/2),t.ctx.rotate(-Math.PI/2),t.fillText({x:0,y:0,align:"center",baseline:"middle",font:n.titleFont,color:n.axisColor,text:n.axisTitle}),t.ctx.restore(),w+=s);let T=w+p.drawVertical(t,r.x+w,e.y,v,!0,!1);r.x+=T,r.width-=T,h+=T;let B=p.margin;l=l===0?B:Math.min(l,B);let M=i*1,k=Math.round(r.x)-M/2,W=Math.round(e.y+g)-M/2;t.strokePath({path:new S(k,W).lineTo(k,W+v-2*g),color:n.axisColor,opacity:100/255,lineWidth:M})}else{let g=r.height-a;p.setDimensions(0,e.y,g,!1)}}let d=0;for(let n of this.getXAxes().reverse()){let p=n.linearScale;if(n.visible){let g=p.calculateMargin(t,!0),v=h-g,w=0;if(n.axisTitle){w=t.measureText(n.axisTitle,n.titleFont).height;let D=e.x+h+(e.width-h)/2;t.fillText({x:D,y:r.y+r.height-w/2,align:"center",baseline:"middle",font:n.titleFont,color:n.axisColor,text:n.axisTitle}),w+=s}let T=w+p.drawHorizontal(t,e.x+v,r.y+r.height-w,e.width-v);r.height-=T;let B=p.margin;d=d===0?B:Math.min(d,B);let M=i*1,k=Math.round(e.x+v+g)-M/2,W=Math.round(r.y+r.height)-M/2;t.strokePath({path:new S(k,W).lineTo(k+r.width-g,W),color:n.axisColor,opacity:100/255,lineWidth:M})}else{let g=e.x+h,v=e.width-h;p.setDimensions(g,0,v,!0)}}return r.y+=l,r.width-=d,a>0?r.height-=l:r.height-=2*l,r}drawPlotArea(t,e){let{scale:i}=this,s=1*i;if(this.transparent||t.fillRect(_(C({},e),{color:this.plotAreaBackgroundColor})),this.showPlotAreaBorder){let{x:r,y:o,width:a,height:h}=U(e,s/2);t.strokePath({path:new S(r,o).lineTo(r+a,o).lineTo(r+a,o+h),color:f.BLACK,lineWidth:s})}for(let r of this.axes.filter(o=>o.visible&&o.showGrid)){let o=r.linearScale;if(r.isHorizontal())for(let a of o.getGridPositions()){let h=Math.round(o.getX()+a)-s/2;t.strokePath({path:new S(h,e.y).lineTo(h,e.y+e.height),color:r.gridColor,lineWidth:s,dash:r.dashGridLine?[6*i,2*i]:void 0})}else for(let a of o.getGridPositions()){let h=Math.round(o.getY()+a)-s/2;t.strokePath({path:new S(e.x,h).lineTo(e.x+e.width,h),color:r.gridColor,lineWidth:s,dash:r.dashGridLine?[6*i,2*i]:void 0})}}t.ctx.save(),t.ctx.beginPath(),t.ctx.rect(e.x,e.y,e.width,e.height),t.ctx.clip();for(let r of this.traces.filter(o=>o.visible)){let o=this.getAxis(r.xAxisIndex).linearScale,a=this.getAxis(r.yAxisIndex).linearScale,h=[];for(let l of r.snapshot()){let d=o.getValuePosition(l.x),n=l.y!==null?a.getValuePosition(l.y):null;h.push({x:d,y:n})}if(h.length){r.drawTrace(t,h);for(let l of h)l.y!==null&&r.drawPoint(t,l)}}t.ctx.restore()}drawZoomSelection(t,e,i){let{scale:s}=this;switch(this.toolbar?.currentTool){case"rubberband-zoom":t.strokeRect(_(C({},i),{color:f.BLACK,lineWidth:1*s}));break;case"horizontal-zoom":let r=i;r.y=e.y,r.height=e.height,t.strokeRect(_(C({},xi(r)),{color:f.BLACK,lineWidth:1*s}));break;case"vertical-zoom":let o=i;o.x=e.x,o.width=e.width,t.strokeRect(_(C({},xi(o)),{color:f.BLACK,lineWidth:1*s}));break}}drawLegend(t,e){let{scale:i}=this,s=25*i,r=2*i,o=5*i,a=it.ARIAL_10.scale(i);for(let h of this.getYAxes()){let l=this.traces.filter(M=>M.visible&&M.yAxisIndex===h.index),d=[],n=[],p=0,g=0;for(let M of l){let k=s+r+o;M.name&&(k+=t.measureText(M.name,a).width),p+k<e.width?(n.push(M),p+=k):(d.push(n),k=Math.max(k,p),n=[M],p=k)}if(n.length&&(d.push(n),g=Math.max(g,p)),!d.length)continue;let v=s*d.length,w={x:Math.round(e.x+(e.width-g)/2),y:Math.round(e.y+e.height-v),width:g,height:v};e.height-=w.height,this.transparent||t.fillRect(_(C({},w),{color:this.plotAreaBackgroundColor})),t.strokeRect(_(C({},U(w,1*i/2)),{color:h.axisColor}));let T=w.x,B=w.y;for(let M=0;M<d.length;M++){let k=d[M],W=B+M*s,D=W+s/2;for(let N of k){let j=N.pointSize>Math.floor((s-o)/2)?Math.floor(s-o):N.pointSize;switch(N.traceType){case 3:let J=T+s/2;t.strokePath({path:new S(J,W+j).lineTo(J,W+s),lineWidth:N.lineWidth,color:N.traceColor,opacity:100/255}),N.drawPoint(t,{x:J,y:W+j});break;case 4:case 5:let ht=[{x:T,y:W+s/2},{x:T+s/2,y:W+j},{x:T+s,y:W+s/2},{x:T+s,y:W+s},{x:T,y:W+s}];t.fillPath({path:S.fromPoints(ht),color:N.traceColor,opacity:100/255}),N.traceType===5&&t.strokePath({path:S.fromPoints(ht.slice(0,3)),color:N.traceColor,lineWidth:1*i}),N.drawPoint(t,{x:T+s/2,y:W+j});break;default:N.drawTrace(t,[{x:T,y:D},{x:T+s,y:D}]),N.drawPoint(t,{x:T+s/2,y:D})}T+=s+r,N.name&&(t.fillText({x:T,y:D,align:"left",baseline:"middle",color:N.traceColor,font:a,text:N.name}),T+=t.measureText(N.name,a).width),T+=o}}}}setCursor(t){this.plotAreaRegion.cursor=t}calculateAutoscaledRange(t,e){let i,s,r=t.logScale;for(let o of this.traces)if(o.visible&&!(this.axes[o.xAxisIndex]!==t&&this.axes[o.yAxisIndex]!==t))for(let a of o.snapshot()){let h=t.isHorizontal()?a.x:a.y;h!==null&&((i===void 0||i>h)&&(!r||h>0)&&(i=h),(s===void 0||s<h)&&(!r||h>0)&&(s=h))}if(i!==void 0&&s!==void 0)return i===s?{start:Math.min(i,e.start),stop:Math.max(s,e.stop)}:{start:i,stop:s}}performAutoScale(){for(let t of this.axes)t.visible&&t.performAutoScale()}clearGraph(){for(let t of this.traces)t.clearData();this.requestRepaint()}getAxes(){return[...this.axes]}getXAxes(){return this.axes.filter(t=>t.isHorizontal())}getYAxes(){return this.axes.filter(t=>t.isVertical())}getAxis(t){return this.axes[t]}getTrace(t){return this.traces[t]}get axisCount(){return this.properties.getValue(Me)}get plotAreaBackgroundColor(){return this.properties.getValue(cd)}get showLegend(){return this.properties.getValue(gd)}get showPlotAreaBorder(){return this.properties.getValue(md)}get showToolbar(){return this.properties.getValue(fd)}get title(){return this.properties.getValue(xd)}get titleFont(){return this.properties.getValue(wd).scale(this.scale)}get traceCount(){return this.properties.getValue(Re)}get transparent(){return this.properties.getValue(yd)}destroy(){for(let t of this.traces)t.destroy()}},vg=class extends ue{async parseNode(t){await super.parseNode(t);for(let e of t.getNodes("widget")){let i=e.getString("widget_type"),s=this.display.createWidget(i,this);s&&(await s.parseNode(e),this.widgets.push(s))}}beforeDrawBorder(t){this.transparent||t.fillRect({x:this.holderX,y:this.holderY,width:this.holderWidth,height:this.holderHeight,color:this.backgroundColor})}draw(t){let e=t.createChild(this.width,this.height);for(let i of this.widgets.filter(s=>s.visible))i.drawHolder(e),i.draw(e),i.drawDecoration(e);for(let i of this.widgets.filter(s=>s.visible))i.drawOverlay(e);t.copy(e,this.x,this.y)}},vd="minimum_tab_height",Ne="active_tab",bd="horizontal_tabs",Ee="tab_count",bg=class{constructor(t,e){this.widget=t,this.i=e,this.headerRegion={id:`${t.wuid}-header-${e}`,click:()=>{t.activeTab!==e&&(t.properties.setValue(Ne,e),t.requestRepaint())},cursor:"pointer"}}headerRegion;get scale(){return this.widget.scale}getValue(t){return this.widget.properties.getValue(`tab_${this.i}_${t}`)}get title(){return this.getValue("title")}get backgroundColor(){return this.getValue("background_color")}get foregroundColor(){return this.getValue("foreground_color")}get enabled(){return this.getValue("enabled")}get font(){return this.getValue("font").scale(this.scale)}},Td=class extends ue{tabs=[];constructor(t,e){super(t,e),this.properties.add(new b(vd)),this.properties.add(new b(Ne)),this.properties.add(new y(bd)),this.properties.add(new b(Ee)),this.properties.addGenerator(()=>{this.tabs=[];let i=this.properties.getValue(Ee),s=[];for(let r=0;r<i;r++)this.tabs.push(new bg(this,r)),s.push(new A(`tab_${r}_title`),new R(`tab_${r}_background_color`),new R(`tab_${r}_foreground_color`),new y(`tab_${r}_enabled`),new O(`tab_${r}_font`));return s})}async parseNode(t){await super.parseNode(t);for(let e of t.getNodes("widget")){let i=e.getString("widget_type"),s=this.display.createWidget(i,this);s&&(await s.parseNode(e),this.widgets.push(s))}}draw(t){this.horizontalTabs?this.drawHorizontalTabs(t):this.drawVerticalTabs(t)}measureTabOffset(t){return this.horizontalTabs?{x:0,y:this.measureLabelHeight(t)}:{x:this.measureLabelWidth(t),y:0}}measureLabelHeight(t){let{scale:e}=this,i=1*e,s=this.minimumTabHeight;for(let r=0;r<this.tabs.length;r++){let o=this.tabs[r],a=t.measureText(o.title,o.font).height+i;a>s&&(s=a)}return s+this.margin}measureLabelWidth(t){let{scale:e}=this,i=1*e,s=this.minimumTabWidth;for(let r=0;r<this.tabs.length;r++){let o=this.tabs[r],a=t.measureText(o.title,o.font).width+i;a>s&&(s=a)}return s+this.margin}drawHorizontalTabs(t){let{margin:e,gap:i,scale:s}=this,r=this.measureLabelHeight(t),o=1*s,a=this.x;for(let h=0;h<this.tabs.length;h++){let l=this.tabs[h],d=t.measureText(l.title,l.font),n,p,g,v,w;this.activeTab===h?(n=a,p=this.y,g=d.width+o+e+i,v=r,w=l.backgroundColor):(n=a+i,p=this.y+2*s,g=d.width+o+e-i,v=r-2*s,w=this.darken(l.backgroundColor)),t.fillRect({x:n,y:p,width:g,height:v,color:w}),t.addHitRegion(l.headerRegion).addRect(n,p,g,v);let T=t.createLinearGradient(n,p,n,p+v);if(T.addColorStop(0,f.WHITE.toString()),T.addColorStop(1,f.WHITE.withAlpha(0).toString()),t.fillRect({x:n,y:p,width:g,height:v,gradient:T}),t.fillText({x:n+g/2,y:p+v/2,baseline:"middle",align:"center",font:l.font,color:l.foregroundColor,text:l.title}),a+=d.width+o+e-1*s,this.activeTab===h){let B=this.x,M=this.y+r,k=this.width,W=this.height-r;t.fillRect({x:B,y:M,width:k,height:W,color:l.backgroundColor});let D=this.widgets[h],N=t.createChild(k,W);D.drawHolder(N),D.draw(N),D.drawDecoration(N),D.drawOverlay(N),t.copy(N,B,M)}else this.widgets[h].hide()}}drawVerticalTabs(t){let{margin:e,gap:i,scale:s}=this,r=this.measureLabelWidth(t),o=1*s,a=this.y;for(let h=0;h<this.tabs.length;h++){let l=this.tabs[h],d=t.measureText(l.title,l.font),n=Math.max(d.height+o+o,this.minimumTabHeight),p,g,v,w,T;this.activeTab===h?(p=this.x,g=a,v=r,w=n+e+i,T=l.backgroundColor):(p=this.x+2*s,g=a+i,v=r-2*s,w=n+e-i,T=this.darken(l.backgroundColor)),t.fillRect({x:p,y:g,width:v,height:w,color:T}),t.addHitRegion(l.headerRegion).addRect(p,g,v,w);let B=t.createLinearGradient(p,g,p+v,g);if(B.addColorStop(0,f.WHITE.toString()),B.addColorStop(1,f.WHITE.withAlpha(0).toString()),t.fillRect({x:p,y:g,width:v,height:w,gradient:B}),t.fillText({x:p+v/2,y:g+w/2,baseline:"middle",align:"center",font:l.font,color:l.foregroundColor,text:l.title}),a+=n+e-1*s,this.activeTab===h){let M=this.x+r-1*s,k=this.y,W=this.width-r,D=this.height-1*s;t.fillRect({x:M,y:k,width:W,height:D,color:l.backgroundColor});let N=this.widgets[h],j=t.createChild(W,D);N.drawHolder(j),N.draw(j),N.drawDecoration(j),N.drawOverlay(j),t.copy(j,M,k)}else this.widgets[h].destroy()}}darken(t){let e=Math.max(0,t.red-30),i=Math.max(0,t.green-30),s=Math.max(0,t.blue-30);return new f(e,i,s)}get margin(){return this.scale*10}get gap(){return this.scale*2}get minimumTabWidth(){return this.scale*20}get minimumTabHeight(){return this.scale*this.properties.getValue(vd)}get activeTab(){return this.properties.getValue(Ne)}get tabCount(){return this.properties.getValue(Ee)}get horizontalTabs(){return this.properties.getValue(bd)}},Tg=class{constructor(t){this.table=t}columnCount=0;cells=[];selectedRowIndex;dirty=!1;modifiedListeners=[];selectionChangedListeners=[];isEmpty(){return!this.cells.length}refresh(){this.dirty=!0}getCells(){return this.cells}getContent(){let t=[];for(let e of this.cells)t.push(e.map(i=>i.text||""));return t}setContent(t){this.cells.length=0;for(let e=0;e<t.length;e++)e===0&&(this.columnCount=t[e].length),this.cells.push(t[e].map(i=>({text:i})));this.dirty=!0}getColumnCount(){return this.columnCount}getRowCount(){return this.cells.length}setSelectedRowIndex(t){this.selectedRowIndex=t,this.selectionChangedListeners.forEach(e=>e()),this.dirty=!0}getSelection(){return this.selectedRowIndex===void 0?[]:[[...this.cells[this.selectedRowIndex].map(t=>t.text??null)]]}getCellText(t,e){let i=this.cells[t];return i?i[e]?.text??null:null}setColumnsCount(t){if(t<this.columnCount)for(let e of this.cells)e.length=t;if(t>this.columnCount){let e=t-this.columnCount;for(let i of this.cells)for(let s=0;s<e;s++)i.push({text:""})}this.columnCount=t,this.dirty=!0}addModifiedListener(t){this.modifiedListeners.push(t)}addSelectionChangedListener(t){this.selectionChangedListeners.push(t)}appendRow(){let t=[];for(let e=0;e<this.columnCount;e++)t[e]={text:""};return this.cells.push(t),this.dirty=!0,this.cells.length-1}deleteRow(t){this.cells.splice(t,1),this.dirty=!0}deleteColumn(t){for(let e of this.cells)e.splice(t,1);this.columnCount--,this.dirty=!0}insertRow(t){let e=[];for(let i=0;i<this.columnCount;i++)e.push({text:""});this.cells.splice(t,0,e),this.dirty=!0}insertColumn(t){for(let e of this.cells)e.splice(t,0,{text:""});this.columnCount++,this.dirty=!0}getCell(t,e){this.cells[t]=this.cells[t]??[];let i=this.cells[t][e]??{};return this.cells[t][e]=i,i}setCellText(t,e,i){let s=this.getCell(t,e);s.text=i,this.dirty=!0}setRowBackground(t,e){let i=this.cells[t];for(let s of i)s.backgroundColor=e;this.dirty=!0}setRowForeground(t,e){let i=this.cells[t];for(let s of i)s.foregroundColor=e;this.dirty=!0}setCellBackground(t,e,i){let s=this.getCell(t,e);s.backgroundColor=i,this.dirty=!0}setCellForeground(t,e,i){let s=this.getCell(t,e);s.foregroundColor=i,this.dirty=!0}setColumnCellEditorData(t,e){}},Sd="columns_count",Vd="column_headers",Cd="column_header_visible",_d="default_content",Ad="font",Sg=class extends G{tableWrapper;table;spreadsheet;constructor(t,e){super(t,e),this.properties.add(new b(Sd)),this.properties.add(new Ie(Vd)),this.properties.add(new y(Cd)),this.properties.add(new Ie(_d)),this.properties.add(new O(Ad)),this.spreadsheet=new Tg(this)}init(){this.tableWrapper=document.createElement("div"),this.tableWrapper.style.display="none",this.tableWrapper.style.overflow="auto",this.table=document.createElement("table"),this.table.style.tableLayout="fixed",this.table.style.borderSpacing="0",this.table.style.borderCollapse="collapse",this.tableWrapper.appendChild(this.table),this.display.rootPanel.appendChild(this.tableWrapper),this.table.addEventListener("click",t=>{let e=t.target;if(e.tagName==="TD"){let i=e.parentElement;i.rowIndex>0&&this.spreadsheet.setSelectedRowIndex(i.rowIndex-1)}else this.spreadsheet.setSelectedRowIndex(void 0);this.requestRepaint()}),this.spreadsheet.setContent(this.defaultContent)}draw(t){if(this.tableWrapper){let{x:e,y:i,width:s,height:r}=this.display.measureAbsoluteArea(this);this.tableWrapper.style.backgroundColor="white",this.tableWrapper.style.position="absolute",this.tableWrapper.style.display="block",this.tableWrapper.style.left=`${e}px`,this.tableWrapper.style.top=`${i}px`,this.tableWrapper.style.width=`${s}px`,this.tableWrapper.style.height=`${r}px`,this.tableWrapper.style.border="1px solid rgba(0, 0, 0, 0.1)",this.table.style.font=this.font.getFontString(),this.spreadsheet.dirty&&(this.generateTableContent(),this.spreadsheet.dirty=!1)}}generateTableContent(){let t=this.table.rows.length;for(let i=t-1;i>=0;i--)this.table.deleteRow(i);if(this.columnHeaderVisible){let i=this.table.insertRow();for(let s=0;s<this.columnsCount;s++){let r=this.columnHeaders[s],o=i.insertCell();o.style.color="#aaa",o.style.textAlign="left",o.style.width=Number(r[1])*this.scale+"px",o.style.overflow="hidden",o.style.padding=`${4*this.scale}px`,o.style.borderBottom="1px solid rgba(0, 0, 0, 0.1)",s!==0&&(o.style.borderLeft="1px solid rgba(0, 0, 0, 0.1)");let a=document.createTextNode(r[0]);o.appendChild(a)}i.insertCell()}let e=this.spreadsheet.getCells();for(let i=0;i<e.length;i++){let s=e[i],r=i===this.spreadsheet.selectedRowIndex,o=this.table.insertRow();for(let a=0;a<this.columnsCount;a++){let h=o.insertCell();if(h.style.textAlign="left",h.style.overflow="hidden",h.style.wordWrap="break-word",h.style.textOverflow="ellipsis",h.style.padding=`${4*this.scale}px`,a!==0&&(h.style.borderLeft="1px solid rgba(0, 0, 0, 0.1)"),s[a]!==void 0){let l=r?f.BLUE:s[a].backgroundColor;l&&(h.style.backgroundColor=l.toString());let d=r?f.WHITE:s[a].foregroundColor;d&&(h.style.color=d.toString());let n=document.createTextNode(s[a].text||"");h.appendChild(n)}}o.insertCell()}}hide(){this.tableWrapper&&(this.tableWrapper.style.display="none")}destroy(){this.tableWrapper&&(this.display.rootPanel.removeChild(this.tableWrapper),this.tableWrapper=void 0,this.table=void 0)}get columnsCount(){return this.properties.getValue(Sd)}get columnHeaders(){return this.properties.getValue(Vd)}get columnHeaderVisible(){return this.properties.getValue(Cd)}get defaultContent(){return this.properties.getValue(_d)}get font(){return this.properties.getValue(Ad).scale(this.scale)}},Ld="url",Vg=class extends G{iframe;prevUrl;constructor(t,e){super(t,e),this.properties.add(new A(Ld))}init(){this.iframe=document.createElement("iframe"),this.iframe.src="",this.iframe.style.display="none",this.iframe.style.border="0",this.display.rootPanel.appendChild(this.iframe)}draw(t){if(this.iframe){let{x:e,y:i,width:s,height:r}=this.display.measureAbsoluteArea(this);this.iframe.style.position="absolute",this.iframe.style.display="block",this.iframe.style.left=`${e}px`,this.iframe.style.top=`${i}px`,this.iframe.style.width=`${s}px`,this.iframe.style.height=`${r}px`,this.url&&this.prevUrl!==this.url&&(this.iframe.src=this.url,this.prevUrl=this.url)}}hide(){this.iframe&&(this.iframe.style.display="none")}destroy(){this.iframe&&(this.display.rootPanel.removeChild(this.iframe),this.iframe=void 0)}get url(){return this.properties.getValue(Ld)}},Cg="Action Button",_g="Arc",Ag="Boolean Button",Lg="Boolean Switch",Pg="Byte Monitor",kg="Check Box",Mg="Choice Button",Rg="Combo",Eg="Combo Box",Wg="Ellipse",Bg="Gauge",Ig="Grouping Container",Hg="Image",Dg="Image Boolean Button",Ng="Image Boolean Indicator",Fg="Intensity Graph",$g="Label",Og="LED",Gg="Linking Container",zg="Menu Button",Ug="Meter",qg="Button",Yg="Polygon",Xg="Polyline",jg="Progress Bar",Kg="Radio Box",Zg="Rectangle",Jg="Rounded Rectangle",Qg="Scrollbar",tm="Tabbed Container",em="Table",im="Tank",sm="Text Input",rm="Text Update",om="Thermometer",am="Web Browser",hm="XY Graph",mm=class{constructor(t){this.targetElement=t,this.rootPanel=document.createElement("div"),this.rootPanel.className="display-root",this.rootPanel.style.overflow="hidden",this.rootPanel.style.position="relative",this.rootPanel.style.fontSize="0",t.appendChild(this.rootPanel);let e=document.createElement("canvas");this.rootPanel.appendChild(e),this.g=new ap(e),this.ctx=this.g.ctx,this.formatter=new tp(!1),this.pvEngine=new Qp(this),this.pvEngine.addProvider(new rc),this.pvEngine.addProvider(new hc(this.formatter)),this.pvEngine.addProvider(new Kp),this.displayRegion={id:"display-root",click:()=>{for(let i of this.rootPanel.getElementsByTagName("input"))i.blur();for(let i of this.rootPanel.getElementsByTagName("textarea"))i.blur();for(let i of this.rootPanel.getElementsByTagName("select"))i.blur()}},this.pathResolver=new Up(this),this.consoleHandler=new Ku,this.dialogHandler=new Zu,window.setTimeout(()=>this.step()),new Qu(this,e,this.g.hitCanvas)}rootPanel;g;ctx;pvEngine;pathResolver;fontResolver;consoleHandler;dialogHandler;formatter;repaintRequested=!1;_editMode=!1;_showGrid=!1;_showOutline=!1;_showRuler=!1;_selection=[];_scale=1;_transparent=!1;_disconnectedColor=new f(160,32,240);_invalidColor=new f(255,0,255);_majorColor=new f(255,0,0);_minorColor=new f(255,128,0);refreshCycle=100;imagesPrefix="";absPrefix="";relPrefix="";instance;eventListeners={closedisplay:[],opendisplay:[],openpv:[],runcommand:[],runprocedure:[],runstack:[],selection:[],scale:[]};displayRegion;addProvider(t){this.pvEngine.addProvider(t)}addScriptLibrary(t,e){this.pvEngine.addScriptLibrary(t,e)}setPathResolver(t){this.pathResolver=t}getPathResolver(){return this.pathResolver}setConsoleHandler(t){this.consoleHandler=t}getConsoleHandler(){return this.consoleHandler}setDialogHandler(t){this.dialogHandler=t}getDialogHandler(){return this.dialogHandler}setFontResolver(t){this.fontResolver=t}getFontResolver(){return this.fontResolver}step(){this.repaintRequested&&(this.g.clearHitCanvas(),this.drawScreen(),this.repaintRequested=!1),window.setTimeout(()=>this.step(),this.refreshCycle)}drawScreen(){if(this.instance?(this.rootPanel.style.height=this.instance.holderHeight+"px",this.rootPanel.style.width=this.instance.holderWidth+"px"):(this.rootPanel.style.height="0px",this.rootPanel.style.width="0px"),this.g.resize(this.rootPanel.clientWidth,this.rootPanel.clientHeight),this.transparent&&this.g.clearCanvas(),this.editMode){let t=document.createElement("canvas"),e=t.getContext("2d");t.width=16,t.height=16,e.fillStyle="#d6d6d6",e.fillRect(0,0,8,8),e.fillRect(8,8,8,8),this.ctx.fillStyle=this.ctx.createPattern(t,"repeat"),this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.instance&&this.g.fillRect(_(C({},this.instance.bounds),{color:this.instance.backgroundColor}))}else this.transparent||this.g.fillCanvas(this.instance?.backgroundColor||f.WHITE);if(this.g.addHitRegion(this.displayRegion).addRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.showGrid&&this.instance){let t=document.createElement("canvas"),e=t.getContext("2d");t.width=25,t.height=25,e.fillStyle=this.instance.foregroundColor.toString(),e.fillRect(0,0,2,1),this.ctx.fillStyle=this.ctx.createPattern(t,"repeat"),this.ctx.fillRect(25,25,this.ctx.canvas.width-50,this.ctx.canvas.height-50)}if(this.showRuler){this.ctx.lineWidth=1,this.ctx.strokeStyle="grey",this.ctx.textBaseline="bottom",this.ctx.textAlign="center",this.ctx.fillStyle="grey",this.ctx.font="12px Arial";let t=0;for(;t<=this.ctx.canvas.width;)t+=100,this.ctx.beginPath(),this.ctx.moveTo(t-75+.5,this.ctx.canvas.height),this.ctx.lineTo(t-75+.5,this.ctx.canvas.height-4),this.ctx.moveTo(t-50+.5,this.ctx.canvas.height),this.ctx.lineTo(t-50+.5,this.ctx.canvas.height-6),this.ctx.moveTo(t-25+.5,this.ctx.canvas.height),this.ctx.lineTo(t-25+.5,this.ctx.canvas.height-4),this.ctx.moveTo(t+.5,this.ctx.canvas.height),this.ctx.lineTo(t+.5,this.ctx.canvas.height-8),this.ctx.stroke(),this.ctx.fillText(String(t),t,this.ctx.canvas.height-8);this.ctx.textAlign="right",this.ctx.textBaseline="middle";let e=0;for(;e<=this.ctx.canvas.height;)e+=100,this.ctx.beginPath(),this.ctx.moveTo(this.ctx.canvas.width,e-75+.5),this.ctx.lineTo(this.ctx.canvas.width-4,e-75+.5),this.ctx.moveTo(this.ctx.canvas.width,e-50+.5),this.ctx.lineTo(this.ctx.canvas.width-6,e-50+.5),this.ctx.moveTo(this.ctx.canvas.width,e-25+.5),this.ctx.lineTo(this.ctx.canvas.width-4,e-25+.5),this.ctx.moveTo(this.ctx.canvas.width,e+.5),this.ctx.lineTo(this.ctx.canvas.width-8,e+.5),this.ctx.stroke(),this.ctx.fillText(String(e),this.ctx.canvas.width-8,e)}this.showOutline&&this.instance&&(this.ctx.lineWidth=1,this.ctx.setLineDash([10,5]),this.ctx.strokeStyle="black",this.ctx.strokeRect(-.5,-.5,this.instance.holderWidth+1,this.instance.holderHeight+1),this.ctx.setLineDash([])),this.instance&&this.instance.draw(this.g);for(let t of this.selection){let e=this.findWidget(t);e&&e.drawSelection(this.ctx)}}requestRepaint(){this.repaintRequested=!0}setTooltip(t){this.rootPanel.title=t?.trim()??""}createWidget(t,e){switch(t){case Cg:return new Yd(this,e);case _g:return new Rc(this,e);case Ag:return new nc(this,e);case Lg:return new dc(this,e);case Pg:return new Fc(this,e);case kg:return new mc(this,e);case Mg:return new fc(this,e);case Rg:case Eg:return new yc(this,e);case Wg:return new Ec(this,e);case Bg:return new Xc(this,e);case Ig:return new vg(this,e);case Hg:return new Wc(this,e);case Dg:return new vc(this,e);case Ng:return new jc(this,e);case Fg:return new Zc(this,e);case $g:return new Bc(this,e);case Og:return new Jc(this,e);case Gg:return new zd(this,e);case zg:return new bc(this,e);case Ug:return new sg(this,e);case qg:return new Tc(this,e);case Yg:return new Ic(this,e);case Xg:return new Hc(this,e);case jg:return new rg(this,e);case Kg:return new Lc(this,e);case Zg:return new Dc(this,e);case Jg:return new Nc(this,e);case Qg:return new Pc(this,e);case tm:return new Td(this,e);case em:return new Sg(this,e);case im:return new ag(this,e);case sm:return new Mc(this,e);case rm:return new hg(this,e);case om:return new lg(this,e);case am:return new Vg(this,e);case hm:return new yg(this,e);default:console.warn(`Unsupported widget type: ${t}`)}}destroy(){this.instance?.destroy(),this.instance=void 0,this.pvEngine.clearState(),this.requestRepaint()}resolvePath(t,e){return this.pathResolver.resolve(t,e)}setSource(t,e){this.reset();let i=t.lastIndexOf("/")+1;return this.relPrefix=t.substring(0,i),new Promise((s,r)=>{fetch(t,{credentials:"same-origin"}).then(o=>{o.ok&&o.text().then(a=>{this.setSourceString(a,e),s()}).catch(a=>r(a))}).catch(o=>r(o))})}setSourceString(t,e){this.reset(),this.instance=new Gd(this,void 0,e);let i=Od.parseFromXML(t);this.instance.parseNode(i).then(()=>{this.pvEngine.init(),this.requestRepaint()})}getRefreshCycle(){return this.refreshCycle}setRefreshCycle(t){this.refreshCycle=t}reset(){this.instance&&(this.clearSelection(),this.pvEngine.clearState(),this.instance.destroy(),this.instance=void 0)}measureAbsoluteArea(t){let e=t.bounds,i=t.parent;for(;i;){if(e.x+=i.x,e.y+=i.y,i instanceof Td){let{x:s,y:r}=i.measureTabOffset(this.g);e.x+=s,e.y+=r}i=i.parent}return e.x+=t.x-t.holderX,e.y+=t.y-t.holderY,e.width+=t.width-t.holderWidth,e.height+=t.height-t.holderHeight,e.x+=this.scale*1,e.y+=this.scale*1,e}addEventListener(t,e){if(!(t in this.eventListeners))throw new Error(`Unknown event '${t}'`);this.eventListeners[t].push(e)}removeEventListener(t,e){if(!(t in this.eventListeners))throw new Error(`Unknown event '${t}'`);this.eventListeners[t]=this.eventListeners[t].filter(i=>i!==e)}fireEvent(t,e){this.eventListeners[t].forEach(i=>i(e))}get showGrid(){return this._showGrid}set showGrid(t){this._showGrid=t,this.requestRepaint()}get showOutline(){return this._showOutline}set showOutline(t){this._showOutline=t,this.requestRepaint()}get showRuler(){return this._showRuler}set showRuler(t){this._showRuler=t,this.requestRepaint()}get selection(){return this._selection}set selection(t){this._selection=t,this.requestRepaint();let e={selected:this._selection.slice()};this.fireEvent("selection",e)}get editMode(){return this._editMode}set editMode(t){this._editMode=t,this.requestRepaint()}get scale(){return this._scale}set scale(t){this._scale=t,this.requestRepaint();let e={scale:t};this.fireEvent("scale",e)}get transparent(){return this._transparent}set transparent(t){this._transparent=t,this.requestRepaint()}get utc(){return this.formatter.utc}set utc(t){this.formatter.utc=t,this.requestRepaint()}get disconnectedColor(){return this._disconnectedColor}set disconnectedColor(t){this._disconnectedColor=t,this.requestRepaint()}get invalidColor(){return this._invalidColor}set invalidColor(t){this._invalidColor=t,this.requestRepaint()}get majorColor(){return this._majorColor}set majorColor(t){this._majorColor=t,this.requestRepaint()}get minorColor(){return this._minorColor}set minorColor(t){this._minorColor=t,this.requestRepaint()}get widgets(){return this.instance?this.instance.widgets:[]}clearSelection(){this.selection.length&&(this.selection=[])}findWidget(t){if(this.instance)return this.instance.findWidget(t)}findWidgetByName(t){if(this.instance)return this.instance.findWidgetByName(t)}getPVNames(){return this.pvEngine.getPVNames()}getPV(t){return this.pvEngine.getPV(t)}setValues(t){this.pvEngine.setExternalValues(t)}copyCanvas(t){t||(t={x:0,y:0,width:this.g.canvas.width,height:this.g.canvas.height});let e=document.createElement("canvas");return e.width=t.width,e.height=t.height,e.getContext("2d").drawImage(this.g.canvas,t.x,t.y,t.width,t.height,0,0,t.width,t.height),e}toDataURL(t="image/png",e){return this.g.ctx.canvas.toDataURL(t,e)}};export{gm as a,Tp as b,Up as c,jp as d,mm as e};
